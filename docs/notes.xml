<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Homophony</title>
<link>https://homophony.quest/notes.html</link>
<atom:link href="https://homophony.quest/notes.xml" rel="self" type="application/rss+xml"/>
<description>Music blog for motivation to play more music</description>
<image>
<url>https://homophony.quest/images/notesE_0.jpg</url>
<title>Homophony</title>
<link>https://homophony.quest/notes.html</link>
</image>
<generator>quarto-1.4.549</generator>
<lastBuildDate>Sat, 17 Feb 2024 05:00:00 GMT</lastBuildDate>
<item>
  <title>Composition tests</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/50_2_16_24_comps/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Chunky square wave. house beats. convolution reverb. A little dark analog delay. lots of stereo. busy. synthesizers. megazord. linocut"</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/50_2_16_24_comps/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>Chunky square wave. house beats. convolution reverb. A little dark analog delay. lots of stereo. busy. synthesizers. megazord. linocut -Dreamshaper</p>
<p>This image was produced by dreamshaper-xl-turbo using the above prompt, and should be reproducible with the source code.</p>
</div></div><section id="comp-1" class="level2">
<h2 class="anchored" data-anchor-id="comp-1">Comp 1</h2>
<p>Some tests.</p>
<p>-add drums and synth voices</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pyramidi)</span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(fluidsynth)</span>
<span id="cb2-5"></span>
<span id="cb2-6">all_tracks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>()</span>
<span id="cb2-7"></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># note parameters</span></span>
<span id="cb2-9">  bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span> </span>
<span id="cb2-10">  repeat_bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb2-11">  possible_time_steps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb2-12">  note_interval <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span></span>
<span id="cb2-13">  note_duration <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span></span>
<span id="cb2-14">  </span>
<span id="cb2-15">  track_params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_1_kick =</span></span>
<span id="cb2-16">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)), </span>
<span id="cb2-17">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key_vector =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>), </span>
<span id="cb2-18">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> possible_time_steps), </span>
<span id="cb2-19">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> repeat_bars),</span>
<span id="cb2-20">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_beats =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)),</span>
<span id="cb2-21">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb2-22">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb2-23">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_interval =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>,</span>
<span id="cb2-24">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_duration =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span></span>
<span id="cb2-25">                           ),</span>
<span id="cb2-26">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_2_snare =</span></span>
<span id="cb2-27">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),  </span>
<span id="cb2-28">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key_vector =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>), </span>
<span id="cb2-29">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> possible_time_steps), </span>
<span id="cb2-30">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> repeat_bars),</span>
<span id="cb2-31">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_beats =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),</span>
<span id="cb2-32">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb2-33">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb2-34">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_interval =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>,</span>
<span id="cb2-35">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_duration =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span></span>
<span id="cb2-36">                          ),</span>
<span id="cb2-37">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_3_cymb =</span></span>
<span id="cb2-38">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),  </span>
<span id="cb2-39">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key_vector =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>), </span>
<span id="cb2-40">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> possible_time_steps), </span>
<span id="cb2-41">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> repeat_bars),</span>
<span id="cb2-42">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_beats =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),</span>
<span id="cb2-43">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb2-44">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb2-45">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_interval =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>,</span>
<span id="cb2-46">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_duration =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span></span>
<span id="cb2-47">                          ),</span>
<span id="cb2-48">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_4_synth =</span></span>
<span id="cb2-49">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">72</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>),   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#1     2     3  4     5     6     7  8 </span></span>
<span id="cb2-50">                                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)), </span>
<span id="cb2-51">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key_vector =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), </span>
<span id="cb2-52">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> possible_time_steps), </span>
<span id="cb2-53">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> repeat_bars),</span>
<span id="cb2-54">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_beats =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),</span>
<span id="cb2-55">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb2-56">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb2-57">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_interval =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>,</span>
<span id="cb2-58">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_duration =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>), possible_time_steps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>repeat_bars, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> T)</span>
<span id="cb2-59">                          ),</span>
<span id="cb2-60">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_5_synth =</span></span>
<span id="cb2-61">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">72</span>)),   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#1     2     3  4     5     6     7  8 </span></span>
<span id="cb2-62">                                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)), </span>
<span id="cb2-63">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key_vector =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), </span>
<span id="cb2-64">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> possible_time_steps), </span>
<span id="cb2-65">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> repeat_bars),</span>
<span id="cb2-66">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_beats =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),</span>
<span id="cb2-67">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb2-68">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb2-69">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_interval =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>,</span>
<span id="cb2-70">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_duration =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>), possible_time_steps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>repeat_bars, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> T)</span>
<span id="cb2-71">                          )</span>
<span id="cb2-72">  )</span>
<span id="cb2-73">                       </span>
<span id="cb2-74">                           </span>
<span id="cb2-75"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loop for each track</span></span>
<span id="cb2-76"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(t <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) {</span>
<span id="cb2-77">  </span>
<span id="cb2-78">  compose_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb2-79">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb2-80">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb2-81">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beat_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb2-82">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb2-83">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>()</span>
<span id="cb2-84">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-85">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use euclidean rhythm</span></span>
<span id="cb2-86">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-87">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb2-88">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beat_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replicate</span>(</span>
<span id="cb2-89">        bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>repeat_bars,</span>
<span id="cb2-90">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>possible_beats, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), </span>
<span id="cb2-91">                            possible_time_steps,</span>
<span id="cb2-92">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-93">      )),</span>
<span id="cb2-94">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>possible_notes,</span>
<span id="cb2-95">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> possible_time_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>repeat_bars),</span>
<span id="cb2-96">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>key_vector</span>
<span id="cb2-97">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-98">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-99">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># handle note times</span></span>
<span id="cb2-100">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb2-101">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb2-102">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_on =</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_interval,</span>
<span id="cb2-103">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off =</span> note_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_duration</span>
<span id="cb2-104">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-105">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(beat_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-106">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#pivot to long</span></span>
<span id="cb2-107">    tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_off"</span>),</span>
<span id="cb2-108">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>,</span>
<span id="cb2-109">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-110">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(time) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-111">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(time, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">default =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb2-112">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>channel)</span>
<span id="cb2-113">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">######################</span></span>
<span id="cb2-114">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># End composition </span></span>
<span id="cb2-115">  </span>
<span id="cb2-116">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#######################</span></span>
<span id="cb2-117">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## add composition to a new midi df</span></span>
<span id="cb2-118">  new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create_empty_midi_df</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize</span></span>
<span id="cb2-119">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_track_name</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"My track"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-120">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_tempo</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-121">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_time_sig</span>(</span>
<span id="cb2-122">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">numerator =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb2-123">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">denominator =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb2-124">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clocks_per_click =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>,</span>
<span id="cb2-125">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notated_32nd_notes_per_beat =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb2-126">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-127">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_program_change</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>program,</span>
<span id="cb2-128">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>channel) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-129">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_control_change</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-130">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Composition added here</span></span>
<span id="cb2-131">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb2-132">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(compose_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb2-133">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(compose_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb2-134">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note,</span>
<span id="cb2-135">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type,</span>
<span id="cb2-136">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time,</span>
<span id="cb2-137">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>channel,</span>
<span id="cb2-138">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>L<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">112</span>L,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(compose_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace=</span>T)</span>
<span id="cb2-139">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#velocity = 64</span></span>
<span id="cb2-140">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-141">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_end_of_track</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-142">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> t) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-143">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> velocity,</span>
<span id="cb2-144">                                type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_off"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))<span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set current track number</span></span>
<span id="cb2-145">  </span>
<span id="cb2-146">  all_tracks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(all_tracks,new_midi_df)</span>
<span id="cb2-147">  </span>
<span id="cb2-148">}</span>
<span id="cb2-149"></span>
<span id="cb2-150"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi</span></span>
<span id="cb2-151"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Initialize new pyramidi object</span></span>
<span id="cb2-152">new_pyramidi_object <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>MidiFramer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>()</span>
<span id="cb2-153"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update ticks per beat</span></span>
<span id="cb2-154">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span>L</span>
<span id="cb2-155"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update object with new midi df</span></span>
<span id="cb2-156">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(all_tracks)</span>
<span id="cb2-157"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write to midi file</span></span>
<span id="cb2-158">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE-EP-133-C.mid"</span>)</span>
<span id="cb2-159"></span>
<span id="cb2-160"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># play</span></span>
<span id="cb2-161">fluidsynth<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_play</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE-EP-133-C.mid"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soundfont =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/Library/Audio/Sounds/Banks/TE-EP-133-A.sf2"</span>)</span>
<span id="cb2-162"></span>
<span id="cb2-163"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#bounce</span></span>
<span id="cb2-164">fluidsynth<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_convert</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE-EP-133-C.mid"</span>,</span>
<span id="cb2-165">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soundfont =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/Library/Audio/Sounds/Banks/TE-EP-133-A.sf2"</span>,</span>
<span id="cb2-166">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">output =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE-EP-133-D.mp3"</span>)</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="TE-EP-133-D.mp3" type="audio/wav"> </audio></p>
</section>
<section id="comp-2" class="level2">
<h2 class="anchored" data-anchor-id="comp-2">Comp 2</h2>
<ul>
<li>get super basic, increase repetition, 4 on floor</li>
<li>increase gain</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb3-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pyramidi)</span>
<span id="cb3-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(fluidsynth)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">all_tracks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>()</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># note parameters</span></span>
<span id="cb4-4">  bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span> </span>
<span id="cb4-5">  repeat_bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb4-6">  possible_time_steps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb4-7">  note_interval <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span></span>
<span id="cb4-8">  note_duration <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span></span>
<span id="cb4-9">  </span>
<span id="cb4-10">  track_params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_1_kick =</span></span>
<span id="cb4-11">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)), </span>
<span id="cb4-12">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key_vector =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>), </span>
<span id="cb4-13">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> possible_time_steps), </span>
<span id="cb4-14">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> repeat_bars),</span>
<span id="cb4-15">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_beats =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),</span>
<span id="cb4-16">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-17">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb4-18">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_interval =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>,</span>
<span id="cb4-19">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_duration =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>,</span>
<span id="cb4-20">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> (possible_time_steps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>repeat_bars), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> T)</span>
<span id="cb4-21">                           ),</span>
<span id="cb4-22">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_2_snare =</span></span>
<span id="cb4-23">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),  </span>
<span id="cb4-24">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key_vector =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>), </span>
<span id="cb4-25">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> possible_time_steps), </span>
<span id="cb4-26">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> repeat_bars),</span>
<span id="cb4-27">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_beats =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),</span>
<span id="cb4-28">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb4-29">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb4-30">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_interval =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>,</span>
<span id="cb4-31">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_duration =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>,</span>
<span id="cb4-32">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> (possible_time_steps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>repeat_bars), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> T)</span>
<span id="cb4-33">                          ),</span>
<span id="cb4-34">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_3_cymb =</span></span>
<span id="cb4-35">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">35</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),  </span>
<span id="cb4-36">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key_vector =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>), </span>
<span id="cb4-37">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> possible_time_steps), </span>
<span id="cb4-38">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> repeat_bars),</span>
<span id="cb4-39">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_beats =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),</span>
<span id="cb4-40">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb4-41">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb4-42">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_interval =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>,</span>
<span id="cb4-43">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_duration =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>,</span>
<span id="cb4-44">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> (possible_time_steps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>repeat_bars), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> T)</span>
<span id="cb4-45">                          ),</span>
<span id="cb4-46">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_4_synth =</span></span>
<span id="cb4-47">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">72</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>),   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#1     2     3  4     5     6     7  8 </span></span>
<span id="cb4-48">                                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)), </span>
<span id="cb4-49">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key_vector =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), </span>
<span id="cb4-50">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> possible_time_steps), </span>
<span id="cb4-51">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> repeat_bars),</span>
<span id="cb4-52">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_beats =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),</span>
<span id="cb4-53">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb4-54">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb4-55">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_interval =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>,</span>
<span id="cb4-56">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_duration =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>), possible_time_steps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>repeat_bars, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> T),</span>
<span id="cb4-57">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> (possible_time_steps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>repeat_bars))</span>
<span id="cb4-58">                          ),</span>
<span id="cb4-59">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_5_synth =</span></span>
<span id="cb4-60">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">72</span>)),   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#1     2     3  4     5     6     7  8 </span></span>
<span id="cb4-61">                                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)), </span>
<span id="cb4-62">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key_vector =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), </span>
<span id="cb4-63">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> possible_time_steps), </span>
<span id="cb4-64">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> repeat_bars),</span>
<span id="cb4-65">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_beats =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),</span>
<span id="cb4-66">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb4-67">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb4-68">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_interval =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>,</span>
<span id="cb4-69">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_duration =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>), possible_time_steps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>repeat_bars, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> T),</span>
<span id="cb4-70">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> (possible_time_steps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>repeat_bars))</span>
<span id="cb4-71">                          )</span>
<span id="cb4-72">  )</span>
<span id="cb4-73">                       </span>
<span id="cb4-74">                           </span>
<span id="cb4-75"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loop for each track</span></span>
<span id="cb4-76"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(t <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) {</span>
<span id="cb4-77">  </span>
<span id="cb4-78">  compose_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb4-79">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb4-80">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb4-81">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beat_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb4-82">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb4-83">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb4-84">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>()</span>
<span id="cb4-85">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-86">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use euclidean rhythm</span></span>
<span id="cb4-87">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-88">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb4-89">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beat_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replicate</span>(</span>
<span id="cb4-90">        bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>repeat_bars,</span>
<span id="cb4-91">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>possible_beats, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), </span>
<span id="cb4-92">                            possible_time_steps,</span>
<span id="cb4-93">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-94">      )),</span>
<span id="cb4-95">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>possible_notes,</span>
<span id="cb4-96">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> possible_time_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>repeat_bars),</span>
<span id="cb4-97">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>key_vector,</span>
<span id="cb4-98">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>velocity </span>
<span id="cb4-99">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-100">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-101">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># handle note times</span></span>
<span id="cb4-102">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb4-103">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb4-104">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_on =</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_interval,</span>
<span id="cb4-105">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off =</span> note_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_duration</span>
<span id="cb4-106">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-107">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(beat_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-108">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#pivot to long</span></span>
<span id="cb4-109">    tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_off"</span>),</span>
<span id="cb4-110">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>,</span>
<span id="cb4-111">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-112">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(time) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-113">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(time, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">default =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb4-114">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>channel)</span>
<span id="cb4-115">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">######################</span></span>
<span id="cb4-116">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># End composition </span></span>
<span id="cb4-117">  </span>
<span id="cb4-118">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#######################</span></span>
<span id="cb4-119">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## add composition to a new midi df</span></span>
<span id="cb4-120">  new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create_empty_midi_df</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize</span></span>
<span id="cb4-121">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_track_name</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"My track"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-122">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_tempo</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600000</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-123">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_time_sig</span>(</span>
<span id="cb4-124">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">numerator =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb4-125">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">denominator =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb4-126">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clocks_per_click =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>,</span>
<span id="cb4-127">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notated_32nd_notes_per_beat =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb4-128">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-129">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_program_change</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>program,</span>
<span id="cb4-130">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>channel) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-131">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_control_change</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-132">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Composition added here</span></span>
<span id="cb4-133">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb4-134">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(compose_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb4-135">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(compose_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb4-136">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note,</span>
<span id="cb4-137">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type,</span>
<span id="cb4-138">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time,</span>
<span id="cb4-139">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>channel,</span>
<span id="cb4-140">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>velocity</span>
<span id="cb4-141">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#velocity = 64</span></span>
<span id="cb4-142">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-143">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_end_of_track</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-144">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> velocity,</span>
<span id="cb4-145">                                type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_off"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb4-146">  </span>
<span id="cb4-147">  all_tracks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(all_tracks,new_midi_df)</span>
<span id="cb4-148">  </span>
<span id="cb4-149">}</span>
<span id="cb4-150"></span>
<span id="cb4-151"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi</span></span>
<span id="cb4-152"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Initialize new pyramidi object</span></span>
<span id="cb4-153">new_pyramidi_object <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>MidiFramer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>()</span>
<span id="cb4-154"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update ticks per beat</span></span>
<span id="cb4-155">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span>L</span>
<span id="cb4-156"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update object with new midi df</span></span>
<span id="cb4-157">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(all_tracks)</span>
<span id="cb4-158"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write to midi file</span></span>
<span id="cb4-159">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE-EP-133-E.mid"</span>)</span>
<span id="cb4-160"></span>
<span id="cb4-161"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># play</span></span>
<span id="cb4-162">fluidsynth<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_play</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE-EP-133-E.mid"</span>,</span>
<span id="cb4-163">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soundfont =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/Library/Audio/Sounds/Banks/TE-EP-133-A.sf2"</span>,</span>
<span id="cb4-164">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">settings =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'synth.gain'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span></code></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#bounce</span></span>
<span id="cb5-2">fluidsynth<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_convert</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE-EP-133-E.mid"</span>,</span>
<span id="cb5-3">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soundfont =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/Library/Audio/Sounds/Banks/TE-EP-133-A.sf2"</span>,</span>
<span id="cb5-4">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">output =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE-EP-133-E_synth_Eb.mp3"</span>,</span>
<span id="cb5-5">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">settings =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'synth.gain'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span></code></pre></div>
</details>
</div>
<p>This ended up being fun. I bounced a couple 24 bar drum tracks to ableton generated from this script. And, a simple synth track. Then used that source material to get this going.</p>
<p><audio controls=""> <source src="EP-133_E_cong.mp3" type="audio/wav"> </audio></p>


</section>

 ]]></description>
  <category>midiblender</category>
  <category>soundfont</category>
  <category>fluidsynth</category>
  <guid>https://homophony.quest/blog/50_2_16_24_comps/</guid>
  <pubDate>Sat, 17 Feb 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/50_2_16_24_comps/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Soundfonts and {rsoundfont}!</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/49_2_15_24_r_soundfonts/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a synthesizer made out of water. 3d. white background. super cool."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/49_2_15_24_r_soundfonts/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>Sound Blaster AWE 64</p>
</div></div><p>Soundfontswow. In some sense this format is totally new to me. I had to download some to get fluidsynth to play sounds, and thats about all I knew about them.</p>
<p>After perusing <a href="https://en.wikipedia.org/wiki/SoundFont">soundfonts on wikipedia</a> I learned that the awesome sounds of my childhood, from the Sound Blaster AWE32 soundcard that blew my freaking mind as a kid, was soundfonts.</p>
<p>Last night I downloaded a whole bunch of soundfont collections, because why not. And, then I realized that I didnt know anything about the <code>.sf2</code> format, soundfont file structure, how to quickly audition different soundfonts, etc.</p>
<p>So, I am on a soundfont journey.</p>
<p>I was very excited to learn that <a href="https://coolbutuseless.github.io">coolbutuseless</a> made a package to inspect <code>.sf2</code> files, called <a href="https://github.com/coolbutuseless/rsoundfont">rsoundfont</a>. Im testing it out a bit here.</p>
<section id="soundfont-specs" class="level2">
<h2 class="anchored" data-anchor-id="soundfont-specs">soundfont specs</h2>
<p><a href="https://www.synthfont.com/sfspec24.pdf" class="uri">https://www.synthfont.com/sfspec24.pdf</a></p>
</section>
<section id="rsoundfont-tests" class="level2">
<h2 class="anchored" data-anchor-id="rsoundfont-tests">rsoundfont tests</h2>
<p>{rsoundfont} works great. The <code>.sf2</code> file loads as a list. All of the .wav info is in R, and the <code>create_sample()</code> function makes it possible to quickly listen to a soundfont in R.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rsoundfont)</span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># storing all my .sf2 files here</span></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get a list of them</span></span>
<span id="cb2-5">sound_font_list <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list.files</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/Library/Audio/Sounds/Banks"</span>)</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pick one to load</span></span>
<span id="cb2-8">sf2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_sf2</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/Library/Audio/Sounds/Banks/"</span>,sound_font_list[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">37</span>]))</span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># look at stuff</span></span>
<span id="cb2-11"></span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#View(sf2$pdta$phdr)</span></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#sf2$pdta$shdr$name</span></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#sf2$pdta$shdr</span></span>
<span id="cb2-15"></span>
<span id="cb2-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># quickly loop through different soundfonts and play them</span></span>
<span id="cb2-17"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sf2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pdta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>shdr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>name)){</span>
<span id="cb2-18">  samp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create_sample</span>(sf2, sf2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pdta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>shdr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>name[i], <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>)</span>
<span id="cb2-19">  audio<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">play</span>(samp)</span>
<span id="cb2-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.sleep</span>(.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb2-21">}</span></code></pre></div>
</details>
</div>
</section>
<section id="polyphone" class="level2">
<h2 class="anchored" data-anchor-id="polyphone">polyphone</h2>
<p>Next I discovered <a href="https://github.com/davy7125/polyphone">polyphone</a>, which is an excellent open-source soundfont editor.</p>
<p>Polyphone makes it incredibly easy to organize samples and turn them into .sf2 files.</p>
</section>
<section id="te-ep-133-k.o.-ii" class="level2">
<h2 class="anchored" data-anchor-id="te-ep-133-k.o.-ii">TE EP-133 K.O. II</h2>
<p>I recently picked up a TE EP-133 K.O. II and I love the sample on there. Using polyphone it didnt take that much work to get the samples into <code>.sf2</code>. Which means I should be able to make some fun beat. There are a bunch of different options for organizing samples as instruments and patches, and Im looking forward to exploring this a little bit more.</p>
</section>
<section id="killr-beatz" class="level2">
<h2 class="anchored" data-anchor-id="killr-beatz">KillR BEATZ</h2>
<p>If it is true that I possess some super inspiring samples for drums, then I should be able to make some fun beats. Lets see:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb3-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pyramidi)</span>
<span id="cb3-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(fluidsynth)</span>
<span id="cb3-5"></span>
<span id="cb3-6">all_tracks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>()</span>
<span id="cb3-7"></span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># note parameters</span></span>
<span id="cb3-9">  bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span> </span>
<span id="cb3-10">  repeat_bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb3-11">  possible_time_steps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb3-12">  note_interval <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span></span>
<span id="cb3-13">  note_duration <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span></span>
<span id="cb3-14">  </span>
<span id="cb3-15">  track_params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_1_kick =</span></span>
<span id="cb3-16">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)), </span>
<span id="cb3-17">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key_vector =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>), </span>
<span id="cb3-18">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> possible_time_steps), </span>
<span id="cb3-19">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> repeat_bars),</span>
<span id="cb3-20">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_beats =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),</span>
<span id="cb3-21">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-22">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-23">                           ),</span>
<span id="cb3-24">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_2_snare =</span></span>
<span id="cb3-25">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),  </span>
<span id="cb3-26">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key_vector =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>), </span>
<span id="cb3-27">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> possible_time_steps), </span>
<span id="cb3-28">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> repeat_bars),</span>
<span id="cb3-29">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_beats =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),</span>
<span id="cb3-30">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb3-31">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb3-32">                          ),</span>
<span id="cb3-33">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_3_cymb =</span></span>
<span id="cb3-34">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),  </span>
<span id="cb3-35">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key_vector =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>), </span>
<span id="cb3-36">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> possible_time_steps), </span>
<span id="cb3-37">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> repeat_bars),</span>
<span id="cb3-38">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_beats =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),</span>
<span id="cb3-39">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb3-40">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb3-41">                          )</span>
<span id="cb3-42">  )</span>
<span id="cb3-43">                       </span>
<span id="cb3-44">                           </span>
<span id="cb3-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loop for each track</span></span>
<span id="cb3-46"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(t <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) {</span>
<span id="cb3-47">  </span>
<span id="cb3-48">  compose_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb3-49">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb3-50">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb3-51">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beat_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb3-52">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb3-53">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>()</span>
<span id="cb3-54">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-55">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use euclidean rhythm</span></span>
<span id="cb3-56">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-57">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb3-58">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beat_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replicate</span>(</span>
<span id="cb3-59">        bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>repeat_bars,</span>
<span id="cb3-60">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>possible_beats, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), </span>
<span id="cb3-61">                            possible_time_steps,</span>
<span id="cb3-62">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-63">      )),</span>
<span id="cb3-64">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>possible_notes,</span>
<span id="cb3-65">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> possible_time_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>repeat_bars),</span>
<span id="cb3-66">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>key_vector</span>
<span id="cb3-67">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-68">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-69">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># handle note times</span></span>
<span id="cb3-70">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb3-71">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb3-72">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_on =</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> note_interval,</span>
<span id="cb3-73">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off =</span> note_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> note_duration</span>
<span id="cb3-74">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-75">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(beat_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-76">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#pivot to long</span></span>
<span id="cb3-77">    tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_off"</span>),</span>
<span id="cb3-78">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>,</span>
<span id="cb3-79">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-80">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(time) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-81">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(time, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">default =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb3-82">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>channel)</span>
<span id="cb3-83">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">######################</span></span>
<span id="cb3-84">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># End composition </span></span>
<span id="cb3-85">  </span>
<span id="cb3-86">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#######################</span></span>
<span id="cb3-87">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## add composition to a new midi df</span></span>
<span id="cb3-88">  new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create_empty_midi_df</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize</span></span>
<span id="cb3-89">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_track_name</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"My track"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-90">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_tempo</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-91">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_time_sig</span>(</span>
<span id="cb3-92">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">numerator =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb3-93">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">denominator =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb3-94">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clocks_per_click =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>,</span>
<span id="cb3-95">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notated_32nd_notes_per_beat =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb3-96">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-97">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_program_change</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>program,</span>
<span id="cb3-98">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>channel) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-99">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_control_change</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-100">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Composition added here</span></span>
<span id="cb3-101">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb3-102">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(compose_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb3-103">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(compose_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb3-104">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note,</span>
<span id="cb3-105">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type,</span>
<span id="cb3-106">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time,</span>
<span id="cb3-107">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>channel,</span>
<span id="cb3-108">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>L<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">112</span>L,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(compose_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace=</span>T)</span>
<span id="cb3-109">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#velocity = 64</span></span>
<span id="cb3-110">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-111">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_end_of_track</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-112">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> t) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-113">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> velocity,</span>
<span id="cb3-114">                                type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_off"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))<span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set current track number</span></span>
<span id="cb3-115">  </span>
<span id="cb3-116">  all_tracks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(all_tracks,new_midi_df)</span>
<span id="cb3-117">  </span>
<span id="cb3-118">}</span>
<span id="cb3-119"></span>
<span id="cb3-120"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi</span></span>
<span id="cb3-121"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Initialize new pyramidi object</span></span>
<span id="cb3-122">new_pyramidi_object <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>MidiFramer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>()</span>
<span id="cb3-123"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update ticks per beat</span></span>
<span id="cb3-124">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span>L</span>
<span id="cb3-125"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update object with new midi df</span></span>
<span id="cb3-126">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(all_tracks)</span>
<span id="cb3-127"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write to midi file</span></span>
<span id="cb3-128">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE-EP-133-B.mid"</span>)</span>
<span id="cb3-129"></span>
<span id="cb3-130"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># play</span></span>
<span id="cb3-131">fluidsynth<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_play</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE-EP-133-B.mid"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soundfont =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/Library/Audio/Sounds/Banks/TE-EP-133-A.sf2"</span>)</span>
<span id="cb3-132"></span>
<span id="cb3-133"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#bounce</span></span>
<span id="cb3-134">fluidsynth<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_convert</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE-EP-133-B.mid"</span>,</span>
<span id="cb3-135">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soundfont =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/Library/Audio/Sounds/Banks/TE-EP-133-A.sf2"</span>,</span>
<span id="cb3-136">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">output =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TE-EP-133-B.mp3"</span>)</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="TE-EP-133-B_01.mp3" type="audio/wav"> </audio></p>
<p>Look out aphex twin.</p>
<hr>
<p>Heres a blend of those beats with mario for some more midi mangling fun.</p>
<p><audio controls=""> <source src="mario_TE.mp3" type="audio/wav"> </audio></p>


</section>

 ]]></description>
  <category>midiblender</category>
  <category>soundfont</category>
  <category>fluidsynth</category>
  <guid>https://homophony.quest/blog/49_2_15_24_r_soundfonts/</guid>
  <pubDate>Fri, 16 Feb 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/49_2_15_24_r_soundfonts/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Testing out {fluidsynth} for R!</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/48_2_15_24_r_fluid_synth/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a synthesizer made out of water. 3d. white background. super cool."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/48_2_15_24_r_fluid_synth/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>a synthesizer made out of water. 3d. white background. super cool. - Dreamshaper</p>
</div></div><p>Thanks to <a href="https://github.com/jeroen">Jeroen Ooms</a> and <a href="https://ropensci.org">rOpenSci</a>, there is a new {fluidsynth} package with bindings for R!</p>
<p>Heres the github repo: <a href="https://github.com/ropensci/fluidsynth/" class="uri">https://github.com/ropensci/fluidsynth/</a></p>
<p>The package is only four days old and could change, but it is working for me!</p>
<section id="playback-midi-locally" class="level2">
<h2 class="anchored" data-anchor-id="playback-midi-locally">playback midi locally</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(fluidsynth)</span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this works for local playback!</span></span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_play</span>(</span>
<span id="cb2-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"the-moon.mid"</span>,</span>
<span id="cb2-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soundfont =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2"</span>,</span>
<span id="cb2-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">audio.driver =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb2-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">settings =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(),</span>
<span id="cb2-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">progress =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">interactive</span>()</span>
<span id="cb2-11">)</span></code></pre></div>
</details>
</div>
</section>
<section id="write-midi-to-wav" class="level2">
<h2 class="anchored" data-anchor-id="write-midi-to-wav">write midi to wav</h2>
<p>Im on a mac m2. The midi_convert function produces a wav file that will not play. However, the {av} package does successfully convert the wav file to a listenable mp3. Glad it works out in the end.</p>
<p>Im not sure why the wav file isnt rendering as playable. I wonder if it isnt finding my installation of libsndfile, and the wav file is being rendered as raw?</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_convert</span>(</span>
<span id="cb3-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"the-moon.mid"</span>,</span>
<span id="cb3-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soundfont =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2"</span>,</span>
<span id="cb3-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">output =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output.wav"</span>,</span>
<span id="cb3-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">settings =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb3-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">audio.driver =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"coreaudio"</span>,</span>
<span id="cb3-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">audio.file.format =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"double"</span>,</span>
<span id="cb3-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">audio.file.type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wav"</span>),</span>
<span id="cb3-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">progress =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">interactive</span>()</span>
<span id="cb3-10">)</span>
<span id="cb3-11"></span>
<span id="cb3-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_convert</span>(</span>
<span id="cb3-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"the-moon.mid"</span>,</span>
<span id="cb3-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">soundfont =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2"</span>,</span>
<span id="cb3-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">output =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output.wav"</span>,</span>
<span id="cb3-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">settings =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'synth.sample-rate'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">22050</span>),</span>
<span id="cb3-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">progress =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">interactive</span>()</span>
<span id="cb3-18">)</span>
<span id="cb3-19"></span>
<span id="cb3-20"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_convert</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">settings =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'synth.sample-rate'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">22050</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">output =</span>  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lowquality.wav'</span>)</span>
<span id="cb3-21"></span>
<span id="cb3-22">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output.wav"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output.mp3"</span>)</span></code></pre></div>
</details>
</div>
</section>
<section id="midi-to-mp3-all-night-long" class="level2">
<h2 class="anchored" data-anchor-id="midi-to-mp3-all-night-long">midi to mp3 All night long</h2>
<p>And now it is really this easy!</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system.file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generaluser-gs/midi/All_Night_Long.mid"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">package =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fluidsynth"</span>)</span>
<span id="cb4-2">fluidsynth<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_convert</span>(midi, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">output =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'all_night_long.mp3'</span>)</span></code></pre></div>
</details>
</div>
</section>
<section id="testing-faster-renders" class="level2">
<h2 class="anchored" data-anchor-id="testing-faster-renders">testing faster renders</h2>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system.file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generaluser-gs/midi/All_Night_Long.mid"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">package =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fluidsynth"</span>)</span>
<span id="cb5-2">fluidsynth<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_convert</span>(midi, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">output =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'all_night_long.mp3'</span>,</span>
<span id="cb5-3">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">settings =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'player.timing-source'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sample'</span>,</span>
<span id="cb5-4">                                         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'synth.lock-memory'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb5-5">                                         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'synth.cpu-cores'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>),</span>
<span id="cb5-6">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb5-7">                        </span>
<span id="cb5-8">                         )</span>
<span id="cb5-9"></span>
<span id="cb5-10"></span>
<span id="cb5-11"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb5-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compare render speed</span></span>
<span id="cb5-13"></span>
<span id="cb5-14">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"All_Night_Long"</span></span>
<span id="cb5-15"></span>
<span id="cb5-16">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb5-17">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi</span>
<span id="cb5-18">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb5-19"></span>
<span id="cb5-20">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 {midi_name}'</span>)</span>
<span id="cb5-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span></code></pre></div>
</details>
</div>
</section>
<section id="fluid-synth-settings" class="level2">
<h2 class="anchored" data-anchor-id="fluid-synth-settings">fluid synth settings</h2>
<p>All of these fluid synth parameters can now be easily modified from R!</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">knitr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(fluidsynth<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fluidsynth_setting_list</span>())</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: left;">type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">audio.coreaudio.channel-map</td>
<td style="text-align: left;">string</td>
</tr>
<tr class="even">
<td style="text-align: left;">audio.coreaudio.device</td>
<td style="text-align: left;">string</td>
</tr>
<tr class="odd">
<td style="text-align: left;">audio.driver</td>
<td style="text-align: left;">string</td>
</tr>
<tr class="even">
<td style="text-align: left;">audio.file.endian</td>
<td style="text-align: left;">string</td>
</tr>
<tr class="odd">
<td style="text-align: left;">audio.file.format</td>
<td style="text-align: left;">string</td>
</tr>
<tr class="even">
<td style="text-align: left;">audio.file.name</td>
<td style="text-align: left;">string</td>
</tr>
<tr class="odd">
<td style="text-align: left;">audio.file.type</td>
<td style="text-align: left;">string</td>
</tr>
<tr class="even">
<td style="text-align: left;">audio.period-size</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="odd">
<td style="text-align: left;">audio.periods</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="even">
<td style="text-align: left;">audio.portaudio.device</td>
<td style="text-align: left;">string</td>
</tr>
<tr class="odd">
<td style="text-align: left;">audio.realtime-prio</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="even">
<td style="text-align: left;">audio.sample-format</td>
<td style="text-align: left;">string</td>
</tr>
<tr class="odd">
<td style="text-align: left;">midi.autoconnect</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="even">
<td style="text-align: left;">midi.coremidi.id</td>
<td style="text-align: left;">string</td>
</tr>
<tr class="odd">
<td style="text-align: left;">midi.driver</td>
<td style="text-align: left;">string</td>
</tr>
<tr class="even">
<td style="text-align: left;">midi.portname</td>
<td style="text-align: left;">string</td>
</tr>
<tr class="odd">
<td style="text-align: left;">midi.realtime-prio</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="even">
<td style="text-align: left;">player.reset-synth</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="odd">
<td style="text-align: left;">player.timing-source</td>
<td style="text-align: left;">string</td>
</tr>
<tr class="even">
<td style="text-align: left;">shell.port</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="odd">
<td style="text-align: left;">shell.prompt</td>
<td style="text-align: left;">string</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.audio-channels</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="odd">
<td style="text-align: left;">synth.audio-groups</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.chorus.active</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="odd">
<td style="text-align: left;">synth.chorus.depth</td>
<td style="text-align: left;">double</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.chorus.level</td>
<td style="text-align: left;">double</td>
</tr>
<tr class="odd">
<td style="text-align: left;">synth.chorus.nr</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.chorus.speed</td>
<td style="text-align: left;">double</td>
</tr>
<tr class="odd">
<td style="text-align: left;">synth.cpu-cores</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.default-soundfont</td>
<td style="text-align: left;">string</td>
</tr>
<tr class="odd">
<td style="text-align: left;">synth.device-id</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.dynamic-sample-loading</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="odd">
<td style="text-align: left;">synth.effects-channels</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.effects-groups</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="odd">
<td style="text-align: left;">synth.gain</td>
<td style="text-align: left;">double</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.ladspa.active</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="odd">
<td style="text-align: left;">synth.lock-memory</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.midi-bank-select</td>
<td style="text-align: left;">string</td>
</tr>
<tr class="odd">
<td style="text-align: left;">synth.midi-channels</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.min-note-length</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="odd">
<td style="text-align: left;">synth.overflow.age</td>
<td style="text-align: left;">double</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.overflow.important</td>
<td style="text-align: left;">double</td>
</tr>
<tr class="odd">
<td style="text-align: left;">synth.overflow.important-channels</td>
<td style="text-align: left;">string</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.overflow.percussion</td>
<td style="text-align: left;">double</td>
</tr>
<tr class="odd">
<td style="text-align: left;">synth.overflow.released</td>
<td style="text-align: left;">double</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.overflow.sustained</td>
<td style="text-align: left;">double</td>
</tr>
<tr class="odd">
<td style="text-align: left;">synth.overflow.volume</td>
<td style="text-align: left;">double</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.polyphony</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="odd">
<td style="text-align: left;">synth.reverb.active</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.reverb.damp</td>
<td style="text-align: left;">double</td>
</tr>
<tr class="odd">
<td style="text-align: left;">synth.reverb.level</td>
<td style="text-align: left;">double</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.reverb.room-size</td>
<td style="text-align: left;">double</td>
</tr>
<tr class="odd">
<td style="text-align: left;">synth.reverb.width</td>
<td style="text-align: left;">double</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.sample-rate</td>
<td style="text-align: left;">double</td>
</tr>
<tr class="odd">
<td style="text-align: left;">synth.threadsafe-api</td>
<td style="text-align: left;">integer</td>
</tr>
<tr class="even">
<td style="text-align: left;">synth.verbose</td>
<td style="text-align: left;">integer</td>
</tr>
</tbody>
</table>
</div>
</div>


</section>

 ]]></description>
  <category>midiblender</category>
  <category>midi</category>
  <category>fluidsynth</category>
  <guid>https://homophony.quest/blog/48_2_15_24_r_fluid_synth/</guid>
  <pubDate>Thu, 15 Feb 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/48_2_15_24_r_fluid_synth/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Playing a MIDI file on a Quarto blog</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/47_2_13_24_midi_player/</link>
  <description><![CDATA[ 
<script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.4.0"></script>




<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Player piano. piano roll. Automatic self playing piano. white background. transformers cartoon. 3d."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/47_2_13_24_midi_player/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>This is just a picture. Scroll down to try the MIDI player for real.</p>
</div></div><p>I happened upon this midi player for webpages. Will it work here too? <a href="https://cifkao.github.io/html-midi-player/" class="uri">https://cifkao.github.io/html-midi-player/</a></p>
<p>Following the instructions from that website, I am adding this script in the yml for this .qmd file, along with a resources line to make sure the midi file is copied to the docs folder.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb2-1">resources: </span>
<span id="cb2-2">  - bluesy_C.mid</span>
<span id="cb2-3">include-before-body:</span>
<span id="cb2-4">  text: |</span>
<span id="cb2-5">    &lt;script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.4.0"&gt;&lt;/script&gt;</span></code></pre></div>
</details>
</div>
<p>Added an html block that has this code:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb3-1">&lt;midi-player</span>
<span id="cb3-2">  src="bluesy_C.mid"</span>
<span id="cb3-3">  sound-font visualizer="#myVisualizer"&gt;</span>
<span id="cb3-4">&lt;/midi-player&gt;</span>
<span id="cb3-5">&lt;midi-visualizer type="piano-roll" id="myVisualizer"&gt;&lt;/midi-visualizer&gt;</span></code></pre></div>
</details>
</div>
<p>And, it works!</p>
<midi-player src="bluesy_C.mid" sound-font="" visualizer="#myVisualizer">
</midi-player>
<midi-visualizer type="piano-roll" id="myVisualizer"></midi-visualizer>
<hr>
<p>Cool, I have not looked deeply into this at all, so I have no idea whats behind the sound generation. Im just curious about what happens if I play a midi file that should have a few different voices. I choose the moon theme from the NES ducktales game. Such a great song.</p>
<midi-player src="the-moon.mid" sound-font="" visualizer="#myVisualizer">
</midi-player>
<midi-visualizer type="piano-roll" id="myVisualizer"></midi-visualizer>
<p>OH YA!!!!!</p>



 ]]></description>
  <category>midiblender</category>
  <category>midi</category>
  <guid>https://homophony.quest/blog/47_2_13_24_midi_player/</guid>
  <pubDate>Tue, 13 Feb 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/47_2_13_24_midi_player/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>MIDI composition with {dplyr}, {midiblender}, and {pyramidi}</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/46_2_12_24_dplyr_midi/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"composing music with rstats. dplyr musical notes. tidyverse. hexagons everywhere. 3d. music inside hexagons floating in the universe. musical notes inside the hexagons. cartoon. linocut"</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/46_2_12_24_dplyr_midi/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>Massive modular synthesizer. Eurorack modular synthesizer. Huge synthesizer room, full or modular synthesizers with patch cords connecting everywer. 80s cartoon. Linocut. - dreamshaper</p>
</div></div><p>This morning I added some <a href="">dplyr</a> style functions to <a href="">midiblender</a> for row-by-row, explicit construction of a data frame containing midi information. Ill provide some examples here, and use this post to try a few compositional goals with the dplyr approach.</p>
<p><a href="https://urswilke.github.io/pyramidi/articles/compose.html">pyramidi</a> also has examples of composition with dplyr syntax that are worth checking out. My approach relies on several pyramidi internal functions, and is pretty similar overall.</p>
<section id="midi-dataframe-construction-with-dplyr" class="level2">
<h2 class="anchored" data-anchor-id="midi-dataframe-construction-with-dplyr">Midi dataframe construction with {dplyr}</h2>
<p>Some of these examples are also in the vignette, <a href="https://www.crumplab.com/midiblender/articles/midi_construct.html">Midi data frame constructors with dplyr</a>.</p>
<p>The following block of code shows an example of systematically creating a midi data frame, on a row-by-row basis. The functions are mostly wrappers to <code>dplyr::add_row</code>, but they have midi variables in them.</p>
<p>Functions that add a row start with add, which makes them easy to find with autocomplete while programming. These functions also pass <code>...</code>, which is useful for placing a row <code>.before</code> or <code>.after</code> another row.</p>
<p>This code block writes important meta messages, shows that it is possible to write program_change and control_change messages, and writes a couple notes before ending the track.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pyramidi)</span>
<span id="cb2-3"></span>
<span id="cb2-4">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create_empty_midi_df</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize columns</span></span>
<span id="cb2-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_track_name</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"My track"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_tempo</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_time_sig</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">numerator =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb2-8">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">denominator =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb2-9">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clocks_per_click =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>,</span>
<span id="cb2-10">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notated_32nd_notes_per_beat =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_program_change</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb2-12">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_control_change</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_note_on</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_note_off</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_end_of_track</span>()</span>
<span id="cb2-17"></span>
<span id="cb2-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print the data frame.</span></span>
<span id="cb2-19">knitr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(new_midi_df)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 9%">
<col style="width: 5%">
<col style="width: 3%">
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 10%">
<col style="width: 17%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 5%">
<col style="width: 3%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">i_track</th>
<th style="text-align: left;">meta</th>
<th style="text-align: left;">type</th>
<th style="text-align: left;">name</th>
<th style="text-align: right;">time</th>
<th style="text-align: right;">numerator</th>
<th style="text-align: right;">denominator</th>
<th style="text-align: right;">clocks_per_click</th>
<th style="text-align: right;">notated_32nd_notes_per_beat</th>
<th style="text-align: right;">program</th>
<th style="text-align: right;">channel</th>
<th style="text-align: right;">control</th>
<th style="text-align: right;">value</th>
<th style="text-align: right;">note</th>
<th style="text-align: right;">velocity</th>
<th style="text-align: right;">tempo</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">track_name</td>
<td style="text-align: left;">My track</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">set_tempo</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">5e+05</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">time_signature</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">program_change</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">control_change</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">60</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_off</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">60</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">end_of_track</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="pyramidi-object-creation-and-export" class="level2">
<h2 class="anchored" data-anchor-id="pyramidi-object-creation-and-export">Pyramidi object creation and export</h2>
<p>This shows how to take a midi dataframe like the above, and export it to disk as a .mid file.</p>
<p>First, <code>pyramidi::MidiFramer$new()</code> creates a new pyramidi object.</p>
<p>Upon creation, it is possible to update <code>new_pyramidi_object$ticks_per_beat</code> with a new value. I believe the default value is <code>960L</code>, and the code below updates it to a smaller value.</p>
<p>The <code>new_midi_df</code> from above is then updated within the pyramidi object using <code>new_pyramidi_object$mf$midi_frame_unnested$update_unnested_mf(new_midi_df)</code>.</p>
<p>Finally, <code>new_pyramidi_object$mf$write_file("file_name.mid")</code> writes the file to disk.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Initialize new pyramidi object</span></span>
<span id="cb3-2">new_pyramidi_object <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>MidiFramer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>()</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update ticks per beat</span></span>
<span id="cb3-5">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span>L</span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update object with new midi df</span></span>
<span id="cb3-8">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb3-9"></span>
<span id="cb3-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write to midi file</span></span>
<span id="cb3-11">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file_name.mid"</span>)</span></code></pre></div>
</details>
</div>
</section>
<section id="composing-with-a-wide-data-frame-then-pivoting-to-long" class="level2">
<h2 class="anchored" data-anchor-id="composing-with-a-wide-data-frame-then-pivoting-to-long">Composing with a wide data frame, then pivoting to long</h2>
<p>Midi files writes note_on and note_off messages in succession with time stamps coding relative time since the last message. For composition, it may be convenient to work with a wider data frame.</p>
<p>Heres an example of using dplyr to create a series of notes over time. The notes are randomly chosen from the vector <code>possible_notes</code>. The rhythm defining when a note occurs is generated by <code>bresenham_euclidean()</code>, which can produce some nice sounding rhythms. The code chunk will generate as many bars as defined in <code>bars</code>, and the shortest note is a 16th note.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># note parameters</span></span>
<span id="cb4-4">bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of bars</span></span>
<span id="cb4-5">bar_time_steps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of time steps in a bar</span></span>
<span id="cb4-6">note_duration <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># note duration in ticks</span></span>
<span id="cb4-7">possible_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">63</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">66</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">67</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">72</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">75</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># midi note values to pick</span></span>
<span id="cb4-8"></span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create a tibble to compose notes in time </span></span>
<span id="cb4-10">compose_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb4-11">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb4-12">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beat_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb4-13">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb4-14">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add multiple bars worth of notes</span></span>
<span id="cb4-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beat_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replicate</span>(bars,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>),<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb4-17">                                            bar_time_steps,</span>
<span id="cb4-18">                                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))),</span>
<span id="cb4-19">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(possible_notes, </span>
<span id="cb4-20">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> bar_time_steps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars, </span>
<span id="cb4-21">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb4-22">          ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-23">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># handle note times</span></span>
<span id="cb4-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb4-25">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_on =</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>note_duration,</span>
<span id="cb4-26">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off =</span> note_on<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>note_duration) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># keep events where a beat occurred</span></span>
<span id="cb4-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(beat_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) </span>
<span id="cb4-29"></span>
<span id="cb4-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#print to show</span></span>
<span id="cb4-31">knitr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(compose_notes))</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">note_id</th>
<th style="text-align: right;">note</th>
<th style="text-align: right;">beat_on</th>
<th style="text-align: right;">note_on</th>
<th style="text-align: right;">note_off</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">24</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">96</td>
<td style="text-align: right;">120</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">192</td>
<td style="text-align: right;">216</td>
</tr>
<tr class="even">
<td style="text-align: right;">13</td>
<td style="text-align: right;">66</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">288</td>
<td style="text-align: right;">312</td>
</tr>
<tr class="odd">
<td style="text-align: right;">17</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">384</td>
<td style="text-align: right;">408</td>
</tr>
<tr class="even">
<td style="text-align: right;">19</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">432</td>
<td style="text-align: right;">456</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>At this point the <code>compose_notes</code> dataframe contains note_on and note_off information in wide format. A quick call to <code>tidyr::pivot_longer</code>, along with subtracting the time stamps to get them into relative time, and we have a dataframe that is nearly ready for export.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">compose_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> compose_notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pivot to long</span></span>
<span id="cb5-3">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_off"</span>),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># relative time</span></span>
<span id="cb5-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(time,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">default=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#print to show</span></span>
<span id="cb5-8">knitr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(compose_notes))</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">note_id</th>
<th style="text-align: right;">note</th>
<th style="text-align: right;">beat_on</th>
<th style="text-align: left;">type</th>
<th style="text-align: right;">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">note_off</td>
<td style="text-align: right;">24</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: right;">72</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">note_off</td>
<td style="text-align: right;">24</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: right;">72</td>
</tr>
<tr class="even">
<td style="text-align: right;">9</td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">note_off</td>
<td style="text-align: right;">24</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Now we have a body of midi messages. The last step is to put them into a full-fledged midi dataframe, and export them.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create new midi_df</span></span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## add to a new midi df</span></span>
<span id="cb6-4">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create_empty_midi_df</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize</span></span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_track_name</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"My track"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_tempo</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_time_sig</span>(</span>
<span id="cb6-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">numerator =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb6-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">denominator =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb6-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clocks_per_click =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>,</span>
<span id="cb6-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notated_32nd_notes_per_beat =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb6-12">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_program_change</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb6-14">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_control_change</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add new notes &lt;---------------Adding stuff from compose_notes</span></span>
<span id="cb6-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(compose_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]), </span>
<span id="cb6-18">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(compose_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb6-19">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note,</span>
<span id="cb6-20">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type,</span>
<span id="cb6-21">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time,</span>
<span id="cb6-22">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_end_of_track</span>()</span>
<span id="cb6-24"></span>
<span id="cb6-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi</span></span>
<span id="cb6-26"></span>
<span id="cb6-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Initialize new pyramidi object</span></span>
<span id="cb6-28">new_pyramidi_object <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>MidiFramer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>()</span>
<span id="cb6-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update ticks per beat</span></span>
<span id="cb6-30">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span>L</span>
<span id="cb6-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update object with new midi df</span></span>
<span id="cb6-32">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb6-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write to midi file</span></span>
<span id="cb6-34">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file_name.mid"</span>)</span></code></pre></div>
</details>
</div>
</section>
<section id="making-it-less-of-a-wall-of-code" class="level2">
<h2 class="anchored" data-anchor-id="making-it-less-of-a-wall-of-code">Making it less of a wall of code</h2>
<p>Im not working on this right now. Going with walls of code.</p>
</section>
<section id="frequency-biased-sequences" class="level2">
<h2 class="anchored" data-anchor-id="frequency-biased-sequences">Frequency biased sequences</h2>
<p>Ive got a project coming up where I will likely need to generate a whole bunch of musical sequences with specific kinds of statistical structure. Im not sure whether I will use the {dplyr} style code for this. This is a note to future self about what it might look like.</p>
<ul>
<li>got something that will work later</li>
<li>need to write functions for creating unequal frequency vectors with specific constraints</li>
<li>Move development on this issue to another castle.</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># note parameters</span></span>
<span id="cb7-2">bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb7-3">possible_time_steps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb7-4">note_duration <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span></span>
<span id="cb7-5">possible_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">63</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">66</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">67</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">72</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">75</span>)</span>
<span id="cb7-6"></span>
<span id="cb7-7">total_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb7-8">total_beats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>possible_time_steps</span>
<span id="cb7-9"></span>
<span id="cb7-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># need to work out some algorithms for unequal frequency distribution generation, these are enough for an example</span></span>
<span id="cb7-11">equal_frequencies <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(total_beats<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb7-12">half_frequencies <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> equal_frequencies <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (equal_frequencies <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> total_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb7-13">most_unequal_frequencies <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,(total_notes<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)),(total_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(total_notes<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb7-14"></span>
<span id="cb7-15">note_frequency_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(equal_frequencies,</span>
<span id="cb7-16">                              half_frequencies,</span>
<span id="cb7-17">                              most_unequal_frequencies)</span>
<span id="cb7-18"></span>
<span id="cb7-19">compose_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb7-20">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb7-21">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beat_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb7-22">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb7-23">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-24">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1 beat every time_step</span></span>
<span id="cb7-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beat_on =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb7-27">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(possible_notes),</span>
<span id="cb7-28">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> note_frequency_matrix[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,])),</span>
<span id="cb7-29">          ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-31">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># handle note times</span></span>
<span id="cb7-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb7-33">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_on =</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>note_duration,</span>
<span id="cb7-34">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off =</span> note_on<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>note_duration) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(beat_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-36">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#pivot to long</span></span>
<span id="cb7-37">  tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_off"</span>),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(time,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">default=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb7-39"></span>
<span id="cb7-40"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## add to a new midi df</span></span>
<span id="cb7-41">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create_empty_midi_df</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize</span></span>
<span id="cb7-42">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_track_name</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"My track"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-43">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_tempo</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-44">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_time_sig</span>(</span>
<span id="cb7-45">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">numerator =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb7-46">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">denominator =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb7-47">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clocks_per_click =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>,</span>
<span id="cb7-48">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notated_32nd_notes_per_beat =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb7-49">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-50">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_program_change</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb7-51">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-52">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_control_change</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-53">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#use dplyr::add_row to add a bunch of notes</span></span>
<span id="cb7-54">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(compose_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]), </span>
<span id="cb7-55">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(compose_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb7-56">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note,</span>
<span id="cb7-57">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type,</span>
<span id="cb7-58">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time,</span>
<span id="cb7-59">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-60">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_end_of_track</span>()</span>
<span id="cb7-61"></span>
<span id="cb7-62"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi</span></span>
<span id="cb7-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Initialize new pyramidi object</span></span>
<span id="cb7-64">new_pyramidi_object <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>MidiFramer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>()</span>
<span id="cb7-65"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update ticks per beat</span></span>
<span id="cb7-66">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span>L</span>
<span id="cb7-67"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update object with new midi df</span></span>
<span id="cb7-68">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb7-69"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write to midi file</span></span>
<span id="cb7-70">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"most_unequal.mid"</span>)</span></code></pre></div>
</details>
</div>
</section>
<section id="bar-blues-sequence" class="level2">
<h2 class="anchored" data-anchor-id="bar-blues-sequence">12-bar blues sequence</h2>
<p>I like a good blues scale. Undoubtedly, whatever happens next wont be bluesy, but thats ok.</p>
<p>Algorithm components</p>
<ol type="1">
<li>Sample notes from a blues scale</li>
<li>Eavery bar, randomly sample a euclidean rhythm to fill the bar</li>
<li>randomly assign notes to the beats in the euclidean rhythm</li>
<li>Create a few tracks of this.</li>
<li>try shifting chords, do 12 bar blues</li>
</ol>
<p>Got it working, nice</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">all_tracks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>()</span>
<span id="cb8-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loop for each track</span></span>
<span id="cb8-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(t <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) {</span>
<span id="cb8-4">  </span>
<span id="cb8-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># note parameters</span></span>
<span id="cb8-6">  bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb8-7">  possible_time_steps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb8-8">  note_duration <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span></span>
<span id="cb8-9">  possible_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">63</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">66</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">67</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">72</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">75</span>)</span>
<span id="cb8-10">  </span>
<span id="cb8-11">  key_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each=</span>possible_time_steps),<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb8-12">  </span>
<span id="cb8-13">  compose_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb8-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb8-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb8-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beat_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb8-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb8-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>()</span>
<span id="cb8-19">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use euclidean rhythm</span></span>
<span id="cb8-21">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb8-23">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beat_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replicate</span>(</span>
<span id="cb8-24">        bars,</span>
<span id="cb8-25">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb8-26">                            possible_time_steps,</span>
<span id="cb8-27">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-28">      )),</span>
<span id="cb8-29">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(possible_notes,</span>
<span id="cb8-30">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> possible_time_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bars,</span>
<span id="cb8-31">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> key_vector</span>
<span id="cb8-32">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-33">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># handle note times</span></span>
<span id="cb8-35">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb8-36">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb8-37">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_on =</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> note_duration,</span>
<span id="cb8-38">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off =</span> note_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> note_duration</span>
<span id="cb8-39">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-40">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(beat_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-41">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#pivot to long</span></span>
<span id="cb8-42">    tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_off"</span>),</span>
<span id="cb8-43">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>,</span>
<span id="cb8-44">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-45">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(time, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">default =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb8-46">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">######################</span></span>
<span id="cb8-47">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># End composition </span></span>
<span id="cb8-48">  </span>
<span id="cb8-49">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#######################</span></span>
<span id="cb8-50">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## add composition to a new midi df</span></span>
<span id="cb8-51">  new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create_empty_midi_df</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize</span></span>
<span id="cb8-52">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_track_name</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"My track"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-53">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_tempo</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-54">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_time_sig</span>(</span>
<span id="cb8-55">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">numerator =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb8-56">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">denominator =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb8-57">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clocks_per_click =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>,</span>
<span id="cb8-58">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notated_32nd_notes_per_beat =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb8-59">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-60">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_program_change</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb8-61">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-62">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_control_change</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-63">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Composition added here</span></span>
<span id="cb8-64">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb8-65">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(compose_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb8-66">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(compose_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb8-67">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note,</span>
<span id="cb8-68">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type,</span>
<span id="cb8-69">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time,</span>
<span id="cb8-70">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span></span>
<span id="cb8-71">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-72">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_end_of_track</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-73">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> t) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set current track number</span></span>
<span id="cb8-74">  </span>
<span id="cb8-75">  all_tracks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(all_tracks,new_midi_df)</span>
<span id="cb8-76">  </span>
<span id="cb8-77">}</span>
<span id="cb8-78"></span>
<span id="cb8-79"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi</span></span>
<span id="cb8-80"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Initialize new pyramidi object</span></span>
<span id="cb8-81">new_pyramidi_object <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>MidiFramer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>()</span>
<span id="cb8-82"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update ticks per beat</span></span>
<span id="cb8-83">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span>L</span>
<span id="cb8-84"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update object with new midi df</span></span>
<span id="cb8-85">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(all_tracks)</span>
<span id="cb8-86"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write to midi file</span></span>
<span id="cb8-87">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bluesy_A.mid"</span>)</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="bluesy_A_ableton_01.mp3" type="audio/wav"> </audio></p>
<p>I put three midi tracks into ableton, added synth voices and drums, and thats what it sounds like.</p>
<p>Hmmm, the dplyr style worked out. I didnt think it would be so easy to get a 12-bar blues thing going. It still sounds like a computer made it, but a computer did make it, so thats fair.</p>
<hr>
<p>Adding parameters per track in a list.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb9-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pyramidi)</span>
<span id="cb9-4"></span>
<span id="cb9-5">all_tracks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>()</span>
<span id="cb9-6"></span>
<span id="cb9-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># note parameters</span></span>
<span id="cb9-8">  bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb9-9">  possible_time_steps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb9-10">  note_duration <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span></span>
<span id="cb9-11">  </span>
<span id="cb9-12">  track_params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_1_bass =</span></span>
<span id="cb9-13">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">72</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#1     2     3  4     5     6     7  8 </span></span>
<span id="cb9-14">                                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)), </span>
<span id="cb9-15">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key_vector =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>), </span>
<span id="cb9-16">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> possible_time_steps), </span>
<span id="cb9-17">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb9-18">                           ),</span>
<span id="cb9-19">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_2_mid =</span></span>
<span id="cb9-20">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">72</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#1     2     3  4     5     6     7  8 </span></span>
<span id="cb9-21">                                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)), </span>
<span id="cb9-22">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key_vector =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>), </span>
<span id="cb9-23">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> possible_time_steps), </span>
<span id="cb9-24">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb9-25">                          ),</span>
<span id="cb9-26">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_3_mid =</span></span>
<span id="cb9-27">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">possible_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">72</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#1     2     3  4     5     6     7  8 </span></span>
<span id="cb9-28">                                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)), </span>
<span id="cb9-29">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key_vector =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), </span>
<span id="cb9-30">                                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> possible_time_steps), </span>
<span id="cb9-31">                                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb9-32">                          )</span>
<span id="cb9-33">  )</span>
<span id="cb9-34">                       </span>
<span id="cb9-35">                           </span>
<span id="cb9-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loop for each track</span></span>
<span id="cb9-37"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(t <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) {</span>
<span id="cb9-38">  </span>
<span id="cb9-39">  compose_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb9-40">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb9-41">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb9-42">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beat_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb9-43">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>(),</span>
<span id="cb9-44">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integer</span>()</span>
<span id="cb9-45">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-46">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use euclidean rhythm</span></span>
<span id="cb9-47">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-48">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb9-49">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beat_on =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replicate</span>(</span>
<span id="cb9-50">        bars,</span>
<span id="cb9-51">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), </span>
<span id="cb9-52">                            possible_time_steps,</span>
<span id="cb9-53">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb9-54">      )),</span>
<span id="cb9-55">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>possible_notes,</span>
<span id="cb9-56">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> possible_time_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bars,</span>
<span id="cb9-57">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> track_params[[t]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>key_vector</span>
<span id="cb9-58">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-59">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-60">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># handle note times</span></span>
<span id="cb9-61">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb9-62">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb9-63">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_on =</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> note_duration,</span>
<span id="cb9-64">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off =</span> note_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> note_duration</span>
<span id="cb9-65">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-66">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(beat_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-67">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#pivot to long</span></span>
<span id="cb9-68">    tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_off"</span>),</span>
<span id="cb9-69">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>,</span>
<span id="cb9-70">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-71">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(time, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">default =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb9-72">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">######################</span></span>
<span id="cb9-73">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># End composition </span></span>
<span id="cb9-74">  </span>
<span id="cb9-75">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#######################</span></span>
<span id="cb9-76">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## add composition to a new midi df</span></span>
<span id="cb9-77">  new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create_empty_midi_df</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize</span></span>
<span id="cb9-78">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_track_name</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"My track"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-79">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_tempo</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-80">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_time_sig</span>(</span>
<span id="cb9-81">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">numerator =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb9-82">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">denominator =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb9-83">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clocks_per_click =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>,</span>
<span id="cb9-84">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notated_32nd_notes_per_beat =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb9-85">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-86">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_program_change</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb9-87">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-88">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_control_change</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-89">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Composition added here</span></span>
<span id="cb9-90">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb9-91">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(compose_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb9-92">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(compose_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb9-93">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note,</span>
<span id="cb9-94">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type,</span>
<span id="cb9-95">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> compose_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time,</span>
<span id="cb9-96">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span></span>
<span id="cb9-97">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-98">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_meta_end_of_track</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-99">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> t) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set current track number</span></span>
<span id="cb9-100">  </span>
<span id="cb9-101">  all_tracks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(all_tracks,new_midi_df)</span>
<span id="cb9-102">  </span>
<span id="cb9-103">}</span>
<span id="cb9-104"></span>
<span id="cb9-105"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi</span></span>
<span id="cb9-106"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Initialize new pyramidi object</span></span>
<span id="cb9-107">new_pyramidi_object <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>MidiFramer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>()</span>
<span id="cb9-108"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update ticks per beat</span></span>
<span id="cb9-109">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span>L</span>
<span id="cb9-110"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update object with new midi df</span></span>
<span id="cb9-111">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(all_tracks)</span>
<span id="cb9-112"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write to midi file</span></span>
<span id="cb9-113">new_pyramidi_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bluesy_C.mid"</span>)</span></code></pre></div>
</details>
</div>


</section>

 ]]></description>
  <category>midiblender</category>
  <category>pyramidi</category>
  <category>rstats</category>
  <category>dplyr</category>
  <category>midi composition</category>
  <guid>https://homophony.quest/blog/46_2_12_24_dplyr_midi/</guid>
  <pubDate>Mon, 12 Feb 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/46_2_12_24_dplyr_midi/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Eurorack notes to self</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/45_2_11_24_eurorack/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Massive modular synthesizer. Eurorack modular synthesizer. Huge synthesizer room, full or modular synthesizers with patch cords connecting everywer. 80s cartoon. Linocut."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/45_2_11_24_eurorack/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>Massive modular synthesizer. Eurorack modular synthesizer. Huge synthesizer room, full or modular synthesizers with patch cords connecting everywer. 80s cartoon. Linocut. - dreamshaper</p>
</div></div><p>Notes to self about eurorack stuff.</p>
<section id="programmable-eurorack-modules" class="level2">
<h2 class="anchored" data-anchor-id="programmable-eurorack-modules">Programmable Eurorack Modules</h2>
<p>I very briefly <a href="https://www.crumplab.com/blog/older_9999_7_28_20_OC/">tried to program ornaments and crime one time</a>. But thats about it. I could see becoming interested in putting ideas from {midiblender}, and other ideas, into eurorack in different ways.</p>
<ul>
<li><p>older post on mod wiggler about open source programmable eurorack modules <a href="https://modwiggler.com/forum/viewtopic.php?t=220061" class="uri">https://modwiggler.com/forum/viewtopic.php?t=220061</a></p></li>
<li><p>a useful list of programmable audio platforms <a href="https://blog.macieksypniewski.com/2019/07/08/programmable-audio-platforms/" class="uri">https://blog.macieksypniewski.com/2019/07/08/programmable-audio-platforms/</a></p></li>
<li><p>Bela pepper <a href="https://shop.bela.io/collections/modular/products/pepper" class="uri">https://shop.bela.io/collections/modular/products/pepper</a></p></li>
<li><p><a href="https://monome.org/docs/">Monome</a> has some interesting stuff</p></li>
<li><p><a href="https://allensynthesis.co.uk/modules/europi.html">EuroPi</a> Based on raspberry pi pico I think</p></li>
<li><p><a href="https://www.expert-sleepers.co.uk/es8.html">Es8</a> or <a href="https://www.expert-sleepers.co.uk/es9.html">ES-9</a> USB-audio interfaceI could use one of these in general I thinkhmm.</p></li>
</ul>
</section>
<section id="eurorack-composition-ideas" class="level2">
<h2 class="anchored" data-anchor-id="eurorack-composition-ideas">Eurorack composition ideas</h2>
<p>I dont really want to mess with my computer while messing with eurorack at the same time, as a general rule.</p>
<section id="easy-can-do-right-now" class="level3">
<h3 class="anchored" data-anchor-id="easy-can-do-right-now">Easy can do right now</h3>
<ol type="1">
<li>Use {midiblender} to compose MIDI files with some things I want, play them through hermod. This gives me 8-voices. Probably the easiest thing I can do right now. Benefits are that the midi files are pre-packaged, and I shouldnt have to worry about any latency or anything like that.</li>
</ol>
<ul>
<li>I like this pattern for a bunch of reasons. I focus on some compositional ideas outside of eurorack. Generate all the midi based on the compositional ideaswhich basically acts as CV and gate sources. Hook it all up to voices on, and wreck the whole thing as much as possible by turning knobs during playback. Sounds fun. Feels a little bit locked in to the compositional direction from the midi files, but I guess thats the whole point of composing something.</li>
</ul>
<ol start="2" type="1">
<li>This is somewhere in the middle, but I wonder about a way to rapidly scroll through a bunch of midi files, while they are playing, kind of like how one might scroll through a wavetable and hear all of the notes. If I had banks of possible midi files to play, and could easily scroll them, that would be fun. hmmmm.</li>
</ol>
</section>
<section id="longer-term-cant-do-right-now" class="level3">
<h3 class="anchored" data-anchor-id="longer-term-cant-do-right-now">longer term cant do right now</h3>
<ol start="2" type="1">
<li>Have a module (or computer program) that can accumulate CV or midi from a live performance, crunch the probabilities at various levels (e.g., into various markov chain ideas, or other weird stuff), and do interesting generative sequencing based off of the live performance statistics.</li>
</ol>


</section>
</section>

 ]]></description>
  <category>midiblender</category>
  <category>eurorack</category>
  <category>programmable eurorack</category>
  <category>composition</category>
  <guid>https://homophony.quest/blog/45_2_11_24_eurorack/</guid>
  <pubDate>Sun, 11 Feb 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/45_2_11_24_eurorack/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Euclidean Rhythms and circulating sequences with information theory concepts</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/44_2_10_24_euclid/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A computer drumming. synthesizer drum. Drum beats. probabilistic drums. information theory. Euclid. Math. Drum machines everywhere. background is a room full of drum machines. Rhythm. drums. Transformers cartoon. retro 80s."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/44_2_10_24_euclid/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>A computer drumming. synthesizer drum. Drum beats. probabilistic drums. information theory. Euclid. Math. Drum machines everywhere. background is a room full of drum machines. Rhythm. drums. Transformers cartoon. retro 80s. - dreamshaper</p>
</div></div><p>This is another exploratory post. Im planning to use <a href="https://www.crumplab.com/midiblender/">midiblender</a> for a few things in the future. One of them is to generate stimuli for musical recognition tasks. The others are mostly fooling around. This here is a bit of both.</p>
<p>Ive been practicing the following kinds of patterns on piano, and Ive been thinking about coding them as a generative sequence algorithm. Ill start playing around on a single note, like C major, and then slowly add notes from the circle of fifths around the note Im playing. Ill bring in F and G, which gives a very Csus feel. And, then Ill go out even more, add a Bb and D. These fifths are symmetrical about C. Sometimes Ill go a bit lopsided, maybe add an A into the mix, and feel it out as I play. Another way to look at this is that Im playing some group of notes from the circle of fifths, like {Bb, F, C, G, D}. I could expand the collection by adding more notes, or reduce the collection by taking some away. Sometimes I rotate around the circle, etc. Its fun to play on piano.</p>
<p>One goal for this post is to get an algorithm that does something like the above. Just wanders around the cycle of fifths, expands and contracts the collection of notes to play, and then spits them out in an interesting rhythm.</p>
<p>But, what rhythm should I code in here? Euclidean Rhythms to the rescue. They mostly sound fine. Not the most super interesting rhythms ever, but very fine. If you dont know what they are, <a href="https://medium.com/code-music-noise/euclidean-rhythms-391d879494df">this was a good post</a> describing them, and it also had some code I modified to make a Euclidean Rhythms algorithm for R. I use these rhythms all the time in modular synthesis. So, part of this post is about getting them into {midiblender}.</p>
<p>Ideally I would have a bunch of midi notes spread about in euclidean rhythms, and I could assign pitches to those notes using some kind of circle of fifths algorithm. Enter the last part of the equation, concepts from information theory.</p>
<p>Information theory provides an equation to measure the variance of a discrete probability distribution. Its called <a href="https://en.wikipedia.org/wiki/Entropy_(information_theory)">Shannon entropy</a>, and I wont go into the details here too much. Actually, I doubt I will use the equation for this. Its the concept of variation in a probability distribution that Im interested in.</p>
<p>A uniform probability distribution has no variance. All of the elements in the distribution have an equal likelihood of occurrence. I could use a uniform distribution to randomly pick notes from a collection like {Bb, F, C, G, D}, and sequences produced from that distribution would have 100% entropy. Another option is to bias the probabilities so that some of the notes are more probable than others in the set. These kinds of sequences have less entropy and are more predictable.</p>
<p>Musical sequences usually dont look like they come from a uniform distribution, often times some notes repeat more often than others. In terms of generating sequences with {midiblender}, Id like some control over the variance of the probability distribution that is controlling note occurrences. Ideally, I would have an entropy knob on my eurorack somewhere that did all of this.</p>
<p>Those are the basic ideas. Im going to code some stuff and see what happens.</p>
<section id="euclidean-rhythms-in-r" class="level2">
<h2 class="anchored" data-anchor-id="euclidean-rhythms-in-r">Euclidean Rhythms in R</h2>
<p>Heres a function that creates Euclidean rhythms in R. Again, thanks to Jeff Holtzkener for a great <a href="https://medium.com/code-music-noise/euclidean-rhythms-391d879494df">run down on this algorithm</a>. To give some more credit, Euclidean rhythms were coined by Godfried Toussaint <span class="citation" data-cites="toussaint2005">(Toussaint 2005)</span>, and his paper is available <a href="https://archive.bridgesmathart.org/2005/bridges2005-47.pdf">here</a>.</p>
<p>The basic idea for the algorithm is to find a way to spread beats evenly through a set of time steps. 4 beats goes into 16 steps very evenly, 1 beat every 4 steps. But, how does one space 5 beats into 13 steps. The algorithm finds some nice solutions that happen to also sound good as rhythms. I learned from the Holtzkener post that <a href="https://en.wikipedia.org/wiki/Bresenham%27s_line_algorithm">Bresenhams line algorithm</a> (for raster scans), also works to compute Euclidean Rhythms, so I use that equation here.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">bresenham_euclidean <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(beats, steps, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb2-2">  previous <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> start</span>
<span id="cb2-3">  pattern <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>()</span>
<span id="cb2-4">  </span>
<span id="cb2-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(steps<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)) {</span>
<span id="cb2-6">    xVal <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">floor</span>((beats <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> steps) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (i))</span>
<span id="cb2-7">    pattern <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(pattern, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(xVal <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> previous, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb2-8">    previous <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xVal</span>
<span id="cb2-9">  }</span>
<span id="cb2-10">  </span>
<span id="cb2-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(pattern)</span>
<span id="cb2-12">}</span></code></pre></div>
</details>
</div>
<p>Heres a 4 on the floor:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beats =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">steps =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) </span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 1 0 0 0 1 0 0 0 1 0 0 0 1 0 0 0</code></pre>
</div>
</div>
<p>Heres 7 beats over 16 steps:</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beats =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">steps =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) </span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 1 0 0 1 0 1 0 1 0 0 1 0 1 0 1 0</code></pre>
</div>
</div>
<p>Great it seems to work. Im tempted to go in a completely different direction and do some killer beats with {midiblender}, but that is too exciting. I will be back one day for the killer beats.</p>
<p>Screw it, what is this blog if not a series of digressions. I think Ive got enough breadcrumbs to lay down a beat quickly (fingers crossed).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The mp3s sometimes take a bit to load, especially the longer ones.</p>
</div>
</div>
</section>
<section id="a-basic-drum-beat" class="level2">
<h2 class="anchored" data-anchor-id="a-basic-drum-beat">A basic drum beat</h2>
<p>The metric structure for the beat should be easy. I just need to figure out which midi notes are which for the drum sounds.</p>
<p>notes:</p>
<ul>
<li>channel 9 from FluidR3_GM.sf2</li>
<li>percussion map <a href="https://usermanuals.finalemusic.com/SongWriter2012Win/Content/PercussionMaps.htm" class="uri">https://usermanuals.finalemusic.com/SongWriter2012Win/Content/PercussionMaps.htm</a></li>
</ul>
<p>kick = 36 snare = 38 hihats = 42</p>
<p>Lets do 4 bars or something like that.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb7-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import midi</span></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># using mario to get the midi headers</span></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># need to add a vanilla midi file to this package for easier importing</span></span>
<span id="cb7-5">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb7-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(mario, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># send objects to global environment</span></span>
<span id="cb7-7"></span>
<span id="cb7-8">bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span></span>
<span id="cb7-9">notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span></span>
<span id="cb7-10">ticks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars</span>
<span id="cb7-11"></span>
<span id="cb7-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># empty beat matrix</span></span>
<span id="cb7-13">beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span>notes,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span>ticks)</span>
<span id="cb7-14"></span>
<span id="cb7-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#assign kick beats</span></span>
<span id="cb7-16">kick <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars,ticks, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-17">snare <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars,ticks, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-18">hihats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars,ticks, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-19"></span>
<span id="cb7-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign to matrix</span></span>
<span id="cb7-21">beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> kick</span>
<span id="cb7-22">beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">38</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> snare</span>
<span id="cb7-23">beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> hihats</span>
<span id="cb7-24"></span>
<span id="cb7-25"></span>
<span id="cb7-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transform back to midi</span></span>
<span id="cb7-27">track_0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_midi_df_track</span>(midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-28"></span>
<span id="cb7-29">midi_time_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_time</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> beat_matrix,</span>
<span id="cb7-30">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_time_unit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb7-31">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off_length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb7-32"></span>
<span id="cb7-33">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_midi_meta_df</span>(track_0)</span>
<span id="cb7-34"></span>
<span id="cb7-35">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_midi_tempo_meta</span>(meta_messages_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">update_tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>)</span>
<span id="cb7-36"></span>
<span id="cb7-37">split_meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split_meta_df</span>(meta_messages_df)</span>
<span id="cb7-38"></span>
<span id="cb7-39">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_time_df =</span> midi_time_df,</span>
<span id="cb7-40">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_meta_list =</span> split_meta_messages_df,</span>
<span id="cb7-41">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,</span>
<span id="cb7-42">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb7-43"></span>
<span id="cb7-44"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb7-45"></span>
<span id="cb7-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb7-47">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb7-48"></span>
<span id="cb7-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb7-50">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beat.mid"</span>)</span>
<span id="cb7-51"></span>
<span id="cb7-52"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb7-53"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce to mp3 with fluid synth</span></span>
<span id="cb7-54"></span>
<span id="cb7-55">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beat"</span></span>
<span id="cb7-56"></span>
<span id="cb7-57">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb7-58">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb7-59">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb7-60"></span>
<span id="cb7-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb7-62">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 {midi_name}'</span>)</span>
<span id="cb7-63"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb7-64"></span>
<span id="cb7-65"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb7-66">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb7-67"></span>
<span id="cb7-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb7-69"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb7-70">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb7-71">}</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="beat.mp3" type="audio/wav"> </audio></p>
<p>A basic rock beat.</p>
<hr>
<p>Spent some time fiddling with this to see if I can get the beats to sounds like my <a href="https://vpme.de/euclidean-circles/">euclidean circles</a> eurorack module. Whatever I was doing wasnt working, so Im trying some other stuff.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb8-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import midi</span></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># using mario to get the midi headers</span></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># need to add a vanilla midi file to this package for easier importing</span></span>
<span id="cb8-5">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb8-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(mario, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># send objects to global environment</span></span>
<span id="cb8-7"></span>
<span id="cb8-8">bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb8-9">notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span></span>
<span id="cb8-10">ticks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars</span>
<span id="cb8-11"></span>
<span id="cb8-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># empty beat matrix</span></span>
<span id="cb8-13">beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span>notes,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span>ticks)</span>
<span id="cb8-14"></span>
<span id="cb8-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#assign kick beats</span></span>
<span id="cb8-16">kick <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-17">snare <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-18">hihats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-19"></span>
<span id="cb8-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign to matrix</span></span>
<span id="cb8-21">beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,ticks,ticks<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> kick</span>
<span id="cb8-22">beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">38</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,ticks,ticks<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> snare</span>
<span id="cb8-23">beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,ticks,ticks<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> hihats</span>
<span id="cb8-24"></span>
<span id="cb8-25">beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(beat_matrix,</span>
<span id="cb8-26">                     beat_matrix,</span>
<span id="cb8-27">                     beat_matrix,</span>
<span id="cb8-28">                     beat_matrix)</span>
<span id="cb8-29"></span>
<span id="cb8-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transform back to midi</span></span>
<span id="cb8-31">track_0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_midi_df_track</span>(midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb8-32"></span>
<span id="cb8-33">midi_time_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_time</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> beat_matrix,</span>
<span id="cb8-34">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_time_unit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb8-35">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off_length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb8-36"></span>
<span id="cb8-37">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_midi_meta_df</span>(track_0)</span>
<span id="cb8-38"></span>
<span id="cb8-39">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_midi_tempo_meta</span>(meta_messages_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">update_tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>)</span>
<span id="cb8-40"></span>
<span id="cb8-41">split_meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split_meta_df</span>(meta_messages_df)</span>
<span id="cb8-42"></span>
<span id="cb8-43">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_time_df =</span> midi_time_df,</span>
<span id="cb8-44">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_meta_list =</span> split_meta_messages_df,</span>
<span id="cb8-45">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,</span>
<span id="cb8-46">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb8-47"></span>
<span id="cb8-48"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb8-49"></span>
<span id="cb8-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb8-51">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb8-52"></span>
<span id="cb8-53"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb8-54">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beat_2.mid"</span>)</span>
<span id="cb8-55"></span>
<span id="cb8-56"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb8-57"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce to mp3 with fluid synth</span></span>
<span id="cb8-58"></span>
<span id="cb8-59">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beat_2"</span></span>
<span id="cb8-60"></span>
<span id="cb8-61">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb8-62">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb8-63">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb8-64"></span>
<span id="cb8-65"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb8-66">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 {midi_name}'</span>)</span>
<span id="cb8-67"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb8-68"></span>
<span id="cb8-69"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb8-70">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb8-71"></span>
<span id="cb8-72"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb8-73"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb8-74">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb8-75">}</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="beat_2.mp3" type="audio/wav"> </audio></p>
<p>Nice, a little more intrigue, thanks to the euclidean rhythms. I need to spend way more time thinking about better ways to code this. Hmmmso tempting to do one more.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb9-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import midi</span></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># using mario to get the midi headers</span></span>
<span id="cb9-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># need to add a vanilla midi file to this package for easier importing</span></span>
<span id="cb9-5">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb9-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(mario, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># send objects to global environment</span></span>
<span id="cb9-7"></span>
<span id="cb9-8">bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb9-9">notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span></span>
<span id="cb9-10">ticks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars</span>
<span id="cb9-11"></span>
<span id="cb9-12">all_beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span>notes,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span>)</span>
<span id="cb9-13"></span>
<span id="cb9-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>) {</span>
<span id="cb9-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># empty beat matrix</span></span>
<span id="cb9-16">  beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> notes, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> ticks)</span>
<span id="cb9-17">  </span>
<span id="cb9-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#assign kick beats</span></span>
<span id="cb9-19">  kick <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb9-20">  snare <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb9-21">  hihats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb9-22">  </span>
<span id="cb9-23">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign to matrix</span></span>
<span id="cb9-24">  beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ticks, ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> kick</span>
<span id="cb9-25">  beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">38</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ticks, ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> snare</span>
<span id="cb9-26">  beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ticks, ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> hihats</span>
<span id="cb9-27">  </span>
<span id="cb9-28">  all_beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(all_beat_matrix, beat_matrix)</span>
<span id="cb9-29">}</span>
<span id="cb9-30"></span>
<span id="cb9-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transform back to midi</span></span>
<span id="cb9-32">track_0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_midi_df_track</span>(midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb9-33"></span>
<span id="cb9-34">midi_time_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_time</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> all_beat_matrix,</span>
<span id="cb9-35">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_time_unit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb9-36">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off_length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb9-37"></span>
<span id="cb9-38">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_midi_meta_df</span>(track_0)</span>
<span id="cb9-39"></span>
<span id="cb9-40">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_midi_tempo_meta</span>(meta_messages_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">update_tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>)</span>
<span id="cb9-41"></span>
<span id="cb9-42">split_meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split_meta_df</span>(meta_messages_df)</span>
<span id="cb9-43"></span>
<span id="cb9-44">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_time_df =</span> midi_time_df,</span>
<span id="cb9-45">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_meta_list =</span> split_meta_messages_df,</span>
<span id="cb9-46">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,</span>
<span id="cb9-47">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb9-48"></span>
<span id="cb9-49"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb9-50"></span>
<span id="cb9-51"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb9-52">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb9-53"></span>
<span id="cb9-54"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb9-55">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beat_3.mid"</span>)</span>
<span id="cb9-56"></span>
<span id="cb9-57"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb9-58"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce to mp3 with fluid synth</span></span>
<span id="cb9-59"></span>
<span id="cb9-60">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beat_3"</span></span>
<span id="cb9-61"></span>
<span id="cb9-62">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb9-63">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb9-64">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb9-65"></span>
<span id="cb9-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb9-67">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 {midi_name}'</span>)</span>
<span id="cb9-68"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb9-69"></span>
<span id="cb9-70"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb9-71">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb9-72"></span>
<span id="cb9-73"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb9-74"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb9-75">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb9-76">}</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="beat_3.mp3" type="audio/wav"> </audio></p>
<p>Cool, for this one I randomly chose the paramaters for the euclidean sources every bar. Not super groovy, but shows some of the variation you can get from euclidean rhythms. Ill continue to mess with drums some other time.</p>
</section>
<section id="setting-notes-to-euclidean-rhythms" class="level2">
<h2 class="anchored" data-anchor-id="setting-notes-to-euclidean-rhythms">Setting notes to euclidean rhythms</h2>
<p>Before I try any of that information theory stuff, lets see if I can set some notes to the euclidean rhythms.</p>
<p>I have a roundabout strategy to do this and a sense it will blend. Im going to take some inspiration from <a href="https://homophony.quest/blog/37_2_5_24_matrix_analysis/#alternative-note-and-time-feature-generation">this code</a>, that I used to generate new sequences from separate vectors for note probability and time probability.</p>
<ol type="1">
<li>Use euclidean rhythms to generate a bunch of possible time stamps, that should have some mildly OK rhythm.</li>
<li>Get the point estimates for time steps to probabilistically generate rhythm later.</li>
<li>Make a vector of note probabilities</li>
<li>Put them together and listen to it.</li>
</ol>
<p>notes:</p>
<ul>
<li>realizing I dont have a favorite way of picking individual notes</li>
</ul>
<hr>
<p>test for one track 8 bars.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb10-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb10-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tibble)</span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import midi</span></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># using mario to get the midi headers</span></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># need to add a vanilla midi file to this package for easier importing</span></span>
<span id="cb10-7">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb10-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(mario, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># send objects to global environment</span></span>
<span id="cb10-9"></span>
<span id="cb10-10"></span>
<span id="cb10-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sample some beats for timesteps into the matrix</span></span>
<span id="cb10-12">bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb10-13">notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span></span>
<span id="cb10-14">ticks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars</span>
<span id="cb10-15"></span>
<span id="cb10-16">all_beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span>notes,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb10-17"></span>
<span id="cb10-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>) {</span>
<span id="cb10-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># empty beat matrix</span></span>
<span id="cb10-20">  beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> notes, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> ticks)</span>
<span id="cb10-21">  </span>
<span id="cb10-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#assign kick beats</span></span>
<span id="cb10-23">  kick <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb10-24">  snare <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb10-25">  hihats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb10-26">  </span>
<span id="cb10-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign to matrix</span></span>
<span id="cb10-28">  beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ticks, ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> kick</span>
<span id="cb10-29">  beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">38</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ticks, ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> snare</span>
<span id="cb10-30">  beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ticks, ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> hihats</span>
<span id="cb10-31">  </span>
<span id="cb10-32">  all_beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(all_beat_matrix, beat_matrix)</span>
<span id="cb10-33">}</span>
<span id="cb10-34"></span>
<span id="cb10-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the point estimates</span></span>
<span id="cb10-36">time_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(all_beat_matrix)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(all_beat_matrix)</span>
<span id="cb10-37"></span>
<span id="cb10-38">bar_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(time_probabilities,</span>
<span id="cb10-39">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb10-40">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow =</span> T)</span>
<span id="cb10-41"></span>
<span id="cb10-42">bar_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(bar_probabilities)</span>
<span id="cb10-43"></span>
<span id="cb10-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make my own midi notes df</span></span>
<span id="cb10-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add this to midiblender later</span></span>
<span id="cb10-46">midi_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>midi_defs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-47">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-48">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_letter =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strsplit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(note_name),<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>))[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb10-49">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">octave =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strsplit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(note_name),<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>))[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb10-50"></span>
<span id="cb10-51">midi_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(midi_notes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_letter,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>],</span>
<span id="cb10-52">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">octaves =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>],</span>
<span id="cb10-53">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_number =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span></span>
<span id="cb10-54">)</span>
<span id="cb10-55"></span>
<span id="cb10-56">song <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span>notes,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb10-57"></span>
<span id="cb10-58"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># begin bar by bar composition loop</span></span>
<span id="cb10-59"></span>
<span id="cb10-60"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>){</span>
<span id="cb10-61"></span>
<span id="cb10-62">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get some notes to sample from fifths around a starting note</span></span>
<span id="cb10-63">  starting_note <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C4</span></span>
<span id="cb10-64">  fifth_intervals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb10-65">  notes_to_choose <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> starting_note <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> fifth_intervals</span>
<span id="cb10-66">  octave_range <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb10-67">  </span>
<span id="cb10-68">  note_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi_notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-69">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(midi_number <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> notes_to_choose) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-70">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(notes)</span>
<span id="cb10-71">  </span>
<span id="cb10-72">  possible_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi_notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-73">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> note_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb10-74">           octaves <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> octave_range <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb10-75">  </span>
<span id="cb10-76">  possible_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> possible_notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-77">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(possible_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb10-78">  </span>
<span id="cb10-79">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create probability vector</span></span>
<span id="cb10-80">  pitch_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>)</span>
<span id="cb10-81">  pitch_probabilities[possible_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_number <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb10-82">    possible_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>probs</span>
<span id="cb10-83">  </span>
<span id="cb10-84">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get new pitches</span></span>
<span id="cb10-85">  new_pitches <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(pitch_probabilities),</span>
<span id="cb10-86">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>,</span>
<span id="cb10-87">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> pitch_probabilities)</span>
<span id="cb10-88">  new_pitches[new_pitches <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb10-89">  </span>
<span id="cb10-90">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get new times</span></span>
<span id="cb10-91">  new_times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(bar_probabilities),</span>
<span id="cb10-92">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>,</span>
<span id="cb10-93">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> bar_probabilities)</span>
<span id="cb10-94">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># To Do: come back here and make it ok to have more than 1</span></span>
<span id="cb10-95">  new_times[new_times <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb10-96">  </span>
<span id="cb10-97">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get row column ids</span></span>
<span id="cb10-98">  sampled_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(new_pitches <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb10-99">  sampled_times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(new_times <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb10-100">  </span>
<span id="cb10-101">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># combine, make sure equal length</span></span>
<span id="cb10-102">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_notes) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_times)) {</span>
<span id="cb10-103">    sampled_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb10-104">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notes =</span> sampled_notes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_times)],</span>
<span id="cb10-105">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> sampled_times)</span>
<span id="cb10-106">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb10-107">    sampled_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notes =</span> sampled_notes,</span>
<span id="cb10-108">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> sampled_times[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_notes)])</span>
<span id="cb10-109">  }</span>
<span id="cb10-110">  </span>
<span id="cb10-111">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shuffle the notes across the times so the sampling is uniform</span></span>
<span id="cb10-112">  sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>notes)</span>
<span id="cb10-113">  </span>
<span id="cb10-114">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make a note by time unit matrix</span></span>
<span id="cb10-115">  one_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb10-116">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,</span>
<span id="cb10-117">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb10-118">  </span>
<span id="cb10-119">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign 1s to note locations in time</span></span>
<span id="cb10-120">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(sampled_ids)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) {</span>
<span id="cb10-121">    one_bar[sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>notes[i], sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>times[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb10-122">  }</span>
<span id="cb10-123">  </span>
<span id="cb10-124">  song <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(song,one_bar)</span>
<span id="cb10-125">}</span>
<span id="cb10-126"></span>
<span id="cb10-127"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#####################</span></span>
<span id="cb10-128"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transform back to midi</span></span>
<span id="cb10-129">track_0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_midi_df_track</span>(midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb10-130"></span>
<span id="cb10-131">midi_time_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_time</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> song,</span>
<span id="cb10-132">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_time_unit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb10-133">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off_length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>)</span>
<span id="cb10-134"></span>
<span id="cb10-135">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_midi_meta_df</span>(track_0)</span>
<span id="cb10-136"></span>
<span id="cb10-137">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_midi_tempo_meta</span>(meta_messages_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">update_tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>)</span>
<span id="cb10-138"></span>
<span id="cb10-139">split_meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split_meta_df</span>(meta_messages_df)</span>
<span id="cb10-140"></span>
<span id="cb10-141">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_time_df =</span> midi_time_df,</span>
<span id="cb10-142">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_meta_list =</span> split_meta_messages_df,</span>
<span id="cb10-143">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb10-144">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb10-145"></span>
<span id="cb10-146"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb10-147"></span>
<span id="cb10-148"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb10-149">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb10-150"></span>
<span id="cb10-151"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb10-152">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fifths.mid"</span>)</span>
<span id="cb10-153"></span>
<span id="cb10-154"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb10-155"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce to mp3 with fluid synth</span></span>
<span id="cb10-156"></span>
<span id="cb10-157">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fifths"</span></span>
<span id="cb10-158"></span>
<span id="cb10-159">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb10-160">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb10-161">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb10-162"></span>
<span id="cb10-163"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb10-164">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 {midi_name}'</span>)</span>
<span id="cb10-165"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb10-166"></span>
<span id="cb10-167"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb10-168">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb10-169"></span>
<span id="cb10-170"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb10-171"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb10-172">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb10-173">}</span></code></pre></div>
</details>
</div>
<p>That worked, but its sounds like piano popcorn. Not worth sharing.</p>
<hr>
<p>Ive increased number of loops here for multiple tracks. Each track has different note densities. The results are almost listenable, even more so if I put the midi tracks into ableton and give them some more interesting synth voices.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb11-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb11-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tibble)</span>
<span id="cb11-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import midi</span></span>
<span id="cb11-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># using mario to get the midi headers</span></span>
<span id="cb11-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># need to add a vanilla midi file to this package for easier importing</span></span>
<span id="cb11-7">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb11-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(mario, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># send objects to global environment</span></span>
<span id="cb11-9"></span>
<span id="cb11-10"></span>
<span id="cb11-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sample some beats for timesteps into the matrix</span></span>
<span id="cb11-12">bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb11-13">notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span></span>
<span id="cb11-14">ticks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars</span>
<span id="cb11-15"></span>
<span id="cb11-16">all_beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span>notes,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb11-17"></span>
<span id="cb11-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>) {</span>
<span id="cb11-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># empty beat matrix</span></span>
<span id="cb11-20">  beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> notes, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> ticks)</span>
<span id="cb11-21">  </span>
<span id="cb11-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#assign kick beats</span></span>
<span id="cb11-23">  kick <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb11-24">  snare <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb11-25">  hihats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb11-26">  </span>
<span id="cb11-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign to matrix</span></span>
<span id="cb11-28">  beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ticks, ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> kick</span>
<span id="cb11-29">  beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">38</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ticks, ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> snare</span>
<span id="cb11-30">  beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ticks, ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> hihats</span>
<span id="cb11-31">  </span>
<span id="cb11-32">  all_beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(all_beat_matrix, beat_matrix)</span>
<span id="cb11-33">}</span>
<span id="cb11-34"></span>
<span id="cb11-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the point estimates</span></span>
<span id="cb11-36">time_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(all_beat_matrix)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(all_beat_matrix)</span>
<span id="cb11-37"></span>
<span id="cb11-38">bar_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(time_probabilities,</span>
<span id="cb11-39">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb11-40">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow =</span> T)</span>
<span id="cb11-41"></span>
<span id="cb11-42">bar_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(bar_probabilities)</span>
<span id="cb11-43"></span>
<span id="cb11-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make my own midi notes df</span></span>
<span id="cb11-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add this to midiblender later</span></span>
<span id="cb11-46">midi_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>midi_defs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-47">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-48">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_letter =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strsplit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(note_name),<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>))[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb11-49">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">octave =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strsplit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(note_name),<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>))[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb11-50"></span>
<span id="cb11-51">midi_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(midi_notes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_letter,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>],</span>
<span id="cb11-52">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">octaves =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>],</span>
<span id="cb11-53">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_number =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span></span>
<span id="cb11-54">)</span>
<span id="cb11-55"></span>
<span id="cb11-56">all_track_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>()</span>
<span id="cb11-57"></span>
<span id="cb11-58">time_densities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>)</span>
<span id="cb11-59"></span>
<span id="cb11-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># track loop</span></span>
<span id="cb11-61"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(t <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>){</span>
<span id="cb11-62"></span>
<span id="cb11-63">song <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span>notes,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb11-64"></span>
<span id="cb11-65"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># begin bar by bar composition loop</span></span>
<span id="cb11-66"></span>
<span id="cb11-67"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>){</span>
<span id="cb11-68"></span>
<span id="cb11-69">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get some notes to sample from fifths around a starting note</span></span>
<span id="cb11-70">  starting_note <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C4</span></span>
<span id="cb11-71">  fifth_intervals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb11-72">  notes_to_choose <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> starting_note <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> fifth_intervals</span>
<span id="cb11-73">  octave_range <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span></span>
<span id="cb11-74">  </span>
<span id="cb11-75">  note_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi_notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-76">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(midi_number <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> notes_to_choose) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-77">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(notes)</span>
<span id="cb11-78">  </span>
<span id="cb11-79">  possible_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi_notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-80">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> note_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb11-81">           octaves <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> octave_range <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb11-82">  </span>
<span id="cb11-83">  possible_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> possible_notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-84">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(possible_notes)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb11-85">  </span>
<span id="cb11-86">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create probability vector</span></span>
<span id="cb11-87">  pitch_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>)</span>
<span id="cb11-88">  pitch_probabilities[possible_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_number <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb11-89">    possible_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>probs</span>
<span id="cb11-90">  </span>
<span id="cb11-91">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get new pitches</span></span>
<span id="cb11-92">  new_pitches <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(pitch_probabilities),</span>
<span id="cb11-93">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>,</span>
<span id="cb11-94">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> pitch_probabilities)</span>
<span id="cb11-95">  new_pitches[new_pitches <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb11-96">  </span>
<span id="cb11-97">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get new times</span></span>
<span id="cb11-98">  new_times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(bar_probabilities),</span>
<span id="cb11-99">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> time_densities[t],</span>
<span id="cb11-100">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> bar_probabilities)</span>
<span id="cb11-101">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># To Do: come back here and make it ok to have more than 1</span></span>
<span id="cb11-102">  new_times[new_times <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb11-103">  </span>
<span id="cb11-104">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get row column ids</span></span>
<span id="cb11-105">  sampled_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(new_pitches <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb11-106">  sampled_times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(new_times <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb11-107">  </span>
<span id="cb11-108">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># combine, make sure equal length</span></span>
<span id="cb11-109">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_notes) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_times)) {</span>
<span id="cb11-110">    sampled_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb11-111">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notes =</span> sampled_notes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_times)],</span>
<span id="cb11-112">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> sampled_times)</span>
<span id="cb11-113">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb11-114">    sampled_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notes =</span> sampled_notes,</span>
<span id="cb11-115">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> sampled_times[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_notes)])</span>
<span id="cb11-116">  }</span>
<span id="cb11-117">  </span>
<span id="cb11-118">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shuffle the notes across the times so the sampling is uniform</span></span>
<span id="cb11-119">  sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>notes)</span>
<span id="cb11-120">  </span>
<span id="cb11-121">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make a note by time unit matrix</span></span>
<span id="cb11-122">  one_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb11-123">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,</span>
<span id="cb11-124">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb11-125">  </span>
<span id="cb11-126">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign 1s to note locations in time</span></span>
<span id="cb11-127">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (r <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(sampled_ids)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) {</span>
<span id="cb11-128">    one_bar[sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>notes[r], sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>times[r]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb11-129">  }</span>
<span id="cb11-130">  </span>
<span id="cb11-131">  song <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(song,one_bar)</span>
<span id="cb11-132">}</span>
<span id="cb11-133"></span>
<span id="cb11-134"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#####################</span></span>
<span id="cb11-135"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transform back to midi</span></span>
<span id="cb11-136">track_0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_midi_df_track</span>(midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb11-137"></span>
<span id="cb11-138">midi_time_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_time</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> song,</span>
<span id="cb11-139">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_time_unit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb11-140">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off_length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>)</span>
<span id="cb11-141"></span>
<span id="cb11-142">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_midi_meta_df</span>(track_0)</span>
<span id="cb11-143"></span>
<span id="cb11-144">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_midi_tempo_meta</span>(meta_messages_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">update_tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>)</span>
<span id="cb11-145"></span>
<span id="cb11-146">split_meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split_meta_df</span>(meta_messages_df)</span>
<span id="cb11-147"></span>
<span id="cb11-148">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_time_df =</span> midi_time_df,</span>
<span id="cb11-149">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_meta_list =</span> split_meta_messages_df,</span>
<span id="cb11-150">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb11-151">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb11-152">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> new_midi_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb11-153">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> t)</span>
<span id="cb11-154"></span>
<span id="cb11-155">all_track_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(all_track_midi,</span>
<span id="cb11-156">                        new_midi_df)</span>
<span id="cb11-157">}</span>
<span id="cb11-158"></span>
<span id="cb11-159"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb11-160"></span>
<span id="cb11-161"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb11-162">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(all_track_midi)</span>
<span id="cb11-163"></span>
<span id="cb11-164"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb11-165">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fifths_tracks.mid"</span>)</span>
<span id="cb11-166"></span>
<span id="cb11-167"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb11-168"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce to mp3 with fluid synth</span></span>
<span id="cb11-169"></span>
<span id="cb11-170">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fifths"</span></span>
<span id="cb11-171"></span>
<span id="cb11-172">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb11-173">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb11-174">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb11-175"></span>
<span id="cb11-176"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb11-177">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 {midi_name}'</span>)</span>
<span id="cb11-178"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb11-179"></span>
<span id="cb11-180"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb11-181">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb11-182"></span>
<span id="cb11-183"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb11-184"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb11-185">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb11-186">}</span></code></pre></div>
</details>
</div>
<p>This was fun, even if my eyes are bleeding from the wall of code. I put the three tracks generated here into Ableton, assigned them some synth voices, added a couple drum beats, slowed down the tempo, and it sounds like this:</p>
<p><strong>This one is louder than the others, not super loud, but louder</strong></p>
<p><audio controls=""> <source src="fifths_3_track.mp3" type="audio/wav"> </audio></p>
<p>I didnt get to all of my goals. I still need to come back and change the probability of different notes so they arent uniform. Right now all the pitches were uniformly sampled each time. The result is OK, but I want to hear other versions sampled from non-uniform distributions.</p>
<p>At this point I think Ive basically recreated something like what Marbles by Mutable Instruments is doing. I could have probably done this in eurorack. And, that would have been fun too.</p>
<p>Time to take a break.</p>
<section id="pseudo-composition-code" class="level3">
<h3 class="anchored" data-anchor-id="pseudo-composition-code">Pseudo Composition code</h3>
<p>The above is what I would consider my first attempt at composing generative sequences in R. Taking a couple minutes here to write pseudo code on what it was that happened in the code.</p>
<ol type="1">
<li>Import a MIDI file</li>
<li>Run euclidean rhythms into a matrix for a while to get point estimates for rhythm time steps. Turn this into a vector of time probabilities.</li>
<li>Begin a Track Composition loop</li>
</ol>
<ul>
<li>Loop for each of 3 tracks
<ul>
<li>Begin a Bar composition Loop
<ul>
<li>Loop for 16 bars</li>
<li>pick a collection of notes</li>
<li>assign probability of occurrence</li>
<li>generate time stamps, and notes from time and note probability vectors</li>
<li>Combine them together</li>
<li>put them in a one_bar matrix</li>
</ul></li>
<li>put all the bars into a midi_df, setting i_track to the track number</li>
</ul></li>
</ul>
<p>It was helpful to summarize the code this morning. Its unlikely I will begin any re-factoring, but its easier to see where I could make this more compact and less of a wall of code.</p>
<hr>
</section>
</section>
<section id="randomly-sampling-note-probability-distributions" class="level2">
<h2 class="anchored" data-anchor-id="randomly-sampling-note-probability-distributions">Randomly sampling note probability distributions</h2>
<p>The above code samples notes from some collection, like {C, F, G, Bb, D} with equal proportion. Id like to at least start with making the proportions unequal, and have this move around a bit over bars. Whatever note has the highest proportion might take on the tonal center of the evolving sequence.</p>
<p>A next step would be to expand and contract the note collection, and have it rotate around the circle of fifths.</p>
<p>This seems to work. Im grabbing a colleciton of notes, using a simple vector, like 1,2,3,4,5, to set note frequencies. That can be multiplied to change the ratio of most to least frequent. The frequency vector is converted to a probability vector later. Every bar, the ordering of the probalities as they apply to notes is randomized. That could be too fast moving to really notice differences. Need to explore this a little bit.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb12-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb12-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tibble)</span>
<span id="cb12-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import midi</span></span>
<span id="cb12-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># using mario to get the midi headers</span></span>
<span id="cb12-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># need to add a vanilla midi file to this package for easier importing</span></span>
<span id="cb12-7">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb12-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(mario, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># send objects to global environment</span></span>
<span id="cb12-9"></span>
<span id="cb12-10"></span>
<span id="cb12-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sample some beats for timesteps into the matrix</span></span>
<span id="cb12-12">bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb12-13">notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span></span>
<span id="cb12-14">ticks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars</span>
<span id="cb12-15"></span>
<span id="cb12-16">all_beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span>notes,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb12-17"></span>
<span id="cb12-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>) {</span>
<span id="cb12-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># empty beat matrix</span></span>
<span id="cb12-20">  beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> notes, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> ticks)</span>
<span id="cb12-21">  </span>
<span id="cb12-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#assign kick beats</span></span>
<span id="cb12-23">  kick <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb12-24">  snare <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb12-25">  hihats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb12-26">  </span>
<span id="cb12-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign to matrix</span></span>
<span id="cb12-28">  beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ticks, ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> kick</span>
<span id="cb12-29">  beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">38</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ticks, ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> snare</span>
<span id="cb12-30">  beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ticks, ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> hihats</span>
<span id="cb12-31">  </span>
<span id="cb12-32">  all_beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(all_beat_matrix, beat_matrix)</span>
<span id="cb12-33">}</span>
<span id="cb12-34"></span>
<span id="cb12-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the point estimates</span></span>
<span id="cb12-36">time_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(all_beat_matrix)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(all_beat_matrix)</span>
<span id="cb12-37"></span>
<span id="cb12-38">bar_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(time_probabilities,</span>
<span id="cb12-39">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb12-40">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow =</span> T)</span>
<span id="cb12-41"></span>
<span id="cb12-42">bar_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(bar_probabilities)</span>
<span id="cb12-43"></span>
<span id="cb12-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make my own midi notes df</span></span>
<span id="cb12-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add this to midiblender later</span></span>
<span id="cb12-46">midi_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>midi_defs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-47">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-48">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_letter =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strsplit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(note_name),<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>))[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb12-49">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">octave =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strsplit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(note_name),<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>))[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb12-50"></span>
<span id="cb12-51">midi_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(midi_notes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_letter,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>],</span>
<span id="cb12-52">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">octaves =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>],</span>
<span id="cb12-53">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_number =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span></span>
<span id="cb12-54">)</span>
<span id="cb12-55"></span>
<span id="cb12-56"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Empty data frame to hold midi track dfs</span></span>
<span id="cb12-57">all_track_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>()</span>
<span id="cb12-58"></span>
<span id="cb12-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># paramaters that get changed for every track</span></span>
<span id="cb12-60"></span>
<span id="cb12-61">time_densities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># controls number of notes per bar </span></span>
<span id="cb12-62"></span>
<span id="cb12-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># track loop</span></span>
<span id="cb12-64"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(t <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>){</span>
<span id="cb12-65"></span>
<span id="cb12-66">song <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span>notes,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb12-67"></span>
<span id="cb12-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># begin bar by bar composition loop</span></span>
<span id="cb12-69"></span>
<span id="cb12-70"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>){</span>
<span id="cb12-71"></span>
<span id="cb12-72">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get some notes to sample from fifths around a starting note</span></span>
<span id="cb12-73">  starting_note <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C4</span></span>
<span id="cb12-74">  fifth_intervals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb12-75">  notes_to_choose <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> starting_note <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> fifth_intervals</span>
<span id="cb12-76">  octave_range <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span></span>
<span id="cb12-77">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># starting to bias note sampling here</span></span>
<span id="cb12-78">  note_frequencies <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(fifth_intervals)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) </span>
<span id="cb12-79">  </span>
<span id="cb12-80">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pair the frequencies with the notes</span></span>
<span id="cb12-81">  note_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi_notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-82">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(midi_number <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> notes_to_choose) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-83">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(notes) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-84">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_frequencies =</span> note_frequencies)</span>
<span id="cb12-85">  </span>
<span id="cb12-86">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get all possible notes across octaves in collection</span></span>
<span id="cb12-87">  possible_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi_notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-88">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> note_names<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb12-89">           octaves <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> octave_range <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-90">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add note frequencies</span></span>
<span id="cb12-91">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(note_names,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"notes"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-92">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> note_frequencies<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(note_frequencies))</span>
<span id="cb12-93">  </span>
<span id="cb12-94">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create probability vector</span></span>
<span id="cb12-95">  pitch_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>)</span>
<span id="cb12-96">  pitch_probabilities[possible_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_number <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb12-97">    possible_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>probs</span>
<span id="cb12-98">  </span>
<span id="cb12-99">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get new pitches</span></span>
<span id="cb12-100">  new_pitches <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(pitch_probabilities),</span>
<span id="cb12-101">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>,</span>
<span id="cb12-102">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> pitch_probabilities)</span>
<span id="cb12-103">  new_pitches[new_pitches <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb12-104">  </span>
<span id="cb12-105">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get new times</span></span>
<span id="cb12-106">  new_times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(bar_probabilities),</span>
<span id="cb12-107">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> time_densities[t],</span>
<span id="cb12-108">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> bar_probabilities)</span>
<span id="cb12-109">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># To Do: come back here and make it ok to have more than 1</span></span>
<span id="cb12-110">  new_times[new_times <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb12-111">  </span>
<span id="cb12-112">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get row column ids</span></span>
<span id="cb12-113">  sampled_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(new_pitches <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb12-114">  sampled_times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(new_times <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb12-115">  </span>
<span id="cb12-116">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># combine, make sure equal length</span></span>
<span id="cb12-117">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_notes) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_times)) {</span>
<span id="cb12-118">    sampled_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb12-119">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notes =</span> sampled_notes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_times)],</span>
<span id="cb12-120">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> sampled_times)</span>
<span id="cb12-121">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb12-122">    sampled_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notes =</span> sampled_notes,</span>
<span id="cb12-123">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> sampled_times[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_notes)])</span>
<span id="cb12-124">  }</span>
<span id="cb12-125">  </span>
<span id="cb12-126">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shuffle the notes across the times so the sampling is uniform</span></span>
<span id="cb12-127">  sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>notes)</span>
<span id="cb12-128">  </span>
<span id="cb12-129">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make a note by time unit matrix</span></span>
<span id="cb12-130">  one_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb12-131">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,</span>
<span id="cb12-132">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb12-133">  </span>
<span id="cb12-134">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign 1s to note locations in time</span></span>
<span id="cb12-135">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (r <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(sampled_ids)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) {</span>
<span id="cb12-136">    one_bar[sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>notes[r], sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>times[r]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb12-137">  }</span>
<span id="cb12-138">  </span>
<span id="cb12-139">  song <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(song,one_bar)</span>
<span id="cb12-140">}</span>
<span id="cb12-141"></span>
<span id="cb12-142"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#####################</span></span>
<span id="cb12-143"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transform back to midi</span></span>
<span id="cb12-144">track_0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_midi_df_track</span>(midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb12-145"></span>
<span id="cb12-146">midi_time_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_time</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> song,</span>
<span id="cb12-147">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_time_unit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb12-148">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off_length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>)</span>
<span id="cb12-149"></span>
<span id="cb12-150">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_midi_meta_df</span>(track_0)</span>
<span id="cb12-151"></span>
<span id="cb12-152">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_midi_tempo_meta</span>(meta_messages_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">update_tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>)</span>
<span id="cb12-153"></span>
<span id="cb12-154">split_meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split_meta_df</span>(meta_messages_df)</span>
<span id="cb12-155"></span>
<span id="cb12-156">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_time_df =</span> midi_time_df,</span>
<span id="cb12-157">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_meta_list =</span> split_meta_messages_df,</span>
<span id="cb12-158">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb12-159">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb12-160">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> new_midi_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb12-161">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> t)</span>
<span id="cb12-162"></span>
<span id="cb12-163">all_track_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(all_track_midi,</span>
<span id="cb12-164">                        new_midi_df)</span>
<span id="cb12-165">}</span>
<span id="cb12-166"></span>
<span id="cb12-167"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb12-168"></span>
<span id="cb12-169"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb12-170">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(all_track_midi)</span>
<span id="cb12-171"></span>
<span id="cb12-172"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb12-173">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fifths_tracks_prob.mid"</span>)</span>
<span id="cb12-174"></span>
<span id="cb12-175"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">######</span></span>
<span id="cb12-176"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># using Ableton for sounds</span></span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="fifths_3_track_prob_1.mp3" type="audio/wav"> </audio></p>
<p>At some point I put three tracks into Ableton and chose some synth voices.</p>
</section>
<section id="expandingreducing-the-note-collection" class="level2">
<h2 class="anchored" data-anchor-id="expandingreducing-the-note-collection">Expanding/reducing the note collection</h2>
<p>Increased the number of tracks to 4. Every bar the number of notes that can get sampled is randomly varied from a collection of notes around the circle of fifths. I didnt yet get the composition spinning around the circle, but Im skipping that for now.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb13-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb13-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tibble)</span>
<span id="cb13-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import midi</span></span>
<span id="cb13-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># using mario to get the midi headers</span></span>
<span id="cb13-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># need to add a vanilla midi file to this package for easier importing</span></span>
<span id="cb13-7">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb13-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(mario, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># send objects to global environment</span></span>
<span id="cb13-9"></span>
<span id="cb13-10"></span>
<span id="cb13-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sample some beats for timesteps into the matrix</span></span>
<span id="cb13-12">bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb13-13">notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span></span>
<span id="cb13-14">ticks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>bars</span>
<span id="cb13-15"></span>
<span id="cb13-16">all_beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span>notes,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb13-17"></span>
<span id="cb13-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>) {</span>
<span id="cb13-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># empty beat matrix</span></span>
<span id="cb13-20">  beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> notes, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> ticks)</span>
<span id="cb13-21">  </span>
<span id="cb13-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#assign kick beats</span></span>
<span id="cb13-23">  kick <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb13-24">  snare <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb13-25">  hihats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bresenham_euclidean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb13-26">  </span>
<span id="cb13-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign to matrix</span></span>
<span id="cb13-28">  beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ticks, ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> kick</span>
<span id="cb13-29">  beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">38</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ticks, ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> snare</span>
<span id="cb13-30">  beat_matrix[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ticks, ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> hihats</span>
<span id="cb13-31">  </span>
<span id="cb13-32">  all_beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(all_beat_matrix, beat_matrix)</span>
<span id="cb13-33">}</span>
<span id="cb13-34"></span>
<span id="cb13-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the point estimates</span></span>
<span id="cb13-36">time_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(all_beat_matrix)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(all_beat_matrix)</span>
<span id="cb13-37"></span>
<span id="cb13-38">bar_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(time_probabilities,</span>
<span id="cb13-39">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb13-40">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow =</span> T)</span>
<span id="cb13-41"></span>
<span id="cb13-42">bar_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(bar_probabilities)</span>
<span id="cb13-43"></span>
<span id="cb13-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make my own midi notes df</span></span>
<span id="cb13-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add this to midiblender later</span></span>
<span id="cb13-46">midi_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>midi_defs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb13-47">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowwise</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb13-48">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_letter =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strsplit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(note_name),<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>))[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb13-49">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">octave =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strsplit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(note_name),<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>))[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb13-50"></span>
<span id="cb13-51">midi_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(midi_notes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_letter,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>],</span>
<span id="cb13-52">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">octaves =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>],</span>
<span id="cb13-53">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_number =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span></span>
<span id="cb13-54">)</span>
<span id="cb13-55"></span>
<span id="cb13-56"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Empty data frame to hold midi track dfs</span></span>
<span id="cb13-57">all_track_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>()</span>
<span id="cb13-58"></span>
<span id="cb13-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># paramaters that get changed for every track</span></span>
<span id="cb13-60"></span>
<span id="cb13-61">time_densities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">512</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># controls number of notes per bar </span></span>
<span id="cb13-62"></span>
<span id="cb13-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># track loop</span></span>
<span id="cb13-64"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(t <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>){</span>
<span id="cb13-65"></span>
<span id="cb13-66">song <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span>notes,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb13-67"></span>
<span id="cb13-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># begin bar by bar composition loop</span></span>
<span id="cb13-69"></span>
<span id="cb13-70"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>){</span>
<span id="cb13-71"></span>
<span id="cb13-72">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get some notes to sample from fifths around a starting note</span></span>
<span id="cb13-73">  starting_note <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C4</span></span>
<span id="cb13-74">  fifth_intervals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span>)</span>
<span id="cb13-75">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># size of collection now changes every bar</span></span>
<span id="cb13-76">  notes_to_choose <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> starting_note <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(fifth_intervals,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb13-77">  octave_range <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span></span>
<span id="cb13-78">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># starting to bias note sampling here</span></span>
<span id="cb13-79">  note_frequencies <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(notes_to_choose)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) </span>
<span id="cb13-80">  </span>
<span id="cb13-81">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pair the frequencies with the notes</span></span>
<span id="cb13-82">  note_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi_notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb13-83">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(midi_number <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> notes_to_choose) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb13-84">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(notes) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb13-85">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_frequencies =</span> note_frequencies)</span>
<span id="cb13-86">  </span>
<span id="cb13-87">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get all possible notes across octaves in collection</span></span>
<span id="cb13-88">  possible_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi_notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb13-89">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> note_names<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb13-90">           octaves <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> octave_range <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb13-91">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add note frequencies</span></span>
<span id="cb13-92">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(note_names,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"notes"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb13-93">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> note_frequencies<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(note_frequencies))</span>
<span id="cb13-94">  </span>
<span id="cb13-95">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create probability vector</span></span>
<span id="cb13-96">  pitch_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>)</span>
<span id="cb13-97">  pitch_probabilities[possible_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_number <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb13-98">    possible_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>probs</span>
<span id="cb13-99">  </span>
<span id="cb13-100">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get new pitches</span></span>
<span id="cb13-101">  new_pitches <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(pitch_probabilities),</span>
<span id="cb13-102">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>,</span>
<span id="cb13-103">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> pitch_probabilities)</span>
<span id="cb13-104">  new_pitches[new_pitches <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb13-105">  </span>
<span id="cb13-106">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get new times</span></span>
<span id="cb13-107">  new_times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(bar_probabilities),</span>
<span id="cb13-108">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> time_densities[t],</span>
<span id="cb13-109">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> bar_probabilities)</span>
<span id="cb13-110">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># To Do: come back here and make it ok to have more than 1</span></span>
<span id="cb13-111">  new_times[new_times <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb13-112">  </span>
<span id="cb13-113">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make a note by time unit matrix</span></span>
<span id="cb13-114">    one_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb13-115">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,</span>
<span id="cb13-116">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb13-117">  </span>
<span id="cb13-118">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(new_times) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>){</span>
<span id="cb13-119">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get row column ids</span></span>
<span id="cb13-120">    sampled_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(new_pitches <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb13-121">    sampled_times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(new_times <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb13-122">    </span>
<span id="cb13-123">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># combine, make sure equal length</span></span>
<span id="cb13-124">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_notes) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_times)) {</span>
<span id="cb13-125">      sampled_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb13-126">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notes =</span> sampled_notes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_times)],</span>
<span id="cb13-127">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> sampled_times)</span>
<span id="cb13-128">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb13-129">      sampled_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notes =</span> sampled_notes,</span>
<span id="cb13-130">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> sampled_times[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_notes)])</span>
<span id="cb13-131">    }</span>
<span id="cb13-132">    </span>
<span id="cb13-133">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shuffle the notes across the times so the sampling is uniform</span></span>
<span id="cb13-134">    sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>notes)</span>
<span id="cb13-135">    </span>
<span id="cb13-136">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign 1s to note locations in time</span></span>
<span id="cb13-137">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (r <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(sampled_ids)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) {</span>
<span id="cb13-138">      one_bar[sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>notes[r], sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>times[r]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb13-139">    }</span>
<span id="cb13-140">  }</span>
<span id="cb13-141">  </span>
<span id="cb13-142">  song <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(song,one_bar)</span>
<span id="cb13-143">}</span>
<span id="cb13-144"></span>
<span id="cb13-145"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#####################</span></span>
<span id="cb13-146"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transform back to midi</span></span>
<span id="cb13-147">track_0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_midi_df_track</span>(midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb13-148"></span>
<span id="cb13-149">midi_time_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_time</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> song,</span>
<span id="cb13-150">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_time_unit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb13-151">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off_length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>)</span>
<span id="cb13-152"></span>
<span id="cb13-153">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_midi_meta_df</span>(track_0)</span>
<span id="cb13-154"></span>
<span id="cb13-155">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_midi_tempo_meta</span>(meta_messages_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">update_tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>)</span>
<span id="cb13-156"></span>
<span id="cb13-157">split_meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split_meta_df</span>(meta_messages_df)</span>
<span id="cb13-158"></span>
<span id="cb13-159">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_time_df =</span> midi_time_df,</span>
<span id="cb13-160">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_meta_list =</span> split_meta_messages_df,</span>
<span id="cb13-161">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb13-162">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb13-163">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> new_midi_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb13-164">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> t)</span>
<span id="cb13-165"></span>
<span id="cb13-166">all_track_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(all_track_midi,</span>
<span id="cb13-167">                        new_midi_df)</span>
<span id="cb13-168">}</span>
<span id="cb13-169"></span>
<span id="cb13-170"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb13-171"></span>
<span id="cb13-172"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb13-173">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(all_track_midi)</span>
<span id="cb13-174"></span>
<span id="cb13-175"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb13-176">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fifths_4_tracks_prob_2.mid"</span>)</span>
<span id="cb13-177"></span>
<span id="cb13-178"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">######</span></span>
<span id="cb13-179"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># using Ableton for sounds</span></span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="fifths_4_track_prob_2.mp3" type="audio/wav"> </audio></p>
<p>This one is again using ableton for sounds, with a little bit more care taken to make it sound mildly interesting. Had fun. Still sounds like halting robot music that drones on without much change in direction.</p>
<p>Alright, finished here for now.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-toussaint2005" class="csl-entry">
Toussaint, Godfried. 2005. <span>The Euclidean Algorithm Generates Traditional Musical Rhythms.</span> In, 4756. <a href="https://archive.bridgesmathart.org/2005/bridges2005-47.html">https://archive.bridgesmathart.org/2005/bridges2005-47.html</a>.
</div>
</div></section></div> ]]></description>
  <category>midiblender</category>
  <category>euclidean rhythms</category>
  <category>information theory</category>
  <guid>https://homophony.quest/blog/44_2_10_24_euclid/</guid>
  <pubDate>Sat, 10 Feb 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/44_2_10_24_euclid/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Turning up the randomness to 11 for MAXIMUM MIDI MADNESS</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/43_2_9_24_max_random/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Random MIDI randomness. Explosive torrent of musical notes. Exploding the universe of music. Music everywhere. Neon super colorful sonic cartoon."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/43_2_9_24_max_random/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>Random MIDI randomness. Explosive torrent of musical notes. Exploding the universe of music. Music everywhere. Neon super colorful sonic cartoon. - dreamshaper</p>
</div></div><div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Some of the audio is loud, be careful with volume. MIDI was mangled.</p>
</div>
</div>
<p>If Im going to mangle MIDI, I should at least stuff it with as many notes from a uniform distribution as I care to.</p>
<p>I will now attempt to randomize the pancakes out of a MIDI file until they splatter into a polyphonic volcano of mangled bliss (thats the dream scenario).</p>
<p>According to some quick research, it seems that fluid synth (that Im using to quickly render MIDI files with premium cheese factor) has at least 128 voices of polyphony, which is enough to play all of the midi notes at the same timepotentially all in randomized voices.</p>
<p>Heres the plan. Will it blend? I dont know. Im pretty sure the first part of the plan will blend quickly.</p>
<ol type="1">
<li>Create a piano roll matrix with 128 rows and enough columns of midi ticks for 30 seconds.</li>
<li>Completely randomize note occurrence across the whole matrix, such that any note could occur in any time point.</li>
<li>Increase the note density so that there is a lot of notes being randomly generatedmaybe not all the way to 128 notes per tick, that seems too extreme (but what does that sound like !?!).</li>
<li>Bump this super fat rando matrix out to a midi file.</li>
<li>For the easy win, render it via fluid synth and listen to it.</li>
<li>Maybe this will be easy too, but Id like to randomize the synth voice for each note in the matrix. Im not sure how straight forward this part iswill find out. Update, I didnt do that part, saving for another day.</li>
</ol>
<p>Let the abomination begin.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi</span></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#using mario to get the midi headers</span></span>
<span id="cb2-5">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb2-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(mario, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># send objects to global environment</span></span>
<span id="cb2-7"></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert midi to matrix</span></span>
<span id="cb2-9">n_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span></span>
<span id="cb2-10">n_ticks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#15 bars at 120BPM of this should be enough</span></span>
<span id="cb2-11"></span>
<span id="cb2-12">feature_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,n_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>n_ticks)</span>
<span id="cb2-13">prob_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> feature_vector<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(feature_vector)</span>
<span id="cb2-14"></span>
<span id="cb2-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ensures uniform sampling of notes into tick intervals</span></span>
<span id="cb2-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of notes is approximately  = density</span></span>
<span id="cb2-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># my note density goes to 1100</span></span>
<span id="cb2-18">rando_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midiblender<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_features_from_probs</span>(prob_vector,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">density =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1100</span>)</span>
<span id="cb2-19"></span>
<span id="cb2-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert back piano roll matrix</span></span>
<span id="cb2-21">rando_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">feature_vector_to_matrix</span>(rando_vector, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_notes=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>)</span>
<span id="cb2-22"></span>
<span id="cb2-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############</span></span>
<span id="cb2-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># turn it back into midi and render to mp3</span></span>
<span id="cb2-25"></span>
<span id="cb2-26">track_0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_midi_df_track</span>(midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-27"></span>
<span id="cb2-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transform back to midi</span></span>
<span id="cb2-29">midi_time_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_time</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> rando_matrix,</span>
<span id="cb2-30">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_time_unit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb2-31">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off_length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb2-32"></span>
<span id="cb2-33">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_midi_meta_df</span>(track_0)</span>
<span id="cb2-34"></span>
<span id="cb2-35">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_midi_tempo_meta</span>(meta_messages_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">update_tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>)</span>
<span id="cb2-36"></span>
<span id="cb2-37">split_meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split_meta_df</span>(meta_messages_df)</span>
<span id="cb2-38"></span>
<span id="cb2-39">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_time_df =</span> midi_time_df,</span>
<span id="cb2-40">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_meta_list =</span> split_meta_messages_df,</span>
<span id="cb2-41">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb2-42">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb2-43"></span>
<span id="cb2-44"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb2-45"></span>
<span id="cb2-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb2-47">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb2-48"></span>
<span id="cb2-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb2-50">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rando_1100.mid"</span>)</span>
<span id="cb2-51"></span>
<span id="cb2-52"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb2-53"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce to mp3 with fluid synth</span></span>
<span id="cb2-54"></span>
<span id="cb2-55">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rando_1100"</span></span>
<span id="cb2-56"></span>
<span id="cb2-57">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb2-58">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb2-59">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb2-60"></span>
<span id="cb2-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb2-62">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/nintendo_soundfont.sf2 {midi_name}'</span>)</span>
<span id="cb2-63"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb2-64"></span>
<span id="cb2-65"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb2-66">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb2-67"></span>
<span id="cb2-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb2-69"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb2-70">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb2-71">}</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="rando_1100.mp3" type="audio/wav"> </audio></p>
<p>I used a nintendo sound font sound here. Its nice and random, too pretty though. Not nearly enough notes.</p>
<p>There are 128 possible notes and 15 bars. Each bar has four beats of 96 ticks. In total, there is 128 x 96 x 4 x 15 = 737280 cells where a note could be. I sampled about 1100 notes uniformly into those cells. Thats just not enough.</p>
<p>It should at least go to 11 percent, or about 81000 notes in 30 seconds. That seems like so manyoooooeeee.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi</span></span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#using mario to get the midi headers</span></span>
<span id="cb3-3">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb3-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(mario, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># send objects to global environment</span></span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert midi to matrix</span></span>
<span id="cb3-7">n_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span></span>
<span id="cb3-8">n_ticks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#15 bars at 120BPM of this should be enough</span></span>
<span id="cb3-9"></span>
<span id="cb3-10">feature_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,n_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>n_ticks)</span>
<span id="cb3-11">prob_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> feature_vector<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(feature_vector)</span>
<span id="cb3-12"></span>
<span id="cb3-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ensures uniform sampling of notes into tick intervals</span></span>
<span id="cb3-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of notes is approximately  = density</span></span>
<span id="cb3-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># my note density goes to 11%</span></span>
<span id="cb3-16">rando_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midiblender<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_features_from_probs</span>(prob_vector,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">density =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">81100</span>)</span>
<span id="cb3-17"></span>
<span id="cb3-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert back piano roll matrix</span></span>
<span id="cb3-19">rando_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">feature_vector_to_matrix</span>(rando_vector, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_notes=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>)</span>
<span id="cb3-20"></span>
<span id="cb3-21"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############</span></span>
<span id="cb3-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># turn it back into midi and render to mp3</span></span>
<span id="cb3-23"></span>
<span id="cb3-24">track_0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_midi_df_track</span>(midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb3-25"></span>
<span id="cb3-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transform back to midi</span></span>
<span id="cb3-27">midi_time_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_time</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> rando_matrix,</span>
<span id="cb3-28">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_time_unit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb3-29">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off_length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb3-30"></span>
<span id="cb3-31">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_midi_meta_df</span>(track_0)</span>
<span id="cb3-32"></span>
<span id="cb3-33">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_midi_tempo_meta</span>(meta_messages_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">update_tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>)</span>
<span id="cb3-34"></span>
<span id="cb3-35">split_meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split_meta_df</span>(meta_messages_df)</span>
<span id="cb3-36"></span>
<span id="cb3-37">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_time_df =</span> midi_time_df,</span>
<span id="cb3-38">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_meta_list =</span> split_meta_messages_df,</span>
<span id="cb3-39">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-40">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb3-41"></span>
<span id="cb3-42"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb3-43"></span>
<span id="cb3-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb3-45">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb3-46"></span>
<span id="cb3-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb3-48">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rando_B.mid"</span>)</span>
<span id="cb3-49"></span>
<span id="cb3-50"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb3-51"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce to mp3 with fluid synth</span></span>
<span id="cb3-52"></span>
<span id="cb3-53">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rando_B"</span></span>
<span id="cb3-54"></span>
<span id="cb3-55">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb3-56">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb3-57">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb3-58"></span>
<span id="cb3-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb3-60">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/nintendo_soundfont.sf2 {midi_name}'</span>)</span>
<span id="cb3-61"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb3-62"></span>
<span id="cb3-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb3-64">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb3-65"></span>
<span id="cb3-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb3-67"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb3-68">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb3-69">}</span></code></pre></div>
</details>
</div>
<p>HAHAHHAHAHA. Oh MY. Giving my eurorack a run on thick noise.</p>
<p>MuseScore4 would not render the sheet music for this. But, fluid synth didnt even blink.</p>
<p><strong>Its very loud, so beware.</strong></p>
<p><audio controls=""> <source src="rando_B.mp3" type="audio/wav"> </audio></p>
<p>Chunky compared to white noise, and whiffs of crystal rain.</p>
<section id="notes" class="level2">
<h2 class="anchored" data-anchor-id="notes">Notes</h2>
<p>That was fun. Had to try it. Even though this is basically ridiculous, I might return here one day with some FX pedals.</p>
<hr>
<p>I couldnt stay away. Too many questions. And, it seems like I could add program change notes to change the synth voice, so Im going to try that. And, I wondered about ramping the note density up and down over time, and will try that too. Maybe some other stuff.</p>
</section>
<section id="randomizing-notes-and-program-changes" class="level2">
<h2 class="anchored" data-anchor-id="randomizing-notes-and-program-changes">Randomizing notes and program changes</h2>
<p>Based ona few checks of MIDI files, it seems I could insert a program change message anywhere in a track, and this ought to change the synth voice. Gotta try it out.</p>
<p>Notes:</p>
<ul>
<li>how many patches are in the nintendo sound font? need to find out.</li>
</ul>
<p>Maybe run this? Seems to work and shows a long enough list to get me started.</p>
<pre><code>echo "inst 1" | fluidsynth ~/Library/Audio/Sounds/Banks/nintendo_soundfont.sf2</code></pre>
<p>Had to break out a while loop for this one!</p>
<p>Need to keep the program change between 0-127. I guess there would be other stuff to switch banks. Leaving that for now.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi</span></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#using mario to get the midi headers</span></span>
<span id="cb5-5">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb5-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(mario, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># send objects to global environment</span></span>
<span id="cb5-7"></span>
<span id="cb5-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert midi to matrix</span></span>
<span id="cb5-9">n_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span></span>
<span id="cb5-10">n_ticks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#15 bars at 120BPM of this should be enough</span></span>
<span id="cb5-11"></span>
<span id="cb5-12">feature_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,n_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>n_ticks)</span>
<span id="cb5-13">prob_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> feature_vector<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(feature_vector)</span>
<span id="cb5-14"></span>
<span id="cb5-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ensures uniform sampling of notes into tick intervals</span></span>
<span id="cb5-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of notes is approximately  = density</span></span>
<span id="cb5-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># my note density goes to 1100</span></span>
<span id="cb5-18">rando_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midiblender<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_features_from_probs</span>(prob_vector,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">density =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1100</span>)</span>
<span id="cb5-19"></span>
<span id="cb5-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert back piano roll matrix</span></span>
<span id="cb5-21">rando_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">feature_vector_to_matrix</span>(rando_vector, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_notes=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>)</span>
<span id="cb5-22"></span>
<span id="cb5-23"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############</span></span>
<span id="cb5-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># turn it back into midi and render to mp3</span></span>
<span id="cb5-25"></span>
<span id="cb5-26">track_0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_midi_df_track</span>(midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb5-27"></span>
<span id="cb5-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transform back to midi</span></span>
<span id="cb5-29">midi_time_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_time</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> rando_matrix,</span>
<span id="cb5-30">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_time_unit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb5-31">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off_length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb5-32"></span>
<span id="cb5-33">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_midi_meta_df</span>(track_0)</span>
<span id="cb5-34"></span>
<span id="cb5-35">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_midi_tempo_meta</span>(meta_messages_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">update_tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>)</span>
<span id="cb5-36"></span>
<span id="cb5-37">split_meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split_meta_df</span>(meta_messages_df)</span>
<span id="cb5-38"></span>
<span id="cb5-39">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_time_df =</span> midi_time_df,</span>
<span id="cb5-40">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_meta_list =</span> split_meta_messages_df,</span>
<span id="cb5-41">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb5-42">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb5-43"></span>
<span id="cb5-44"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###################</span></span>
<span id="cb5-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add random program changes before each note on</span></span>
<span id="cb5-46"></span>
<span id="cb5-47">i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb5-48"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span>(i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(new_midi_df)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]){</span>
<span id="cb5-49">  i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb5-50">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(new_midi_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>){</span>
<span id="cb5-51">   new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> new_midi_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-52">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb5-53">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb5-54">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb5-55">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb5-56">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb5-57">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb5-58">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"program_change"</span>,</span>
<span id="cb5-59">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.before =</span> i)</span>
<span id="cb5-60">   i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb5-61">  }</span>
<span id="cb5-62">  </span>
<span id="cb5-63">}</span>
<span id="cb5-64"></span>
<span id="cb5-65"></span>
<span id="cb5-66"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb5-67"></span>
<span id="cb5-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb5-69">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb5-70"></span>
<span id="cb5-71"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb5-72">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rando_1100_PC_B.mid"</span>)</span>
<span id="cb5-73"></span>
<span id="cb5-74"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb5-75"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce to mp3 with fluid synth</span></span>
<span id="cb5-76"></span>
<span id="cb5-77">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rando_1100_PC"</span></span>
<span id="cb5-78"></span>
<span id="cb5-79">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb5-80">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb5-81">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb5-82"></span>
<span id="cb5-83"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb5-84">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/nintendo_soundfont.sf2 {midi_name}'</span>)</span>
<span id="cb5-85"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb5-86"></span>
<span id="cb5-87"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#system_command &lt;- glue::glue('fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 {midi_name}')</span></span>
<span id="cb5-88"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#system(system_command)</span></span>
<span id="cb5-89"></span>
<span id="cb5-90"></span>
<span id="cb5-91"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb5-92">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb5-93"></span>
<span id="cb5-94"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb5-95"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb5-96">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb5-97">}</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="rando_1100_PC.mp3" type="audio/wav"> </audio></p>
<p>I got a lot of fluidsynth warnings for instrument not found when the PC value was 120 or greater. Oh well. This sounds like a breathy R2D2.</p>
<p>Heres another one using the <code>FluidR3_GM.sf2</code> soundfont, which is a General MIDI kind of thing. I set the note length to a bit longer.</p>
<p><audio controls=""> <source src="rando_1100_PC_B.mp3" type="audio/wav"> </audio></p>
<p>Ha, I like it.</p>
</section>
<section id="mario-with-every-note-played-by-a-random-instrument" class="level2">
<h2 class="anchored" data-anchor-id="mario-with-every-note-played-by-a-random-instrument">Mario with every note played by a random instrument</h2>
<p>I gotta one more thing with this. What does the Mario music sound like when every note is played by a different instrument?</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi</span></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#using mario to get the midi headers</span></span>
<span id="cb6-5">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb6-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(mario, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># send objects to global environment</span></span>
<span id="cb6-7"></span>
<span id="cb6-8">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi_df</span>
<span id="cb6-9"></span>
<span id="cb6-10"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###################</span></span>
<span id="cb6-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add random program changes before each note on</span></span>
<span id="cb6-12"></span>
<span id="cb6-13">i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb6-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span>(i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(new_midi_df)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]){</span>
<span id="cb6-15">  i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-16">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(new_midi_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>){</span>
<span id="cb6-17">   new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> new_midi_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-18">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb6-19">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb6-20">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb6-21">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb6-22">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb6-23">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb6-24">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"program_change"</span>,</span>
<span id="cb6-25">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.before =</span> i)</span>
<span id="cb6-26">   i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-27">  }</span>
<span id="cb6-28">  </span>
<span id="cb6-29">}</span>
<span id="cb6-30"></span>
<span id="cb6-31"></span>
<span id="cb6-32"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb6-33"></span>
<span id="cb6-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb6-35">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb6-36"></span>
<span id="cb6-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb6-38">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mario_rand_voice.mid"</span>)</span>
<span id="cb6-39"></span>
<span id="cb6-40"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb6-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce to mp3 with fluid synth</span></span>
<span id="cb6-42"></span>
<span id="cb6-43">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mario_rand_voice"</span></span>
<span id="cb6-44"></span>
<span id="cb6-45">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb6-46">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb6-47">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb6-48"></span>
<span id="cb6-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb6-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#system_command &lt;- glue::glue('fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/nintendo_soundfont.sf2 {midi_name}')</span></span>
<span id="cb6-51"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#system(system_command)</span></span>
<span id="cb6-52"></span>
<span id="cb6-53">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 {midi_name}'</span>)</span>
<span id="cb6-54"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb6-55"></span>
<span id="cb6-56"></span>
<span id="cb6-57"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb6-58">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb6-59"></span>
<span id="cb6-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb6-61"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb6-62">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb6-63">}</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="mario_rand_voice.mp3" type="audio/wav"> </audio></p>
<p>MehIf I had a better handle on which patches I was randomizing over I bet that could sound more interesting.</p>
<p>Maybe I should write a utility function to play through the sounds really fast and check them out.</p>
</section>
<section id="sweeping-randomness-up-and-down" class="level2">
<h2 class="anchored" data-anchor-id="sweeping-randomness-up-and-down">Sweeping randomness up and down</h2>
<p>If this was a eurorack module there would be a whole bunch of knobs to turn. I would turn a knob for note density, so lets see how easy it would be to have the randomness start with few notes, go up to ludicrous speed, and then come back down again.</p>
<p>And, program change all the notes, because why not.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi</span></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#using mario to get the midi headers</span></span>
<span id="cb7-5">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb7-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(mario, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># send objects to global environment</span></span>
<span id="cb7-7"></span>
<span id="cb7-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert midi to matrix</span></span>
<span id="cb7-9">n_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span></span>
<span id="cb7-10">n_ticks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#15 bars at 120BPM of this should be enough</span></span>
<span id="cb7-11">points <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> n_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>n_ticks</span>
<span id="cb7-12"></span>
<span id="cb7-13">mid_point <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(points <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb7-14">ramp_up <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> mid_point))</span>
<span id="cb7-15">ramp_down <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> (points <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> mid_point)))</span>
<span id="cb7-16">feature_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(ramp_up,ramp_down)</span>
<span id="cb7-17">prob_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> feature_vector<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(feature_vector)</span>
<span id="cb7-18"></span>
<span id="cb7-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ensures uniform sampling of notes into tick intervals</span></span>
<span id="cb7-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of notes is approximately  = density</span></span>
<span id="cb7-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># my note density goes to 1100</span></span>
<span id="cb7-22">rando_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midiblender<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_features_from_probs</span>(prob_vector,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">density =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4000</span>)</span>
<span id="cb7-23"></span>
<span id="cb7-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert back piano roll matrix</span></span>
<span id="cb7-25">rando_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">feature_vector_to_matrix</span>(rando_vector, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_notes=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>)</span>
<span id="cb7-26"></span>
<span id="cb7-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###############</span></span>
<span id="cb7-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># turn it back into midi and render to mp3</span></span>
<span id="cb7-29"></span>
<span id="cb7-30">track_0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_midi_df_track</span>(midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-31"></span>
<span id="cb7-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transform back to midi</span></span>
<span id="cb7-33">midi_time_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_time</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> rando_matrix,</span>
<span id="cb7-34">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_time_unit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb7-35">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off_length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb7-36"></span>
<span id="cb7-37">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_midi_meta_df</span>(track_0)</span>
<span id="cb7-38"></span>
<span id="cb7-39">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_midi_tempo_meta</span>(meta_messages_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">update_tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>)</span>
<span id="cb7-40"></span>
<span id="cb7-41">split_meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split_meta_df</span>(meta_messages_df)</span>
<span id="cb7-42"></span>
<span id="cb7-43">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_time_df =</span> midi_time_df,</span>
<span id="cb7-44">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_meta_list =</span> split_meta_messages_df,</span>
<span id="cb7-45">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb7-46">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb7-47"></span>
<span id="cb7-48"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">###################</span></span>
<span id="cb7-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add random program changes before each note on</span></span>
<span id="cb7-50"></span>
<span id="cb7-51">i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-52"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span>(i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(new_midi_df)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]){</span>
<span id="cb7-53">  i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb7-54">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(new_midi_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>){</span>
<span id="cb7-55">   new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> new_midi_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb7-56">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb7-57">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb7-58">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb7-59">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb7-60">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">127</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb7-61">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb7-62">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"program_change"</span>,</span>
<span id="cb7-63">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.before =</span> i)</span>
<span id="cb7-64">   i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb7-65">  }</span>
<span id="cb7-66">  </span>
<span id="cb7-67">}</span>
<span id="cb7-68"></span>
<span id="cb7-69"></span>
<span id="cb7-70"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb7-71"></span>
<span id="cb7-72"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb7-73">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb7-74"></span>
<span id="cb7-75"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb7-76">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rando_ramp.mid"</span>)</span>
<span id="cb7-77"></span>
<span id="cb7-78"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb7-79"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce to mp3 with fluid synth</span></span>
<span id="cb7-80"></span>
<span id="cb7-81">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rando_ramp"</span></span>
<span id="cb7-82"></span>
<span id="cb7-83">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb7-84">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb7-85">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb7-86"></span>
<span id="cb7-87"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb7-88"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#system_command &lt;- glue::glue('fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/nintendo_soundfont.sf2 {midi_name}')</span></span>
<span id="cb7-89"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#system(system_command)</span></span>
<span id="cb7-90"></span>
<span id="cb7-91">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 {midi_name}'</span>)</span>
<span id="cb7-92"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb7-93"></span>
<span id="cb7-94"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb7-95">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb7-96"></span>
<span id="cb7-97"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb7-98"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb7-99">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb7-100">}</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="rando_ramp.mp3" type="audio/wav"> </audio></p>
<p>A ramp up and down of sorts was added. Didnt achieve ludicrous levels so much in the middle. Clocking out on this.</p>


</section>

 ]]></description>
  <category>midiblender</category>
  <category>fun</category>
  <guid>https://homophony.quest/blog/43_2_9_24_max_random/</guid>
  <pubDate>Fri, 09 Feb 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/43_2_9_24_max_random/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Analyzing and filtering note occurence by point estimation</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/42_2_8_24_prob_filter/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"futuristic vacuum cleaner on white background. sucking up probabilities of musical notes. cartoon. 80s retro."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/42_2_8_24_prob_filter/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>futuristic vacuum cleaner on white background. sucking up probabilities of musical notes. cartoon. 80s retro.</p>
</div></div><p>Theres many ideas swirling around leading me to this MIDI mangling experiment. My preference would be to discuss them in advance of the code, but Im going to mostly resist that urge. Perhaps another time.</p>
<p>Getting right into then, lets use <a href="https://www.crumplab.com/midiblender/">midiblender</a> to import the mario music into a matrix.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi</span></span>
<span id="cb2-4">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(mario, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># send objects to global environment</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;environment: R_GlobalEnv&gt;</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert midi to matrix</span></span>
<span id="cb4-2">piano_roll <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_df_to_matrix</span>(midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb4-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(piano_roll)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   128 14113</code></pre>
</div>
</div>
<p>The <code>piano_roll</code> matrix has 128 rows for each possible midi note, and 14113 columns for each midi time tick. All of the notes are coded as 1s in this matrix. All other cells are set to 0.</p>
<section id="point-estimates-of-note-occurrence-probability" class="level2">
<h2 class="anchored" data-anchor-id="point-estimates-of-note-occurrence-probability">Point estimates of note occurrence probability</h2>
<p>Lets do a bit of data analysis. How many notes occur in this midi file?</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(piano_roll)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 901</code></pre>
</div>
</div>
<p>What are the frequencies of each note across the song?</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">note_frequencies <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowSums</span>(piano_roll)</span>
<span id="cb8-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(note_frequencies)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://homophony.quest/blog/42_2_8_24_prob_filter/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Most of the notes are between MIDI note 40ish and 85ish. The most frequent note is clocking in around 90 occurences.</p>
<p>Dividing the vector of note frequencies by the total sum gives point estimates of the probabilities for each note.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">note_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> note_frequencies<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(note_frequencies)</span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sort</span>(note_probabilities))</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://homophony.quest/blog/42_2_8_24_prob_filter/index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There a quick sorted plot, most notes have 0 probability of occurrence, and then it swings up to a max of 0.1054384. Neato.</p>
<p>In previous posts Ive been taking point estimation much further in terms of reshaping the matrix and estimating probabilities for notes in particular time slices. I havent yet tried doing something simple like the above, and using only these probabilities to generate new sequences. And, Im not going to do that here either.</p>
</section>
<section id="filtering-note-occurrences-by-point-estimates." class="level2">
<h2 class="anchored" data-anchor-id="filtering-note-occurrences-by-point-estimates.">Filtering note occurrences by point estimates.</h2>
<p>I have a bunch of things I want to try with this, but in this post Ill keep it simple to get the idea down.</p>
<p>Heres a simple filtering idea. Remove notes from the original piece depending on their point estimates. We could listen to mario with all of the high probability notes removed, or all of the low probability notes removed, or whatever combo one desires.</p>
<p>The more complicated plans involve deriving point estimates for conditional probabilities based on prior note occurrence, and/or note x time probabilities, and then filtering notes on that basis.</p>
<p>Before I do that, heres a short digression. Consider listening to note sequences as an exercise in dynamic expectation. This is a pretty common notion in music and music cognition. You hear notes over time as they repeat and change, and have feelings of expectation about what comes next.</p>
<p>Lets say you are a note accumulator matrix, like the piano roll. As you accumulate note occurrences, some happen more often than others. If the music has repetitive structure, then there could be a sense of expectation. The new notes might have the same frequency profiles as the old notes, giving a sense of congruencythis is what the matrix was expecting. The new notes might have different frequencies, violating the expectation of the matrix, but nevertheless adding to the total accumulation of notesthe matrix would be less surprised about similar deviations the next time. Apologies for over-anthropomorphizing the matrix.</p>
<p>The point estimates above are very global point estimates of note probability taken over all local contexts. After listening to mario music on repeat, as I did for who knows how long as a kid, these probabilities represent a kind of mean expectation about what notes I should be hearing in general.</p>
<p>I dont know the music analysis literature well enough to know what this would be called, but it would be pretty straightforward to look at notes in a musical piece in terms of how they deviate from their point estimates. And, there are lots of interesting questions here about which point estimates to choose. Ones from the song, or set of songs like it, or a massive corpus of midi files, or a persons entire listening experience. But, the analysis stuff is for another day.</p>
<p>Gotta reign in this digression. One point is there seems to be some interesting applied value in being able to quickly code notes in terms of their point estimates. Itll be super easy to do this in R. For example, we would just replace all the 1s in each row of the piano matrix with their respective point estimates.</p>
<p>Fortunately, R does the <a href="https://en.wikipedia.org/wiki/Hadamard_product_(matrices)">hadamard product</a>, so its just this.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">point_estimate_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> piano_roll <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> note_probabilities</span></code></pre></div>
</details>
</div>
<p>Great, so what do we do with the new matrix? Lots of possibilities come to mind. This could be a quick way to edit for wrong notes. If this was a recorded performance, and you accidentally flubbed a couple notes, these could be low frequency occurrences with very low probability of occurrence. Just delete the really low probability notes and re-constitute the midi file from the matrix.</p>
<p>Need to be delicate with the low probability notes, they might be really surprising and special. Maybe there needs to be more low probability notes.</p>
<p>The goal of this post was to listen to mario with high probability notes deleted, or with low probability notes deleted. Well do both. I suspect the technique could be interesting also with respect to probabilistically generated notes, many of which sound awful. Maybe tracking them and deleting them by their point estimates could make the probabilistic sequences sound better. If I think about this in terms of a eurorack module, I dont really care how musical it sounds, I just want a knob to turn and mangle the probabilities in any direction for fun timez.</p>
<p>No more digression, lets do this thing.</p>
</section>
<section id="high-pass-probability-filtering-mario-without-high-probability-notes" class="level2">
<h2 class="anchored" data-anchor-id="high-pass-probability-filtering-mario-without-high-probability-notes">High pass probability filtering: Mario without high probability notes</h2>
<p>Did a quick check and notes with a higher than 5% point estimate account for about 56% of all of the note occurrences. These notes get played a lot in mario.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(note_probabilities[note_probabilities <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">05</span>])</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5615982</code></pre>
</div>
</div>
<p>OK, bye bye high frequency notes. Setting those ones to 0. Setting all other values to 1, converting this back into a note occurrence matrix.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">mario_no_high <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> point_estimate_matrix</span>
<span id="cb13-2">mario_no_high[mario_no_high <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">05</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb13-3">mario_no_high[mario_no_high <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> </span></code></pre></div>
</details>
</div>
<p>Now, a bit of {midiblender} magic, and lets turn this matrix back into a midi file and listen to it.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">track_0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_midi_df_track</span>(midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb14-2"></span>
<span id="cb14-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transform back to midi</span></span>
<span id="cb14-4">midi_time_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_time</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> mario_no_high,</span>
<span id="cb14-5">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_time_unit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb14-6">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off_length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb14-7"></span>
<span id="cb14-8">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_midi_meta_df</span>(track_0)</span>
<span id="cb14-9"></span>
<span id="cb14-10">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_midi_tempo_meta</span>(meta_messages_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">update_tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>)</span>
<span id="cb14-11"></span>
<span id="cb14-12">split_meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split_meta_df</span>(meta_messages_df)</span>
<span id="cb14-13"></span>
<span id="cb14-14">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_time_df =</span> midi_time_df,</span>
<span id="cb14-15">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_meta_list =</span> split_meta_messages_df,</span>
<span id="cb14-16">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb14-17">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb14-18"></span>
<span id="cb14-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb14-20"></span>
<span id="cb14-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb14-22">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb14-23"></span>
<span id="cb14-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb14-25">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mario_no_high.mid"</span>)</span>
<span id="cb14-26"></span>
<span id="cb14-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb14-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce to mp3 with fluid synth</span></span>
<span id="cb14-29"></span>
<span id="cb14-30">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mario_no_high"</span></span>
<span id="cb14-31"></span>
<span id="cb14-32">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb14-33">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb14-34">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb14-35"></span>
<span id="cb14-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb14-37">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/nintendo_soundfont.sf2 {midi_name}'</span>)</span>
<span id="cb14-38"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb14-39"></span>
<span id="cb14-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb14-41">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb14-42"></span>
<span id="cb14-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb14-44"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb14-45">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb14-46">}</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="mario_no_high.mp3" type="audio/wav"> </audio></p>
<p>Well, half of the notes are gone, and it sounds pretty sparse. Very cool function though.</p>
</section>
<section id="low-pass-probability-filtering-mario-without-low-probability-notes" class="level2">
<h2 class="anchored" data-anchor-id="low-pass-probability-filtering-mario-without-low-probability-notes">Low pass probability filtering: Mario without low probability notes</h2>
<p>Lets do the opposite, and take out the low probability notes. It will be even more sparse using .05 as the cutoff. But it must be done.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(note_probabilities[note_probabilities <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">05</span>])</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4384018</code></pre>
</div>
</div>
<p>OK, bye bye high frequency notes. Setting those ones to 0. Setting all other values to 1, converting this back into a note occurrence matrix.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">mario_no_low <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> point_estimate_matrix</span>
<span id="cb17-2">mario_no_low[mario_no_low <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">05</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb17-3">mario_no_low[mario_no_low <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> </span></code></pre></div>
</details>
</div>
<p>Now, a bit of {midiblender} magic, and lets turn this matrix back into a midi file and listen to it.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">track_0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_midi_df_track</span>(midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb18-2"></span>
<span id="cb18-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transform back to midi</span></span>
<span id="cb18-4">midi_time_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_time</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> mario_no_low,</span>
<span id="cb18-5">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_time_unit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb18-6">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off_length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb18-7"></span>
<span id="cb18-8">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_midi_meta_df</span>(track_0)</span>
<span id="cb18-9"></span>
<span id="cb18-10">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_midi_tempo_meta</span>(meta_messages_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">update_tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>)</span>
<span id="cb18-11"></span>
<span id="cb18-12">split_meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split_meta_df</span>(meta_messages_df)</span>
<span id="cb18-13"></span>
<span id="cb18-14">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_time_df =</span> midi_time_df,</span>
<span id="cb18-15">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_meta_list =</span> split_meta_messages_df,</span>
<span id="cb18-16">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb18-17">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb18-18"></span>
<span id="cb18-19"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb18-20"></span>
<span id="cb18-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb18-22">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb18-23"></span>
<span id="cb18-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb18-25">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mario_no_low.mid"</span>)</span>
<span id="cb18-26"></span>
<span id="cb18-27"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb18-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce to mp3 with fluid synth</span></span>
<span id="cb18-29"></span>
<span id="cb18-30">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mario_no_low"</span></span>
<span id="cb18-31"></span>
<span id="cb18-32">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb18-33">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb18-34">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb18-35"></span>
<span id="cb18-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb18-37">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/nintendo_soundfont.sf2 {midi_name}'</span>)</span>
<span id="cb18-38"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb18-39"></span>
<span id="cb18-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb18-41">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb18-42"></span>
<span id="cb18-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb18-44"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb18-45">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb18-46">}</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="mario_no_low.mp3" type="audio/wav"> </audio></p>
<p>Again, pretty sparse, but emphasizing different aspects of mario.</p>
</section>
<section id="conclusions-i-want-a-eurorack-module-for-this" class="level2">
<h2 class="anchored" data-anchor-id="conclusions-i-want-a-eurorack-module-for-this">Conclusions: I want a eurorack module for this</h2>
<p>I wish I could just dial around a knob, like a filter knob, that did this to a midi file while it was playing. Maybe someday Ill figure out how to do that for a eurorack module.</p>
<p>These examples didnt sound like much, but whatever. I could imagine this being very useful in general. For example, it would be nice to step back and look some composition and quickly appreciate what the spread of point estimates are. Maybe it is too regular, so you filter down the high probability stuff, or the opposite. It would be fun to have an equalizer like situation, where instead of emphasizing different wave frequencies, it allowed one to bring up or down different note probabilities. I think this would have really interesting effects, especially on super dense improvisational stuff, where I would probably want to delete things, and being able to do that on the basis of probabilities seems promising.</p>
<p>This is just a quick and dirty example, will fool around with this more for sure.</p>


</section>

 ]]></description>
  <category>midiblender</category>
  <category>probabilistic filtering</category>
  <category>rstatsmusic</category>
  <category>midi</category>
  <category>rstats</category>
  <guid>https://homophony.quest/blog/42_2_8_24_prob_filter/</guid>
  <pubDate>Thu, 08 Feb 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/42_2_8_24_prob_filter/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>{midiblender} is alive!</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/41_2_8_24_midiblender_alive/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blender on white background. blender blending musical notes. cartoon. 80s retro."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/41_2_8_24_midiblender_alive/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>R stats package logo</p>
</div></div><p>A super quick post to say that <a href="https://www.crumplab.com/midiblender/">midiblender</a> is alive on github.</p>
<p>The github repo is: <a href="https://github.com/CrumpLab/midiblender" class="uri">https://github.com/CrumpLab/midiblender</a></p>
<p>This is the beginnings of an #rstats package for experimental mangling of #MIDI files. TBH, its my personal experimental hacky-code base wrapped in R package clothing. Im messing with it constantly, and sharing in case others are interested.</p>
<p>I wrote a <a href="https://www.crumplab.com/midiblender/articles/Getting_started.html">getting starting vignette</a> that could be helpful for others to try stuff out.</p>
<p>Otherwise, Im planning to keep posting examples and experiments on this blog. So, more {midiblender} to come.</p>



 ]]></description>
  <category>midiblender</category>
  <category>generativemusic</category>
  <category>rstatsmusic</category>
  <category>midi</category>
  <category>rstats</category>
  <guid>https://homophony.quest/blog/41_2_8_24_midiblender_alive/</guid>
  <pubDate>Thu, 08 Feb 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/41_2_8_24_midiblender_alive/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Midi blending Canon in D probabilistically</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/40_2_7_24_midiblender_canon/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blender on white background. blender blending musical notes. cartoon. 80s retro."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/40_2_7_24_midiblender_canon/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>Probabilistically generated sheet music.</p>
</div></div><p>Still working on {midiblender} here. Check out <a href="https://homophony.quest/notes.html">past posts for more info</a>.</p>
<p>Another quick post with some code and mp3 examples. Im waffling on whether to share {midiblender} on github sooner than later. Its in a personally usable state, which is my intended use case. I guess my inclination is to share in case others find the code helpful, with a big warning that it might not blend. Im too new to processing midi files, and the code is not general enough to handle lots of aspects of midi files. Anyway, on with the post.</p>
<p>This one is basically an extension of what I was doing with the mario overworld theme <a href="https://homophony.quest/blog/39_2_7_24_midiblender_mario/">in the last post</a>.</p>
<p>Instead of mario, this time Im importing Pachelbels Canon in D. Its not the most well-articulated midi file, but it is recognizable as the Canon in D. One goal is make sure my code will mangle other midi files, so Im kicking the tires here.</p>
<section id="endless-canon-in-probabilid" class="level2">
<h2 class="anchored" data-anchor-id="endless-canon-in-probabilid">Endless Canon in ProbabiliD</h2>
<p>In this example I slice up the midi file into small temporal intervals, like 2 beats of a bar, and represent each of them in a pitch x midi ticks matrix. Using this matrix I compute probabilities of each note in time within the bar, and then generate new notes based on those probabilities. There is a little bit more going on to make it slightly more musically. I start with the first two beats in the song and compute a measure of similarity between them, and all other 2 beat slices. I take the slices that have some positive similarity and compute the note and time probabilities from this smaller set. I have it set up so that when I generate notes from these probabilities (by sampling from binomial distributions), I also sample notes from the probabilities for the next beat. I then use those probabilities in the next step to filter the matrix for most similar bars, and so on.</p>
<p>Its endless in the sense that I could run the loop for much longer and it would keep going, but I stopped it to get about 3 minutes out.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi</span></span>
<span id="cb2-3">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"canon.mid"</span>)</span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(mario, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># send objects to global environment</span></span>
<span id="cb2-5">track_0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_midi_df_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_df =</span> midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert to a piano roll matrix</span></span>
<span id="cb2-8">all_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_df_to_matrix</span>(midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># reshape to desired interval</span></span>
<span id="cb2-11">music_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reshape_piano_roll</span>(all_midi,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb2-12"></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># probabilistic sampling</span></span>
<span id="cb2-14"></span>
<span id="cb2-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create conditional vector</span></span>
<span id="cb2-16">conditional_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(music_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb2-17">conditional_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> music_matrix[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,]</span>
<span id="cb2-18">dot_products <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> conditional_vector <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(music_matrix)</span>
<span id="cb2-19">positive_similarity <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(dot_products <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-20"></span>
<span id="cb2-21"></span>
<span id="cb2-22">feature_probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_feature_probs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> music_matrix[positive_similarity,])</span>
<span id="cb2-23"></span>
<span id="cb2-24">mean_note_density <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_mean_note_density</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> music_matrix[positive_similarity,])</span>
<span id="cb2-25"></span>
<span id="cb2-26">new_features <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_features_from_probs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> feature_probs,</span>
<span id="cb2-27">                                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">density =</span> mean_note_density,</span>
<span id="cb2-28">                                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">examples =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loop</span></span>
<span id="cb2-30">new_feature_vectors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> new_features</span>
<span id="cb2-31"></span>
<span id="cb2-32"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) {</span>
<span id="cb2-33">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># put second half into conditional vector</span></span>
<span id="cb2-34">  conditional_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(new_features[((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(new_features)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(new_features)],</span>
<span id="cb2-35">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(new_features)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb2-36">  dot_products <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> conditional_vector <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(music_matrix)</span>
<span id="cb2-37">  positive_similarity <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(dot_products <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-38">  </span>
<span id="cb2-39">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(positive_similarity)  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>){</span>
<span id="cb2-40">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sample some random stuff</span></span>
<span id="cb2-41">    positive_similarity <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(music_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>)</span>
<span id="cb2-42">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(i)</span>
<span id="cb2-43">  }</span>
<span id="cb2-44">  </span>
<span id="cb2-45">  </span>
<span id="cb2-46">  feature_probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb2-47">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_feature_probs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> music_matrix[positive_similarity, ])</span>
<span id="cb2-48">  </span>
<span id="cb2-49">  mean_note_density <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb2-50">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_mean_note_density</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> music_matrix[positive_similarity, ])</span>
<span id="cb2-51">  </span>
<span id="cb2-52">  new_features <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_features_from_probs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> feature_probs,</span>
<span id="cb2-53">                                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">density =</span> mean_note_density,</span>
<span id="cb2-54">                                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">examples =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-55">  new_feature_vectors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(new_feature_vectors,new_features)</span>
<span id="cb2-56">}</span>
<span id="cb2-57"></span>
<span id="cb2-58">new_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">feature_vector_to_matrix</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vec =</span> new_feature_vectors,</span>
<span id="cb2-59">                                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_notes =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>)</span>
<span id="cb2-60"></span>
<span id="cb2-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transform back to midi</span></span>
<span id="cb2-62">midi_time_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_time</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> new_matrix,</span>
<span id="cb2-63">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_time_unit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb2-64">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off_length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb2-65"></span>
<span id="cb2-66">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_midi_meta_df</span>(track_0)</span>
<span id="cb2-67"></span>
<span id="cb2-68">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_midi_tempo_meta</span>(meta_messages_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">update_tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000000</span>)</span>
<span id="cb2-69"></span>
<span id="cb2-70">split_meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split_meta_df</span>(meta_messages_df)</span>
<span id="cb2-71"></span>
<span id="cb2-72">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_time_df =</span> midi_time_df,</span>
<span id="cb2-73">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_meta_list =</span> split_meta_messages_df,</span>
<span id="cb2-74">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb2-75">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb2-76"></span>
<span id="cb2-77"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb2-78"></span>
<span id="cb2-79"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb2-80">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb2-81"></span>
<span id="cb2-82"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb2-83">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"endless_canon.mid"</span>)</span>
<span id="cb2-84"></span>
<span id="cb2-85"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb2-86"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce to mp3 with fluid synth</span></span>
<span id="cb2-87"></span>
<span id="cb2-88">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"endless_canon"</span></span>
<span id="cb2-89"></span>
<span id="cb2-90">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb2-91">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb2-92">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb2-93"></span>
<span id="cb2-94"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb2-95">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 {midi_name}'</span>)</span>
<span id="cb2-96"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb2-97"></span>
<span id="cb2-98"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb2-99">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb2-100"></span>
<span id="cb2-101"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb2-102"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb2-103">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb2-104">}</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="endless_canon.mp3" type="audio/wav"> </audio></p>
<p>It sounds like a probabilistic mess, but there are moments with some resemblance to Canon in D. The fluid synth piano sound helps with the cheese factor. Also, my code ignores note length, so everything sounds a bit choppy.</p>
</section>
<section id="blending-the-mess" class="level2">
<h2 class="anchored" data-anchor-id="blending-the-mess">Blending the mess</h2>
<p>The next example offers a blending parameter. I split the original into 2 beat sections. Then I loop through each 2 beat slice. For each slice I compute note in time probabilities and then generate a 2 beat probabilistic sequence. At the end, I have all of the original 2 beat sections, and another set of probabilistically generated ones. To construct the final tune, I blend them together in some proportion. In this case the proportion is 50/50.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi</span></span>
<span id="cb3-3">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"canon.mid"</span>)</span>
<span id="cb3-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(mario, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># send objects to global environment</span></span>
<span id="cb3-5">track_0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_midi_df_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_df =</span> midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert to a piano roll matrix</span></span>
<span id="cb3-8">all_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_df_to_matrix</span>(midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb3-9"></span>
<span id="cb3-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># reshape to desired interval</span></span>
<span id="cb3-11">music_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reshape_piano_roll</span>(all_midi,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb3-12">probabilistic_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> music_matrix</span>
<span id="cb3-13"></span>
<span id="cb3-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># probabilistic sampling and blending</span></span>
<span id="cb3-15"></span>
<span id="cb3-16"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>( i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(music_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]){</span>
<span id="cb3-17"></span>
<span id="cb3-18">  conditional_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> music_matrix[i,]</span>
<span id="cb3-19">  dot_products <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> conditional_vector <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(music_matrix)</span>
<span id="cb3-20">  positive_similarity <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(dot_products <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb3-21">  </span>
<span id="cb3-22">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(positive_similarity)  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>){</span>
<span id="cb3-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sample some random stuff</span></span>
<span id="cb3-24">    positive_similarity <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(music_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>)</span>
<span id="cb3-25">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(i)</span>
<span id="cb3-26">  }</span>
<span id="cb3-27">  </span>
<span id="cb3-28">  </span>
<span id="cb3-29">  feature_probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_feature_probs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> music_matrix[positive_similarity,])</span>
<span id="cb3-30">  </span>
<span id="cb3-31">  mean_note_density <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_mean_note_density</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> music_matrix[positive_similarity,])</span>
<span id="cb3-32">  </span>
<span id="cb3-33">  new_features <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_features_from_probs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> feature_probs,</span>
<span id="cb3-34">                                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">density =</span> mean_note_density,</span>
<span id="cb3-35">                                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">examples =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-36">  probabilistic_matrix[i,] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> new_features</span>
<span id="cb3-37">}</span>
<span id="cb3-38"></span>
<span id="cb3-39"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## blend</span></span>
<span id="cb3-40">blend_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> music_matrix</span>
<span id="cb3-41"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(music_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]){</span>
<span id="cb3-42">  sample_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(music_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])  </span>
<span id="cb3-43">  first_half <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sample_ids)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb3-44">  blend_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sample_ids))</span>
<span id="cb3-45">  blend_vector[sample_ids[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>first_half]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> music_matrix[i,sample_ids[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>first_half]]</span>
<span id="cb3-46">  blend_vector[sample_ids[(first_half<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sample_ids)]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> probabilistic_matrix[i,sample_ids[(first_half<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sample_ids)]]</span>
<span id="cb3-47">  blend_matrix[i,] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> blend_vector</span>
<span id="cb3-48">}</span>
<span id="cb3-49"></span>
<span id="cb3-50"></span>
<span id="cb3-51"></span>
<span id="cb3-52">new_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">feature_vector_to_matrix</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vec =</span> blend_matrix,</span>
<span id="cb3-53">                                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_notes =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>)</span>
<span id="cb3-54"></span>
<span id="cb3-55"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transform back to midi</span></span>
<span id="cb3-56">midi_time_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_time</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> new_matrix,</span>
<span id="cb3-57">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_time_unit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb3-58">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off_length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb3-59"></span>
<span id="cb3-60">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_midi_meta_df</span>(track_0)</span>
<span id="cb3-61"></span>
<span id="cb3-62">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_midi_tempo_meta</span>(meta_messages_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">update_tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000000</span>)</span>
<span id="cb3-63"></span>
<span id="cb3-64">split_meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split_meta_df</span>(meta_messages_df)</span>
<span id="cb3-65"></span>
<span id="cb3-66">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_time_df =</span> midi_time_df,</span>
<span id="cb3-67">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_meta_list =</span> split_meta_messages_df,</span>
<span id="cb3-68">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-69">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb3-70"></span>
<span id="cb3-71"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb3-72"></span>
<span id="cb3-73"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb3-74">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb3-75"></span>
<span id="cb3-76"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb3-77">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"endless_canon_2.mid"</span>)</span>
<span id="cb3-78"></span>
<span id="cb3-79"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb3-80"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce to mp3 with fluid synth</span></span>
<span id="cb3-81"></span>
<span id="cb3-82">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"endless_canon_2"</span></span>
<span id="cb3-83"></span>
<span id="cb3-84">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb3-85">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb3-86">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb3-87"></span>
<span id="cb3-88"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb3-89">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 {midi_name}'</span>)</span>
<span id="cb3-90"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb3-91"></span>
<span id="cb3-92"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb3-93">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb3-94"></span>
<span id="cb3-95"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb3-96"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb3-97">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb3-98">}</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="endless_canon_2.mp3" type="audio/wav"> </audio></p>
<p>Much more recognizable now, with 50% less probabilistic mess. Still sounds ridiculous. Nevertheless, Im expecting some fun to start happening later, especially when running more interesting midi files through mr. modular synthesizer.</p>


</section>

 ]]></description>
  <category>midiblender</category>
  <category>generativemusic</category>
  <category>rstatsmusic</category>
  <category>midi</category>
  <category>rstats</category>
  <guid>https://homophony.quest/blog/40_2_7_24_midiblender_canon/</guid>
  <pubDate>Wed, 07 Feb 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/40_2_7_24_midiblender_canon/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>WIP: Endless probabilistically generated mario music with midiblender</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/39_2_7_24_midiblender_mario/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blender on white background. blender blending musical notes. cartoon. 80s retro."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/39_2_7_24_midiblender_mario/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>The current logo for my experimental r package</p>
</div></div><p>Another quick test post, but I am very excited about this one.</p>
<p>In past posts Ive been doing things like importing midi files to R, such as the overworld music from the NES version of super mario brothers, and then <a href="https://homophony.quest/blog/33_2_1_24_rand_mario/">randomizing the notes</a>, or <a href="https://homophony.quest/blog/35_2_3_24_matrix_midi/">generating new sequences based off of probabilities computed from the music</a>.</p>
<p>Some of the ideas are <a href="https://homophony.quest/blog/37_2_5_24_matrix_analysis/">minimally explained here</a>, and in particular I had a goal of sampling new sequences based on <a href="https://homophony.quest/blog/37_2_5_24_matrix_analysis/#conditionalized-sampling-on-starting-notes">conditionalized starting conditions</a>. But, I didnt have the code base in proper order to crunch those sequences.</p>
<p>So, yesterday I started on {midiblender}, an un-released R package, that now has the necessary code to accomplish my goal. You see, the previous ways of mangling mario were fun and interesting, and I approve of them. But, they got pretty stochastic sounding.</p>
<p>I dont have time right now to really explain what Im trying to do in detail, but it is basically this:</p>
<ol type="1">
<li>create a corpus (matrix) of feature vectors representing the note and time information for some temporal interval from the mario midi file. Ive set it to 2 beats.</li>
<li>Pick a starting vector, such as the first chord in mario</li>
<li>filter the matrix for rows that have some similarity to the starting vector.</li>
<li>Calculate a probability vector for the notes and times from the filtered matrix.</li>
<li>Generate a new feature vector from the probabilities.</li>
<li>I have this set up in pairs, so I take the generated feature vector for the second beat, and use it as the next starting vector.</li>
<li>repeat to generate as many beats worth as you want.</li>
</ol>
<p>The result should still be fairly probabilistic sounding, but more mario sequency sounding than before.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi</span></span>
<span id="cb2-3">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(mario, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># send objects to global environment</span></span>
<span id="cb2-5">track_0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_midi_df_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_df =</span> midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert to a piano roll matrix</span></span>
<span id="cb2-8">all_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_df_to_matrix</span>(midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># reshape to desired interval</span></span>
<span id="cb2-11">music_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reshape_piano_roll</span>(all_midi,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb2-12"></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># probabilistic sampling</span></span>
<span id="cb2-14"></span>
<span id="cb2-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create conditional vector</span></span>
<span id="cb2-16">conditional_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(music_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb2-17">conditional_vector[(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">66</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">76</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> </span>
<span id="cb2-18">dot_products <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> conditional_vector <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(music_matrix)</span>
<span id="cb2-19">positive_similarity <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(dot_products <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-20"></span>
<span id="cb2-21"></span>
<span id="cb2-22">feature_probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_feature_probs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> music_matrix[positive_similarity,])</span>
<span id="cb2-23"></span>
<span id="cb2-24">mean_note_density <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_mean_note_density</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> music_matrix[positive_similarity,])</span>
<span id="cb2-25"></span>
<span id="cb2-26">new_features <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_features_from_probs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> feature_probs,</span>
<span id="cb2-27">                                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">density =</span> mean_note_density,</span>
<span id="cb2-28">                                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">examples =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loop</span></span>
<span id="cb2-30">new_feature_vectors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> new_features</span>
<span id="cb2-31"></span>
<span id="cb2-32"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>) {</span>
<span id="cb2-33">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># put second half into conditional vector</span></span>
<span id="cb2-34">  conditional_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(new_features[((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(new_features)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(new_features)],</span>
<span id="cb2-35">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(new_features)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb2-36">  dot_products <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> conditional_vector <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(music_matrix)</span>
<span id="cb2-37">  positive_similarity <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(dot_products <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-38">  </span>
<span id="cb2-39">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(positive_similarity) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>){</span>
<span id="cb2-40">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sample some random stuff</span></span>
<span id="cb2-41">    positive_similarity <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(music_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>)</span>
<span id="cb2-42">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(i)</span>
<span id="cb2-43">  }</span>
<span id="cb2-44">  </span>
<span id="cb2-45">  </span>
<span id="cb2-46">  feature_probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb2-47">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_feature_probs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> music_matrix[positive_similarity, ])</span>
<span id="cb2-48">  </span>
<span id="cb2-49">  mean_note_density <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb2-50">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_mean_note_density</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> music_matrix[positive_similarity, ])</span>
<span id="cb2-51">  </span>
<span id="cb2-52">  new_features <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_features_from_probs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> feature_probs,</span>
<span id="cb2-53">                                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">density =</span> mean_note_density,</span>
<span id="cb2-54">                                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">examples =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-55">  new_feature_vectors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(new_feature_vectors,new_features)</span>
<span id="cb2-56">}</span>
<span id="cb2-57"></span>
<span id="cb2-58">new_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">feature_vector_to_matrix</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vec =</span> new_feature_vectors,</span>
<span id="cb2-59">                                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_notes =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>)</span>
<span id="cb2-60"></span>
<span id="cb2-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transform back to midi</span></span>
<span id="cb2-62">midi_time_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_time</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> new_matrix,</span>
<span id="cb2-63">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_time_unit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb2-64">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off_length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb2-65"></span>
<span id="cb2-66">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_midi_meta_df</span>(track_0)</span>
<span id="cb2-67"></span>
<span id="cb2-68">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_midi_tempo_meta</span>(meta_messages_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">update_tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600000</span>)</span>
<span id="cb2-69"></span>
<span id="cb2-70">split_meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split_meta_df</span>(meta_messages_df)</span>
<span id="cb2-71"></span>
<span id="cb2-72">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_time_df =</span> midi_time_df,</span>
<span id="cb2-73">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_meta_list =</span> split_meta_messages_df,</span>
<span id="cb2-74">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb2-75">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>)</span>
<span id="cb2-76"></span>
<span id="cb2-77"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb2-78"></span>
<span id="cb2-79"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb2-80">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb2-81"></span>
<span id="cb2-82"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb2-83">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"endless_mario_1.mid"</span>)</span>
<span id="cb2-84"></span>
<span id="cb2-85"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb2-86"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce to mp3 with fluid synth</span></span>
<span id="cb2-87"></span>
<span id="cb2-88">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"endless_mario_1"</span></span>
<span id="cb2-89"></span>
<span id="cb2-90">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb2-91">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb2-92">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb2-93"></span>
<span id="cb2-94"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb2-95">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/nintendo_soundfont.sf2 {midi_name}'</span>)</span>
<span id="cb2-96"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb2-97"></span>
<span id="cb2-98"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb2-99">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb2-100"></span>
<span id="cb2-101"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb2-102"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb2-103">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb2-104">}</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="endless_mario_1.mp3" type="audio/wav"> </audio></p>
<p>It worked!</p>
<p>Its slightly more musical than the other methods, and suggest lots of other fun to stuff to try.</p>
<p>I really wish I had this in a eurorack module.</p>



 ]]></description>
  <category>midiblender</category>
  <category>generativemusic</category>
  <category>rstatsmusic</category>
  <category>midi</category>
  <category>rstats</category>
  <guid>https://homophony.quest/blog/39_2_7_24_midiblender_mario/</guid>
  <pubDate>Wed, 07 Feb 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/39_2_7_24_midiblender_mario/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>midiblender: working on an experimental R package</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/38_2_6_24_midiblender/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blender on white background. blender blending musical notes. cartoon. 80s retro."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/38_2_6_24_midiblender/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>blender on white background. blender blending musical notes. cartoon. 80s retro.- Dreamshaper v7</p>
</div></div><p>I decided to have a go at turning my midi code into a set of functions. So, I spent the day working on a new R package called {midiblender}. Because, will it blend? and R.</p>
<p>Im not quite ready to share the package on github yet, because I suspect it will undergo many changes before I settle on useful patterns. Nevertheless, I have it working on my machine, and Im doing a quick test here. Will write more about this later, and in the package documentation.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(midiblender)</span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load a midi file</span></span>
<span id="cb2-4">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(mario, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># send objects to global environment</span></span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># copy a particular track for further processing</span></span>
<span id="cb2-8">track_0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_midi_df_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_df =</span> midi_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># separate copy to extend with additional timing information</span></span>
<span id="cb2-11">copy_track <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_and_extend_midi_df</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_df =</span> midi_df,</span>
<span id="cb2-12">                                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-13"></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get timing information</span></span>
<span id="cb2-15">metric_tibble <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_metric_tibble</span>(copy_track, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bars =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_tick =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ticks_per_beat =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span>)</span>
<span id="cb2-16"></span>
<span id="cb2-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add timing to copy</span></span>
<span id="cb2-18">copy_track <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_bars_to_copy_df</span>(copy_track, metric_tibble)</span>
<span id="cb2-19"></span>
<span id="cb2-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert to a matrix, each row is a bar.</span></span>
<span id="cb2-21">music_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create_midi_matrix</span>(</span>
<span id="cb2-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> copy_track,</span>
<span id="cb2-23">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_notes =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,</span>
<span id="cb2-24">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intervals_per_bar =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>,</span>
<span id="cb2-25">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">separate =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb2-26">)</span>
<span id="cb2-27"></span>
<span id="cb2-28"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### probabilistic sampling</span></span>
<span id="cb2-29">feature_probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_feature_probs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> music_matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pitch_by_time_matrix)</span>
<span id="cb2-30"></span>
<span id="cb2-31">mean_note_density <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_mean_note_density</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> music_matrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pitch_by_time_matrix)</span>
<span id="cb2-32"></span>
<span id="cb2-33">new_features <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_features_from_probs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> feature_probs,</span>
<span id="cb2-34">                                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">density =</span> mean_note_density,</span>
<span id="cb2-35">                                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">examples =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb2-36"></span>
<span id="cb2-37">new_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">feature_vector_to_matrix</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vec =</span> new_features,</span>
<span id="cb2-38">                                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_notes =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>)</span>
<span id="cb2-39"></span>
<span id="cb2-40"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### transform for export</span></span>
<span id="cb2-41"></span>
<span id="cb2-42">midi_time_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_time</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_matrix =</span> new_matrix,</span>
<span id="cb2-43">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_time_unit =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,</span>
<span id="cb2-44">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off_length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>)</span>
<span id="cb2-45"></span>
<span id="cb2-46">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_midi_meta_df</span>(track_0)</span>
<span id="cb2-47"></span>
<span id="cb2-48">meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_midi_tempo_meta</span>(meta_messages_df,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">update_tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>)</span>
<span id="cb2-49"></span>
<span id="cb2-50">split_meta_messages_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split_meta_df</span>(meta_messages_df)</span>
<span id="cb2-51"></span>
<span id="cb2-52">new_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix_to_midi_track</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_time_df =</span> midi_time_df,</span>
<span id="cb2-53">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">split_meta_list =</span> split_meta_messages_df,</span>
<span id="cb2-54">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb2-55">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>)</span>
<span id="cb2-56"></span>
<span id="cb2-57"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#### bounce</span></span>
<span id="cb2-58"></span>
<span id="cb2-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update miditapyr df</span></span>
<span id="cb2-60">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(new_midi_df)</span>
<span id="cb2-61"></span>
<span id="cb2-62"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#write midi file to disk</span></span>
<span id="cb2-63">miditapyr_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"try_write.mid"</span>)</span></code></pre></div>
</details>
</div>



 ]]></description>
  <category>midiblender</category>
  <category>generativemusic</category>
  <category>rstatsmusix</category>
  <category>midi</category>
  <category>rstats</category>
  <guid>https://homophony.quest/blog/38_2_6_24_midiblender/</guid>
  <pubDate>Tue, 06 Feb 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/38_2_6_24_midiblender/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>MIDI analysis, bags of notes, and probabilistic generation</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/37_2_5_24_matrix_analysis/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cartoon musical notes in bags. Scrooge mcduck hoarding bags of musical notes. A huge room with a pile of musical notes. ducktales."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/37_2_5_24_matrix_analysis/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>cartoon musical notes in bags. Scrooge mcduck hoarding bags of musical notes. A huge room with a pile of musical notes. ducktales. - Dreamshaper v7</p>
</div></div><p>Over the past few posts Ive been exploring probabilistic MIDI generation derived from note probabilities in existing MIDI files, using R.</p>
<p>Aside from having a bit of fun with this, I have a musical interest in finding out whether this approach can be inspiring to my own playing somehow, and in terms of my day job as a cognition researcher, I have an interest in pushing my particular method of choice into this arena as a way to understand the method from a new perspective. This post is mainly notes to self along with some R code.</p>
<section id="bags-of-notes" class="level2">
<h2 class="anchored" data-anchor-id="bags-of-notes">Bags of notes</h2>
<p>Im representing midi files in one bar increments using a technique borrowed from language processing and semantic cognition research, sometimes called bags of words <span class="citation" data-cites="landauer1997">(Landauer and Dumais 1997)</span>. The technique represents chunks of written language as an n-gram frequency vector. For example, take a book and find all of the unique words in the book. Create a matrix with the same number of columns as unique words in the book. Split the book up into bags, which is a collection of words of some size. For example, the bag size could be at the sentence level or paragraph level. Lets say paragraphs. For each paragraph count how many times each word appears in the paragraph. Finally, create a frequency count vector for the paragraph that has zeros for all words not found in the paragraph, and the individual frequency counts for all words in the paragraph. Repeat as necessary for all bags of words. This procedure creates a document x term matrix that represents aspects of how words co-occur with other words in natural language. Ive been doing something similar with midi files.</p>
<p>As this isnt an academic paper, I wont review much more literature, but suffice it to say, several variations on the bags of words approach have been used for MIDI representation and analysis, especially to aid MIDI similarity analysis.</p>
<p>My current bags of notes representation is as follows.</p>
<ol type="1">
<li>Split a midi file into bars</li>
<li>Choose a unit for temporal resolution (e.g., quarter notes, eighth notes, down to the smallest possible representation, midi ticks).</li>
<li>Create a note by time matrix. If the midi file has 96 ticks per beat, then the matrix will have 128 rows (for each possible midi note 0-127), and 96 x 4 = 384 columns.</li>
<li>For each note occurrence in a bar, assign a 1 to the note on location in the matrix. Otherwise, assign a 0.</li>
</ol>
<p>This allows a midi file to be represented as bags of notes in successive note x time frequency matrices. Although I am presently disregarding note length, the resulting matrix contains all of the information necessary to reconstruct the note on messages back into MIDI format.</p>
<p>I have some background modeling aims that involve training theories of learning and memory on patterns from MIDI files, so Im also choosing representations that would work for those models. In this case, I am most interested in training a MINERVA-II style model on MIDI patterns <span class="citation" data-cites="hintzman1984">(Hintzman 1984)</span>. That model represents patterns in individual memory trace as feature vectors. Id like to put bars of music as individual patterns into the model, and to do that I concatenate the note x time matrix into a single feature vector.</p>
<p>Ive decided to proceed by examples instead.</p>
</section>
<section id="mario-example" class="level2">
<h2 class="anchored" data-anchor-id="mario-example">Mario example</h2>
<p>In [this previous post](<a href="https://homophony.quest/blog/35_2_3_24_matrix_midi/" class="uri">https://homophony.quest/blog/35_2_3_24_matrix_midi/</a>) I imported the Super Mario overworld music, represented it in the above matrix format, and then generated probabilistic versions of the music. My plan here is to walk through the example in a little bit more detail, and then consider methods for potentially improving the musicality of generated sequences.</p>
<p>The following code reads in the <code>overworld.mid</code> file, and converts it to a matrix. Lets take a closer look.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pyramidi)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(purrr)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi using miditapyr</span></span>
<span id="cb3-2">test_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFrames</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import using mido</span></span>
<span id="cb3-5">mido_import <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>mido<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFile</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to R dataframe</span></span>
<span id="cb3-8">dfc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frame_midi</span>(mido_import)</span>
<span id="cb3-9">ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mido_import<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat</span>
<span id="cb3-10"></span>
<span id="cb3-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># unnest the dataframe</span></span>
<span id="cb3-12">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_midi</span>(dfc)</span>
<span id="cb3-13"></span>
<span id="cb3-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##############################################</span></span>
<span id="cb3-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert to matrix</span></span>
<span id="cb3-16"></span>
<span id="cb3-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># grab track 1</span></span>
<span id="cb3-18">track_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(i_track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-20">         type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_off"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total_time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(time)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>)</span>
<span id="cb3-23"></span>
<span id="cb3-24">time_steps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>total_time),<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb3-25">total_bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(time_steps)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-26">bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>total_bars,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>)</span>
<span id="cb3-27">bar_steps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>,total_bars)</span>
<span id="cb3-28"></span>
<span id="cb3-29">metric_tibble <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time_steps =</span> time_steps,</span>
<span id="cb3-30">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bars =</span> bars[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(time_steps)],</span>
<span id="cb3-31">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_steps =</span>bar_steps[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(time_steps)])</span>
<span id="cb3-32"></span>
<span id="cb3-33">track_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track_1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time_markers =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-35">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bars =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-36">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_steps =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) </span>
<span id="cb3-37"></span>
<span id="cb3-38"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(track_1)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]){</span>
<span id="cb3-39">  track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time_markers[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(time_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>total_time[i])</span>
<span id="cb3-40">}</span>
<span id="cb3-41"></span>
<span id="cb3-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get bar divisions, add them to track_1</span></span>
<span id="cb3-43"></span>
<span id="cb3-44"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(track_1)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]){</span>
<span id="cb3-45">  get_timestep <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> time_steps[track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time_markers[i]]</span>
<span id="cb3-46">  track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bars[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metric_tibble <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-47">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(time_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> get_timestep) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-48">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(bars)</span>
<span id="cb3-49">  track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bar_steps[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metric_tibble <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-50">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(time_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> get_timestep) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-51">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(bar_steps)</span>
<span id="cb3-52">}</span>
<span id="cb3-53"></span>
<span id="cb3-54"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign intervals to the bars</span></span>
<span id="cb3-55"></span>
<span id="cb3-56">music_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-57">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>)),</span>
<span id="cb3-58">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bars)</span>
<span id="cb3-59">)</span>
<span id="cb3-60"></span>
<span id="cb3-61"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bars)){</span>
<span id="cb3-62">  </span>
<span id="cb3-63">  bar_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-64">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(bars <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> i)</span>
<span id="cb3-65">  </span>
<span id="cb3-66">  one_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-67">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>midi_defs)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb3-68">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>)</span>
<span id="cb3-69">  </span>
<span id="cb3-70">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(j <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(one_bar)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]){</span>
<span id="cb3-71">    one_bar[bar_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note[j],bar_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bar_steps[j]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-72">  }</span>
<span id="cb3-73">  </span>
<span id="cb3-74">  </span>
<span id="cb3-75">  pitch_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowSums</span>(one_bar)</span>
<span id="cb3-76">  time_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(one_bar)</span>
<span id="cb3-77">  pitch_by_time <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(one_bar)</span>
<span id="cb3-78"></span>
<span id="cb3-79">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#concatenate_vector</span></span>
<span id="cb3-80">  music_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(pitch_vector,time_vector,pitch_by_time)</span>
<span id="cb3-81">  </span>
<span id="cb3-82">  music_matrix[i,] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> music_vector</span>
<span id="cb3-83">  </span>
<span id="cb3-84">}</span></code></pre></div>
</details>
</div>
<section id="the-first-bar-of-the-midi-file" class="level3">
<h3 class="anchored" data-anchor-id="the-first-bar-of-the-midi-file">The first bar of the midi file</h3>
<p>The table shows a tibble of the first bar. Ive added a few columns to code which bars the notes are occurring (not represented in a midi file), along with when each note occurs inside the bar. In this case, Im using 8 ticks as the smallest unit of time inside a bar.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">first_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track_1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(bars <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-3">knitr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(first_bar)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 5%">
<col style="width: 6%">
<col style="width: 9%">
<col style="width: 15%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 3%">
<col style="width: 2%">
<col style="width: 4%">
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 2%">
<col style="width: 5%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">i_track</th>
<th style="text-align: left;">meta</th>
<th style="text-align: left;">type</th>
<th style="text-align: left;">name</th>
<th style="text-align: right;">time</th>
<th style="text-align: right;">numerator</th>
<th style="text-align: right;">denominator</th>
<th style="text-align: right;">clocks_per_click</th>
<th style="text-align: right;">notated_32nd_notes_per_beat</th>
<th style="text-align: right;">program</th>
<th style="text-align: right;">channel</th>
<th style="text-align: right;">control</th>
<th style="text-align: right;">value</th>
<th style="text-align: right;">note</th>
<th style="text-align: right;">velocity</th>
<th style="text-align: right;">total_time</th>
<th style="text-align: right;">time_markers</th>
<th style="text-align: right;">bars</th>
<th style="text-align: right;">bar_steps</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">50</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">66</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">76</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">50</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">66</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">76</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">32</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">50</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">66</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">76</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">32</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">50</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">120</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">16</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">66</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">120</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">16</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">120</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">16</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">50</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">144</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">19</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">66</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">144</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">19</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">76</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">144</td>
<td style="text-align: right;">19</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">19</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">32</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">192</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">25</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">192</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">25</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">79</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">192</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">25</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">80</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">55</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">288</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">37</td>
</tr>
<tr class="even">
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">note_on</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">288</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">37</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="bags-of-notes-representation" class="level3">
<h3 class="anchored" data-anchor-id="bags-of-notes-representation">Bags of notes representation</h3>
<p>The big code chunk has a loop that processes all bars into a vector representation. Below, I unpack this and describe each step.</p>
<p>This code chunk takes the notes from a midi tibble that pertain to a single bar (e.g., the table above), creates an empty note by time interval matrix, and then assigns the notes in the bar to their respective intervals.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># take a bar from the tibble</span></span>
<span id="cb5-2">bar_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> first_bar</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make a note by time unit matrix</span></span>
<span id="cb5-5">one_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb5-6">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>midi_defs)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb5-7">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>)</span>
<span id="cb5-8"></span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign 1s to note locations in time</span></span>
<span id="cb5-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (j <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(one_bar)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) {</span>
<span id="cb5-11">  one_bar[bar_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note[j], bar_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bar_steps[j]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb5-12">}</span></code></pre></div>
</details>
</div>
<p>The note x time matrix is 128 rows by 48 columns. There are 0-127 possible notes in MIDI, and I divided one bar (4/4 time) into 48 individual slices of time. The note occurrences in the first bar of mario are coded as 1s in the matrix.</p>
<p>Here is a plot of the matrix showing note locations. It looks like a typical piano roll.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(plot.matrix)</span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(one_bar)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://homophony.quest/blog/37_2_5_24_matrix_analysis/index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="counting-and-concatenating" class="level3">
<h3 class="anchored" data-anchor-id="counting-and-concatenating">Counting and concatenating</h3>
<p>I create three vectors that will be appended together as the final feature vector for a bar of music.</p>
<p>The first two are frequency summarizers. The pitch vector takes the sum across the rows of the matrix. This yields a single vector with 128 elements corresponding to each note. The values are simply the counts of each note in the bar. The time vector takes the column sums, and provides a count of each temporal unit occurrence in the matrix. These summary representations will be useful later on for conditionalizing sequence generation based on notes and time in general.</p>
<p>The last vector concatenates the matrix into a single vector by starting at the first column, and then appending column after column, until the matrix is one long vector.</p>
<p>Finally, I append the pitch vector, the time vector, and the pitch x time vector into a single vector, called the music vector.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">pitch_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowSums</span>(one_bar)</span>
<span id="cb7-2">time_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(one_bar)</span>
<span id="cb7-3">pitch_by_time <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(one_bar)</span>
<span id="cb7-4"></span>
<span id="cb7-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#concatenate_vector</span></span>
<span id="cb7-6">music_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(pitch_vector, time_vector, pitch_by_time)</span></code></pre></div>
</details>
</div>
</section>
<section id="the-music-matrix" class="level3">
<h3 class="anchored" data-anchor-id="the-music-matrix">The music matrix</h3>
<p>The above steps are applied to all of the bars in a midi file, and the resulting music feature vector is added to a matrix. For mario, I get a 37 (bars) by 6320 (features) matrix.</p>
<p>Oooh, and it can be plotted! Hurrah for the <code>plot.matrix</code> library!</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(plot.matrix)</span>
<span id="cb8-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(music_matrix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">border=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>))</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://homophony.quest/blog/37_2_5_24_matrix_analysis/index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="1920"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="probabilistic-generation" class="level2">
<h2 class="anchored" data-anchor-id="probabilistic-generation">Probabilistic generation</h2>
<p>The above matrix has a few different properties, but the main one is that it counts how often particular notes occur in particular units of time across all of the bars of music. And, aside from the fact that I threw out the the note off information, this matrix representation is pretty much the same as the original MIDI file, so it is possible to convert back to a MIDI file from this matrix representation.</p>
<p>However, the matrix representation provides interesting opportunities for manipulating MIDI. Today I am focusing on generating sequences from the statistical structure of a musical corpus. Ill take the above matrix as a small corpus of musical bars.</p>
<section id="note-x-time-probabilities" class="level3">
<h3 class="anchored" data-anchor-id="note-x-time-probabilities">Note x time probabilities</h3>
<p>In previous posts where I generated some mario-esque sequences, I only got as far as generating them based on fairly simple, unconditionalized probabilities.</p>
<p>For example, columns 177 to 6320 in the music matrix contain the note x time frequency vectors for each bar. We can compute the total number of occurrences of all individual features by summing that whole part of the matrix. The answer is 901 note x time features occurred across all of mario.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">total_sum <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(music_matrix[,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(music_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb9-2">total_sum</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 901</code></pre>
</div>
</div>
<p>What about individual note x time features, how often did they occur? We can compute the column sums. This vector has too many numbers to print, but heres a sense of how it looks (y-axis is frequency counts).</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">note_times_sum <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(music_matrix[,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(music_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb11-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(note_times_sum)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://homophony.quest/blog/37_2_5_24_matrix_analysis/index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="1920"></p>
</figure>
</div>
</div>
</div>
<p>Dividing the column sums by the total sum gives a vector of proportions that sum to 1.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">note_times_prob <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> note_times_sum<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>total_sum</span>
<span id="cb12-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(note_times_prob)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
</div>
<p>The vector of proportions can be treated as probabilities and used to generate new notes in time based on this statistical structure. R has a convenient function for this called <code>rbinom()</code>. The goal is to produce a vector with the same length as the probability vector, but populated with 1s and 0s, where the 1 is a note occurrence and a 0 is the absence of a note.</p>
<p>This code chunk generates a new vector of note x time features based on the probabilities, restores the vector to a matrix format, and then plots the matrix of notes as a piano roll.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># generate new vector based on probabilities</span></span>
<span id="cb14-2">new_sequence <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(note_times_prob),</span>
<span id="cb14-3">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,</span>
<span id="cb14-4">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> note_times_prob)</span>
<span id="cb14-5"></span>
<span id="cb14-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ensure any element greater than 1 is set to 1</span></span>
<span id="cb14-7">new_sequence[new_sequence <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb14-8"></span>
<span id="cb14-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb14-10">new_sequence_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(</span>
<span id="cb14-11">  new_sequence,</span>
<span id="cb14-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>,</span>
<span id="cb14-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,</span>
<span id="cb14-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow =</span> F</span>
<span id="cb14-15">)</span>
<span id="cb14-16"></span>
<span id="cb14-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(plot.matrix)</span>
<span id="cb14-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(new_sequence_matrix)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://homophony.quest/blog/37_2_5_24_matrix_analysis/index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>The new sequence is generated from independent probabilities. Essentially every note is sampled based on the probability that it appeared in a particular time slot across the whole corpus of bars. This creates a sonic mishmash where very global statistics of how notes appear in time across bars determine which notes get sampled and when they are placed in time.</p>
<p>The size parameter of the <code>rbinom()</code> function controls how many trials are simulated by the binomial sampling process, which controls the total number of notes sampled into a new bar.</p>
<p>One option is to set the size parameter to the mean number of notes that are found per bar in the corpus. I get about 24.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowSums</span>(music_matrix[,(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(music_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]]))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 24.35135</code></pre>
</div>
</div>
<p>And, using 24 as the size parameter generates new bars that should have some more notes:</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># generate new vector based on probabilities</span></span>
<span id="cb17-2">new_sequence <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(note_times_prob),</span>
<span id="cb17-3">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>,</span>
<span id="cb17-4">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> note_times_prob)</span>
<span id="cb17-5"></span>
<span id="cb17-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ensure any element greater than 1 is set to 1</span></span>
<span id="cb17-7">new_sequence[new_sequence <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb17-8"></span>
<span id="cb17-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb17-10">new_sequence_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(</span>
<span id="cb17-11">  new_sequence,</span>
<span id="cb17-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>,</span>
<span id="cb17-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,</span>
<span id="cb17-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow =</span> F</span>
<span id="cb17-15">)</span>
<span id="cb17-16"></span>
<span id="cb17-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(plot.matrix)</span>
<span id="cb17-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(new_sequence_matrix)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://homophony.quest/blog/37_2_5_24_matrix_analysis/index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Or, this one has a size of 48, and starts looking even more busy:</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># generate new vector based on probabilities</span></span>
<span id="cb18-2">new_sequence <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(note_times_prob),</span>
<span id="cb18-3">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>,</span>
<span id="cb18-4">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> note_times_prob)</span>
<span id="cb18-5"></span>
<span id="cb18-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ensure any element greater than 1 is set to 1</span></span>
<span id="cb18-7">new_sequence[new_sequence <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb18-8"></span>
<span id="cb18-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb18-10">new_sequence_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(</span>
<span id="cb18-11">  new_sequence,</span>
<span id="cb18-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>,</span>
<span id="cb18-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,</span>
<span id="cb18-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow =</span> F</span>
<span id="cb18-15">)</span>
<span id="cb18-16"></span>
<span id="cb18-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(plot.matrix)</span>
<span id="cb18-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(new_sequence_matrix)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://homophony.quest/blog/37_2_5_24_matrix_analysis/index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="a-eurorack-digression" class="level3">
<h3 class="anchored" data-anchor-id="a-eurorack-digression">A eurorack digression</h3>
<p>As a quick side note, in terms of sonic exploration, it would be so fun to get matrix manipulation of midi for probabilistic sequence generation into a eurorack format.</p>
<p>One of my favorite modules to play with is Marbles by Mutable Instruments.</p>
<p><img src="https://homophony.quest/blog/37_2_5_24_matrix_analysis/images/mutableinstruments_marbles_01_1_1.jpg" class="img-fluid"></p>
<p>This module is a random CV generator for time and pitch, and it can do some things in the direction Im headed. For example, you can play in a series of notes, and it will calculate pitch frequencies, and then playback notes based on the sampled frequencies. Thats pretty cool.</p>
<p>The documentation for Marbles even hints at a secret markov mode which is more similar to what Im doing here:</p>
<p><a href="https://pichenettes.github.io/mutable-instruments-documentation/modules/marbles/secrets/" class="uri">https://pichenettes.github.io/mutable-instruments-documentation/modules/marbles/secrets/</a></p>
<p>Once I figure out what Im doing in R, I wonder how easy it would be to get these algorithms working in a eurorack modulehmmm.</p>
</section>
</section>
<section id="alternative-note-and-time-feature-generation" class="level2">
<h2 class="anchored" data-anchor-id="alternative-note-and-time-feature-generation">Alternative note and time feature generation</h2>
<p>The matrix of bars also has pitch vectors and time vectors that summarize counts within their respective dimensions. These vectors can be turned into probabilistic generators as well.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">pitch_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(music_matrix[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(music_matrix[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>])</span>
<span id="cb19-2"></span>
<span id="cb19-3">time_probabilities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(music_matrix[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">129</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>)])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(music_matrix[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">129</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>)])</span>
<span id="cb19-4"></span>
<span id="cb19-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get new pitches</span></span>
<span id="cb19-6">new_pitches <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(pitch_probabilities),</span>
<span id="cb19-7">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>,</span>
<span id="cb19-8">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> pitch_probabilities)</span>
<span id="cb19-9">new_pitches[new_pitches <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb19-10"></span>
<span id="cb19-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get new times</span></span>
<span id="cb19-12">new_times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(time_probabilities),</span>
<span id="cb19-13">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>,</span>
<span id="cb19-14">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> time_probabilities)</span>
<span id="cb19-15">new_times[new_times <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb19-16"></span>
<span id="cb19-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get row column ids</span></span>
<span id="cb19-18">sampled_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(new_pitches <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb19-19">sampled_times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(new_times <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb19-20"></span>
<span id="cb19-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># combine, make sure equal length</span></span>
<span id="cb19-22"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_notes) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_times)){</span>
<span id="cb19-23">  sampled_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notes =</span> sampled_notes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_times)],</span>
<span id="cb19-24">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> sampled_times)</span>
<span id="cb19-25">} <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb19-26">  sampled_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notes =</span> sampled_notes,</span>
<span id="cb19-27">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> sampled_times[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sampled_notes)])</span>
<span id="cb19-28">}</span>
<span id="cb19-29"></span>
<span id="cb19-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shuffle the notes across the times so the sampling is uniform</span></span>
<span id="cb19-31">sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>notes)</span>
<span id="cb19-32"></span>
<span id="cb19-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make a note by time unit matrix</span></span>
<span id="cb19-34">one_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb19-35">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>midi_defs)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb19-36">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>)</span>
<span id="cb19-37"></span>
<span id="cb19-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign 1s to note locations in time</span></span>
<span id="cb19-39"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(sampled_ids)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) {</span>
<span id="cb19-40">  one_bar[sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>notes[i], sampled_ids<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>times[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb19-41">}</span>
<span id="cb19-42"></span>
<span id="cb19-43"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(plot.matrix)</span>
<span id="cb19-44"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(one_bar)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://homophony.quest/blog/37_2_5_24_matrix_analysis/index_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>This should produce sequences that reflect even more general statistical structure from the corpus. I havent tried listening to lots of bars generated this way. Something to look forward to :)</p>
</section>
<section id="conditionalized-sampling" class="level2">
<h2 class="anchored" data-anchor-id="conditionalized-sampling">Conditionalized sampling</h2>
<p>So far Ive looked at fairly global note and time probabilities. Its possible to conditionalize these probabilities by other events. For example, given that the first note in a bar is in the first time step, and that the first note is MIDI note 50, what are the probabilities of other notes in time?</p>
<p>One way to do this is to first filter the music matrix for only rows containing features to conditionalize on (e.g., only rows where the first note is MIDI note 50 in the first time slot.), and then compute the probabilities based on the filter matrix. In the case of mario, we only have 30+ bars of music, which doesnt give a great estimate of the probabilities.</p>
<p>At the same time, I could change the size of matrix and ask different questions. Currently, the matrix is set up to ask questions about a whole bar of notes. For example, I could ask the question, given the first note is MIDI 50, what are the probabilities for all of the remaining notes in the whole bar.</p>
<p>The matrix could be re-arranged in larger or smaller collections of time. Lets try re-arranging the matrix in slices of 1 beat instead of 1 bar. This will produce many more bags of notes than we currently have, and should do a better job of capturing local statistics for note-to-note transitions.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this can be improved, but works for now</span></span>
<span id="cb20-2"></span>
<span id="cb20-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(music_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) {</span>
<span id="cb20-4">  extract_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> music_matrix[i, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(music_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]]</span>
<span id="cb20-5">  </span>
<span id="cb20-6">  bar_to_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(extract_bar,</span>
<span id="cb20-7">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>,</span>
<span id="cb20-8">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,</span>
<span id="cb20-9">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow =</span> F)</span>
<span id="cb20-10">  </span>
<span id="cb20-11">  divisions <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb20-12">  </span>
<span id="cb20-13">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (j <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(divisions)) {</span>
<span id="cb20-14">    beat_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> bar_to_matrix[, divisions[j]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(divisions[j] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)]</span>
<span id="cb20-15">    beat_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(beat_vector)</span>
<span id="cb20-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> j <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb20-17">      beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(beat_vector))</span>
<span id="cb20-18">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb20-19">      beat_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(beat_matrix, beat_vector)</span>
<span id="cb20-20">    }</span>
<span id="cb20-21">  }</span>
<span id="cb20-22">  </span>
<span id="cb20-23">}</span></code></pre></div>
</details>
</div>
<p>A plot of the new beats matrix, with 4 times as many rows as before.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(plot.matrix)</span>
<span id="cb21-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(beat_matrix, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">border=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>))</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://homophony.quest/blog/37_2_5_24_matrix_analysis/index_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Id like to contrast probabilistic playback from this matrix in general versus condtionalized on some starting notes.</p>
<section id="general-probabilistic-sampling-from-beat-matrix" class="level3">
<h3 class="anchored" data-anchor-id="general-probabilistic-sampling-from-beat-matrix">General probabilistic sampling from beat matrix</h3>
<p>Im going to repeat some steps from before. This is where I wish I had some functions to do this quickly. However, this lengthy note-book style approach is also helping me understand what I might functionalize later.</p>
<p>This code chunk should generate a new beats worth of notes every time it is run.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">total_sum <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(beat_matrix[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(beat_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb22-2">note_times_sum <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(beat_matrix[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(beat_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb22-3">note_times_prob <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> note_times_sum<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>total_sum</span>
<span id="cb22-4"></span>
<span id="cb22-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#mean(rowSums(beat_matrix[,1:dim(beat_matrix)[2]]))</span></span>
<span id="cb22-6"></span>
<span id="cb22-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># generate new vector based on probabilities</span></span>
<span id="cb22-8">new_sequence <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(note_times_prob),</span>
<span id="cb22-9">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,</span>
<span id="cb22-10">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> note_times_prob)</span>
<span id="cb22-11"></span>
<span id="cb22-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ensure any element greater than 1 is set to 1</span></span>
<span id="cb22-13">new_sequence[new_sequence <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb22-14"></span>
<span id="cb22-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb22-16">new_sequence_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(</span>
<span id="cb22-17">  new_sequence,</span>
<span id="cb22-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>,</span>
<span id="cb22-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,</span>
<span id="cb22-20">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow =</span> F</span>
<span id="cb22-21">)</span>
<span id="cb22-22"></span>
<span id="cb22-23"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(new_sequence_matrix)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://homophony.quest/blog/37_2_5_24_matrix_analysis/index_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="conditionalized-sampling-on-starting-notes" class="level3">
<h3 class="anchored" data-anchor-id="conditionalized-sampling-on-starting-notes">Conditionalized sampling on starting notes</h3>
<p>This example conditions on some starting notes.</p>
<p>The first three notes in mario overworld are a chord composed of MIDI notes 50, 66, and 70.</p>
<p>The following code grabs only the rows in the beat matrix that have these exact notes in the first time unit. The, new note x time probabilities are calculated from the reduced matrix, and then used to generate a new beats worth of notes. This type of sequence should be much more similar to the rows from which it was composed, compared to all rows in general.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create conditional vector</span></span>
<span id="cb23-2">conditional_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(beat_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb23-3">conditional_vector[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">66</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> </span>
<span id="cb23-4"></span>
<span id="cb23-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute cosine to find same items</span></span>
<span id="cb23-6">similarities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> RsemanticLibrarian<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cosine_x_to_m</span>(conditional_vector,beat_matrix)</span>
<span id="cb23-7"></span>
<span id="cb23-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># choose only rows that have the conditional vector in them</span></span>
<span id="cb23-9">conditionalized_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> beat_matrix[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(similarities <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),]</span>
<span id="cb23-10"></span>
<span id="cb23-11">total_sum <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(conditionalized_matrix[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(conditionalized_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb23-12">note_times_sum <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(conditionalized_matrix[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(conditionalized_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb23-13">note_times_prob <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> note_times_sum<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>total_sum</span>
<span id="cb23-14"></span>
<span id="cb23-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#mean(rowSums(beat_matrix[,1:dim(beat_matrix)[2]]))</span></span>
<span id="cb23-16"></span>
<span id="cb23-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># generate new vector based on probabilities</span></span>
<span id="cb23-18">new_sequence <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(note_times_prob),</span>
<span id="cb23-19">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,</span>
<span id="cb23-20">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> note_times_prob)</span>
<span id="cb23-21"></span>
<span id="cb23-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ensure any element greater than 1 is set to 1</span></span>
<span id="cb23-23">new_sequence[new_sequence <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb23-24"></span>
<span id="cb23-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#</span></span>
<span id="cb23-26">new_sequence_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(</span>
<span id="cb23-27">  new_sequence,</span>
<span id="cb23-28">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>,</span>
<span id="cb23-29">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,</span>
<span id="cb23-30">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow =</span> F</span>
<span id="cb23-31">)</span>
<span id="cb23-32"></span>
<span id="cb23-33"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(new_sequence_matrix)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://homophony.quest/blog/37_2_5_24_matrix_analysis/index_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="the-end" class="level2">
<h2 class="anchored" data-anchor-id="the-end">The end</h2>
<p>Id like to start listening to these sequences. But, right now the code is pretty clunky to start generating lots of things to listen to. Its probably time to refactor the code into functions so its all more generalizable, clear, and easier to use.</p>
<hr>
<p>And hello again</p>
</section>
<section id="writing-functions" class="level2">
<h2 class="anchored" data-anchor-id="writing-functions">Writing functions</h2>
<p>Im at the point where note-book style code is getting frustrating, and I would like to have some functions at my disposal. Im note quite ready to jump into developing an R package, so Ill try a few things out down here for now.</p>
<section id="importing-midi" class="level3">
<h3 class="anchored" data-anchor-id="importing-midi">importing midi</h3>
<p>I would just use <code>pyramidi::MidiFramer$new(path)</code> but some of my midi files dont have set_tempo, so that fails. Need to wrap a few things and then return them to the global environment.</p>
<p>Not sure it is a good or bad idea to put R6 objects into a list? So far its working.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">midi_to_object <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(file_path) {</span>
<span id="cb24-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi using miditapyr</span></span>
<span id="cb24-3">  miditapyr_object <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFrames</span>(file_path)</span>
<span id="cb24-4">  </span>
<span id="cb24-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import using mido</span></span>
<span id="cb24-6">  mido_object <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>mido<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFile</span>(file_path)</span>
<span id="cb24-7">  </span>
<span id="cb24-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to R dataframe</span></span>
<span id="cb24-9">  message_list_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frame_midi</span>(mido_object)</span>
<span id="cb24-10">  ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mido_object<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat</span>
<span id="cb24-11">  </span>
<span id="cb24-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># unnest the dataframe</span></span>
<span id="cb24-13">  midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_midi</span>(message_list_df)</span>
<span id="cb24-14">  </span>
<span id="cb24-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(</span>
<span id="cb24-16">    midi_import_objects <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb24-17">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">miditapyr_object =</span> miditapyr_object,</span>
<span id="cb24-18">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mido_object =</span> mido_object,</span>
<span id="cb24-19">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">message_list_df =</span> message_list_df,</span>
<span id="cb24-20">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ticks_per_beat =</span> ticks_per_beat,</span>
<span id="cb24-21">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">midi_df =</span> midi_df</span>
<span id="cb24-22">    )</span>
<span id="cb24-23">  )</span>
<span id="cb24-24">}</span>
<span id="cb24-25"></span>
<span id="cb24-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># test function</span></span>
<span id="cb24-27">midi_import_objects <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb24-28"></span>
<span id="cb24-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import objects in list to global environment</span></span>
<span id="cb24-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bad form to put this in the above function?</span></span>
<span id="cb24-31"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(midi_import_objects, .GlobalEnv)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;environment: R_GlobalEnv&gt;</code></pre>
</div>
</div>
</section>
<section id="converting-midi-to-a-feature-vector-matrix." class="level3">
<h3 class="anchored" data-anchor-id="converting-midi-to-a-feature-vector-matrix.">converting midi to a feature vector matrix.</h3>
<p>Im not confident that I have processed enough midi files to know how well any of this will generalize. I might start with small functions</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1">copy_and_extend_midi_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(midi_df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">track_num =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {</span>
<span id="cb26-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Select a particular track from the midi file</span></span>
<span id="cb26-3">  copy_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi_df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(i_track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> track_num,</span>
<span id="cb26-5">           type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_off"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add column to sum cumulative time</span></span>
<span id="cb26-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total_time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(time)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># return only note_on</span></span>
<span id="cb26-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>)</span>
<span id="cb26-10">  </span>
<span id="cb26-11">}</span>
<span id="cb26-12"></span>
<span id="cb26-13">track_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_and_extend_midi_df</span>(midi_df, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb26-14"></span>
<span id="cb26-15"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">########################################</span></span>
<span id="cb26-16"></span>
<span id="cb26-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># work out new time divisions</span></span>
<span id="cb26-18"></span>
<span id="cb26-19">make_metric_tibble <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df, ticks_per_beat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bars=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_tick=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span> ) {</span>
<span id="cb26-20">  </span>
<span id="cb26-21">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(smallest_tick) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>){</span>
<span id="cb26-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if not set by user</span></span>
<span id="cb26-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set smallest temporal unit to smallest observed unit in time column</span></span>
<span id="cb26-24">    smallest_tick <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time[df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb26-25">  }</span>
<span id="cb26-26">  </span>
<span id="cb26-27">  time_steps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>total_time), smallest_tick)</span>
<span id="cb26-28">  </span>
<span id="cb26-29">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(bars) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>){</span>
<span id="cb26-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># only 4/4 for now</span></span>
<span id="cb26-31">    bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>total_time)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(ticks_per_beat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb26-32">  }</span>
<span id="cb26-33">  </span>
<span id="cb26-34">  total_bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(time_steps) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> bars) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb26-35">  bar_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>total_bars, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> bars)</span>
<span id="cb26-36">  bar_steps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>bars, total_bars)</span>
<span id="cb26-37">  </span>
<span id="cb26-38">  metric_tibble <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time_steps =</span> time_steps,</span>
<span id="cb26-39">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bars =</span> bar_vector[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(time_steps)],</span>
<span id="cb26-40">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_steps =</span> bar_steps[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(time_steps)])</span>
<span id="cb26-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(metric_tibble)</span>
<span id="cb26-42">}</span>
<span id="cb26-43"></span>
<span id="cb26-44">metric_tibble <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_metric_tibble</span>(track_1,</span>
<span id="cb26-45">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ticks_per_beat =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span>,</span>
<span id="cb26-46">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bars =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>,</span>
<span id="cb26-47">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_tick =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb26-48"></span>
<span id="cb26-49"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##########################################</span></span>
<span id="cb26-50"></span>
<span id="cb26-51">add_bars_to_copy_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df, metric_tibble) {</span>
<span id="cb26-52">  </span>
<span id="cb26-53">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add new columns</span></span>
<span id="cb26-54">  df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-55">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time_markers =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb26-56">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bars =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb26-57">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_steps =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb26-58">  </span>
<span id="cb26-59">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(df)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) {</span>
<span id="cb26-60">    df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time_markers[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb26-61">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(metric_tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>total_time[i])</span>
<span id="cb26-62">  }</span>
<span id="cb26-63">  </span>
<span id="cb26-64">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get bar divisions, add them to df</span></span>
<span id="cb26-65">  </span>
<span id="cb26-66">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(df)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) {</span>
<span id="cb26-67">    get_timestep <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metric_tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time_steps[df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time_markers[i]]</span>
<span id="cb26-68">    </span>
<span id="cb26-69">    df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bars[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metric_tibble <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-70">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(time_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> get_timestep) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-71">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(bars)</span>
<span id="cb26-72">    </span>
<span id="cb26-73">    df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bar_steps[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metric_tibble <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-74">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(time_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> get_timestep) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-75">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(bar_steps)</span>
<span id="cb26-76">  }</span>
<span id="cb26-77">  </span>
<span id="cb26-78">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(df)</span>
<span id="cb26-79">}</span>
<span id="cb26-80"></span>
<span id="cb26-81">track_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_bars_to_copy_df</span>(track_1,metric_tibble)</span>
<span id="cb26-82"></span>
<span id="cb26-83"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##########################################</span></span>
<span id="cb26-84"></span>
<span id="cb26-85"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create the matrix</span></span>
<span id="cb26-86"></span>
<span id="cb26-87">create_midi_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_notes =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intervals_per_bar =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>){</span>
<span id="cb26-88">  </span>
<span id="cb26-89">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#initialize matrix</span></span>
<span id="cb26-90">  music_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb26-91">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> (intervals_per_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>num_notes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>(intervals_per_bar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>num_notes)),</span>
<span id="cb26-92">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bars)</span>
<span id="cb26-93">                       )</span>
<span id="cb26-94"></span>
<span id="cb26-95">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#loop to assign note_ons to </span></span>
<span id="cb26-96">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bars)) {</span>
<span id="cb26-97">    </span>
<span id="cb26-98">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the bar </span></span>
<span id="cb26-99">    bar_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb26-100">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(bars <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> i)</span>
<span id="cb26-101">    </span>
<span id="cb26-102">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make a temporary little matrix</span></span>
<span id="cb26-103">    one_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb26-104">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> num_notes,</span>
<span id="cb26-105">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> intervals_per_bar)</span>
<span id="cb26-106">    </span>
<span id="cb26-107">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign 1s to note positions</span></span>
<span id="cb26-108">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (j <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(one_bar)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) {</span>
<span id="cb26-109">      one_bar[bar_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note[j], bar_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bar_steps[j]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb26-110">    }</span>
<span id="cb26-111">    </span>
<span id="cb26-112">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get summary vectors</span></span>
<span id="cb26-113">    pitch_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowSums</span>(one_bar)</span>
<span id="cb26-114">    time_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(one_bar)</span>
<span id="cb26-115">    pitch_by_time <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(one_bar)</span>
<span id="cb26-116">    </span>
<span id="cb26-117">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#concatenate_vector</span></span>
<span id="cb26-118">    music_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(pitch_vector, time_vector, pitch_by_time)</span>
<span id="cb26-119">    </span>
<span id="cb26-120">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add to matrix</span></span>
<span id="cb26-121">    music_matrix[i, ] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> music_vector</span>
<span id="cb26-122">    </span>
<span id="cb26-123">  }</span>
<span id="cb26-124">  </span>
<span id="cb26-125">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(music_matrix)</span>
<span id="cb26-126">  </span>
<span id="cb26-127">}</span>
<span id="cb26-128"></span>
<span id="cb26-129">music_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create_midi_matrix</span>(track_1,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>)</span></code></pre></div>
</details>
</div>
<p>Starting to look more manageable. Testing the functions so far.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import</span></span>
<span id="cb27-2">midi_import_objects <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">midi_to_object</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb27-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list2env</span>(midi_import_objects, .GlobalEnv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add to global env</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;environment: R_GlobalEnv&gt;</code></pre>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># extract midi df and add new timing information</span></span>
<span id="cb29-2">track_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">copy_and_extend_midi_df</span>(midi_df, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb29-3"></span>
<span id="cb29-4">metric_tibble <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_metric_tibble</span>(track_1,</span>
<span id="cb29-5">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ticks_per_beat =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span>,</span>
<span id="cb29-6">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bars =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>,</span>
<span id="cb29-7">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smallest_tick =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb29-8"></span>
<span id="cb29-9">track_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_bars_to_copy_df</span>(track_1,metric_tibble)</span>
<span id="cb29-10"></span>
<span id="cb29-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert all bars to a feature vector matrix, with one bar per row.</span></span>
<span id="cb29-12">music_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create_midi_matrix</span>(track_1,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>)</span></code></pre></div>
</details>
</div>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-hintzman1984" class="csl-entry">
Hintzman, Douglas L. 1984. <span>MINERVA 2: A Simulation Model of Human Memory.</span> <em>Behavior Research Methods, Instruments, &amp; Computers</em> 16 (2): 96101. <a href="https://doi.org/10.3758/BF03202365">https://doi.org/10.3758/BF03202365</a>.
</div>
<div id="ref-landauer1997" class="csl-entry">
Landauer, Thomas K, and Susan T Dumais. 1997. <span>A Solution to Platos Problem: The Latent Semantic Analysis Theory of Acquisition, Induction, and Representation of Knowledge.</span> <em>Psychological Review</em> 104: 21140. <a href="https://doi.org/dcpw35">https://doi.org/dcpw35</a>.
</div>
</div></section></div> ]]></description>
  <category>midi</category>
  <category>nlp</category>
  <category>matrix</category>
  <category>rstats</category>
  <guid>https://homophony.quest/blog/37_2_5_24_matrix_analysis/</guid>
  <pubDate>Mon, 05 Feb 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/37_2_5_24_matrix_analysis/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Messing around with heart and soul</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/36_2_4_24_heart_soul/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heart and soul piano duet. probabilities. linear algebra. markov chain. thundercats cartoon."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/36_2_4_24_heart_soul/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>heart and soul piano duet. probabilities. linear algebra. markov chain. thundercats cartoon. - Dreamshaper v7</p>
</div></div><p>Im following similar steps <a href="https://homophony.quest/blog/35_2_3_24_matrix_midi/">from this post</a>, but with my own noodling around playing heart and soul on piano.</p>
<p>Notes:</p>
<ol type="1">
<li>Riff on Heart and Soul on midi piano, BPM 103</li>
<li>Load in midi</li>
</ol>
<ul>
<li>check if i need to quantize it.</li>
</ul>
<ol start="3" type="1">
<li>Turn it into a matrix</li>
<li>Generate notes probabilistically</li>
<li>listen to it</li>
</ol>
<section id="try-stuff" class="level2">
<h2 class="anchored" data-anchor-id="try-stuff">Try stuff</h2>
<ul>
<li>ticks per beat is 96</li>
<li>going with temporal units down to smallest tick (1).</li>
<li>got it working, ya</li>
<li>generate 1 minute of heart and soul nonsense with nintendo synth sound for fun</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pyramidi)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(purrr)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi using miditapyr</span></span>
<span id="cb3-2">test_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFrames</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heart_soul_103_185b.mid"</span>)</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import using mido</span></span>
<span id="cb3-5">mido_import <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>mido<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFile</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heart_soul_103_185b.mid"</span>)</span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to R dataframe</span></span>
<span id="cb3-8">dfc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frame_midi</span>(mido_import)</span>
<span id="cb3-9">ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mido_import<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat</span>
<span id="cb3-10"></span>
<span id="cb3-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># unnest the dataframe</span></span>
<span id="cb3-12">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_midi</span>(dfc)</span>
<span id="cb3-13"></span>
<span id="cb3-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##############################################</span></span>
<span id="cb3-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert to matrix</span></span>
<span id="cb3-16"></span>
<span id="cb3-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># grab track 1</span></span>
<span id="cb3-18">track_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(i_track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-20">         type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_off"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total_time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(time)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>)</span>
<span id="cb3-23"></span>
<span id="cb3-24">time_steps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>total_time),<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-25">total_bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(time_steps)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-26">bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>total_bars,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb3-27">bar_steps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),total_bars)</span>
<span id="cb3-28"></span>
<span id="cb3-29">metric_tibble <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time_steps =</span> time_steps,</span>
<span id="cb3-30">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bars =</span> bars[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(time_steps)],</span>
<span id="cb3-31">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_steps =</span>bar_steps[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(time_steps)])</span>
<span id="cb3-32"></span>
<span id="cb3-33">track_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track_1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time_markers =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-35">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bars =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-36">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_steps =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) </span>
<span id="cb3-37"></span>
<span id="cb3-38"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(track_1)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]){</span>
<span id="cb3-39">  track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time_markers[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(time_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>total_time[i])</span>
<span id="cb3-40">}</span>
<span id="cb3-41"></span>
<span id="cb3-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get bar divisions, add them to track_1</span></span>
<span id="cb3-43"></span>
<span id="cb3-44"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(track_1)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]){</span>
<span id="cb3-45">  get_timestep <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> time_steps[track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time_markers[i]]</span>
<span id="cb3-46">  track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bars[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metric_tibble <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-47">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(time_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> get_timestep) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-48">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(bars)</span>
<span id="cb3-49">  track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bar_steps[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metric_tibble <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-50">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(time_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> get_timestep) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-51">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(bar_steps)</span>
<span id="cb3-52">}</span>
<span id="cb3-53"></span>
<span id="cb3-54"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign intervals to the bars</span></span>
<span id="cb3-55"></span>
<span id="cb3-56">music_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-57">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> ((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>)),</span>
<span id="cb3-58">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bars)</span>
<span id="cb3-59">)</span>
<span id="cb3-60"></span>
<span id="cb3-61"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bars)){</span>
<span id="cb3-62">  </span>
<span id="cb3-63">  bar_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-64">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(bars <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> i)</span>
<span id="cb3-65">  </span>
<span id="cb3-66">  one_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-67">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>midi_defs)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb3-68">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb3-69">  </span>
<span id="cb3-70">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(j <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(one_bar)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]){</span>
<span id="cb3-71">    one_bar[bar_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note[j],bar_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bar_steps[j]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-72">  }</span>
<span id="cb3-73">  </span>
<span id="cb3-74">  </span>
<span id="cb3-75">  pitch_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowSums</span>(one_bar)</span>
<span id="cb3-76">  time_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(one_bar)</span>
<span id="cb3-77">  pitch_by_time <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(one_bar)</span>
<span id="cb3-78"></span>
<span id="cb3-79">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#concatenate_vector</span></span>
<span id="cb3-80">  music_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(pitch_vector,time_vector,pitch_by_time)</span>
<span id="cb3-81">  </span>
<span id="cb3-82">  music_matrix[i,] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> music_vector</span>
<span id="cb3-83">  </span>
<span id="cb3-84">}</span>
<span id="cb3-85"></span>
<span id="cb3-86"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########################################</span></span>
<span id="cb3-87"></span>
<span id="cb3-88"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compose midi tibble</span></span>
<span id="cb3-89">all_midi_bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,]</span>
<span id="cb3-90">all_midi_bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_midi_bars[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,]</span>
<span id="cb3-91"></span>
<span id="cb3-92"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>){</span>
<span id="cb3-93"></span>
<span id="cb3-94">sum_music <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(music_matrix)</span>
<span id="cb3-95">sum_music <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sum_music[((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sum_music)]</span>
<span id="cb3-96">prob_music <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sum_music<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(sum_music)</span>
<span id="cb3-97"></span>
<span id="cb3-98"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># figure out average number of notes</span></span>
<span id="cb3-99"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#mean(rowSums(music_matrix[,((96*4)+128+1):dim(music_matrix)[2]]))</span></span>
<span id="cb3-100"></span>
<span id="cb3-101"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># note size parameter controls note density in the bar</span></span>
<span id="cb3-102"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 16 is about the average from the song</span></span>
<span id="cb3-103">prob_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sum_music),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>,prob_music)</span>
<span id="cb3-104">prob_bar[prob_bar <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-105"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#sum(prob_bar)</span></span>
<span id="cb3-106"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#plot(prob_bar)</span></span>
<span id="cb3-107"></span>
<span id="cb3-108"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#reconstitute matrix</span></span>
<span id="cb3-109">one_bar_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(prob_bar,</span>
<span id="cb3-110">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,</span>
<span id="cb3-111">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb3-112">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow=</span>F)</span>
<span id="cb3-113"></span>
<span id="cb3-114"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#filter for notes and times</span></span>
<span id="cb3-115">note_times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(one_bar_matrix <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arr.ind=</span>T)</span>
<span id="cb3-116"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(note_times) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_num"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bar_step"</span>)</span>
<span id="cb3-117"></span>
<span id="cb3-118"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert back to midi time in ticks</span></span>
<span id="cb3-119">note_times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(note_times)</span>
<span id="cb3-120">note_times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> note_times <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-121">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ticks =</span> (bar_step <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb3-122">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb3-123">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_on =</span> ticks,</span>
<span id="cb3-124">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off =</span> ticks<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-125">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_off"</span>), </span>
<span id="cb3-126">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>,</span>
<span id="cb3-127">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cumulative_ticks"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-128">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(cumulative_ticks) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-129">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> cumulative_ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(cumulative_ticks, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">default =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb3-130"></span>
<span id="cb3-131">midi_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,]</span>
<span id="cb3-132">midi_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi_bar[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,]</span>
<span id="cb3-133"></span>
<span id="cb3-134">midi_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi_bar <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-135">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> note_times<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type,</span>
<span id="cb3-136">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> note_times<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time,</span>
<span id="cb3-137">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> note_times<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_num) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-138">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb3-139">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-140">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb3-141">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">numerator =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>,</span>
<span id="cb3-142">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">denominator =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>,</span>
<span id="cb3-143">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clocks_per_click =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>,</span>
<span id="cb3-144">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notated_32nd_notes_per_beat =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>,</span>
<span id="cb3-145">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>,</span>
<span id="cb3-146">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>,</span>
<span id="cb3-147">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>,</span>
<span id="cb3-148">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>,</span>
<span id="cb3-149">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-150">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span></span>
<span id="cb3-151">         )</span>
<span id="cb3-152"></span>
<span id="cb3-153">all_midi_bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(all_midi_bars,midi_bar)</span>
<span id="cb3-154"></span>
<span id="cb3-155">}</span>
<span id="cb3-156"></span>
<span id="cb3-157"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get meta messages</span></span>
<span id="cb3-158">meta_midi  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-159">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(meta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb3-160">         i_track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-161">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-162">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb3-163">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-164">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-165">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb3-166">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"set_tempo"</span>,</span>
<span id="cb3-167">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>,</span>
<span id="cb3-168">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.before =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb3-169">  )</span>
<span id="cb3-170"></span>
<span id="cb3-171"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># merge bar midi into full midi file</span></span>
<span id="cb3-172">midi_track <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta_midi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-173">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(all_midi_bars,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.after =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb3-174"></span>
<span id="cb3-175"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##########################</span></span>
<span id="cb3-176"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce</span></span>
<span id="cb3-177"></span>
<span id="cb3-178">mod_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi_track</span>
<span id="cb3-179"></span>
<span id="cb3-180"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update df</span></span>
<span id="cb3-181">test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(mod_df)</span>
<span id="cb3-182"></span>
<span id="cb3-183"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write midi file</span></span>
<span id="cb3-184"></span>
<span id="cb3-185">test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heart_soul_A.mid"</span>)</span>
<span id="cb3-186"></span>
<span id="cb3-187"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb3-188"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce </span></span>
<span id="cb3-189"></span>
<span id="cb3-190">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heart_soul_A"</span></span>
<span id="cb3-191"></span>
<span id="cb3-192">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb3-193">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb3-194">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb3-195"></span>
<span id="cb3-196"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write the midi file to disk</span></span>
<span id="cb3-197"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#miditapyr$write_midi(dfc, ticks_per_beat, midi_name)</span></span>
<span id="cb3-198"></span>
<span id="cb3-199"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb3-200">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/nintendo_soundfont.sf2 {midi_name}'</span>)</span>
<span id="cb3-201"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb3-202"></span>
<span id="cb3-203"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb3-204">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb3-205"></span>
<span id="cb3-206"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb3-207"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb3-208">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb3-209">}</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="heart_soul_A.mp3" type="audio/wav"> </audio></p>
<p>rendered using a nintendo soundfont to increase the ridiculousness of this. It is approaching modem-connecting-to-the-internet-sounds, but too melodic.</p>
</section>
<section id="thoughts" class="level2">
<h2 class="anchored" data-anchor-id="thoughts">thoughts</h2>
<p>The main goal for today was to find out how generalizable my previous code would be to a midi file that I recorded myself playing piano.</p>
<p>I learned that ableton produced midi files with no tempo, so I need to set that myself. Abletons midi files have 96 ticks per beat, at least mine do, I wonder if I can change that.</p>
<p>I played the piano duet heart and soul to a metronome set at 103 BPM. I was pretty messy with the timing, but played stuff all over the keyboard for about 184 bars.</p>
<p>I did not quantize the midi file. The 96 ticks per bar resolution is not great at all, especially in terms of capturing live music performance, so a lot of the rhythm is really messed up (also sloppy playing, whatever). Nevertheless, I ended up with a matrix of 128 notes by (96x4) ticks, for each bar of music.</p>
<p>This is all very cool in terms of getting some of my own playing into a matrix form.</p>
<p>The mp3 above is generated randomly from the note x tick probabilities that I calculated from my overall corpus of bars of notes that I played. It sounds like clown music, ha. At the present time, what is happening is that every note is treated completely independently from each other in terms of probabilistic sampling. Its very busy, and not particularly musical, still mildly interesting. I wonder what this would sound like with way more notes, until it approaches something like white noise. hmmm.</p>
<p>There are a whole bunch more things to try to wrestle these probabilities into something more interesting. But, thats for another day.</p>


</section>

 ]]></description>
  <category>midi</category>
  <category>generative</category>
  <category>matrix</category>
  <category>rstats</category>
  <guid>https://homophony.quest/blog/36_2_4_24_heart_soul/</guid>
  <pubDate>Sun, 04 Feb 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/36_2_4_24_heart_soul/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Midi to matrix representation and probabilistic super mario music with R</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/35_2_3_24_matrix_midi/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"super mario enters the matrix. mario matrix. feature vector encoding. binary representation. pixel art."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/35_2_3_24_matrix_midi/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>super mario enters the matrix. mario matrix. feature vector encoding. binary representation. pixel art. - Dreamshaper v7</p>
</div></div><p>For various reasons Id like to convert midi into a matrix format and back again. In this example, I represent each bar in the midi file in a note x time step matrix. The matrix for each bar is concatenated into a long vector, and the whole song is represented as a bar x feature vector matrix. I then calculate the column sums, and divide by the total to get probabilities for each note x time cell. These probabilities can be used to generate new bars, by randomly creating notes in time as a function of those probabilities. After making new bars, I work backwards to generate midi files from the matrix representations to listen to everything.</p>
<p>I used the mario overworld midi file, and this yields some probabilistic version of the overworld theme.</p>
<p>Heres a picture of roughly whats happening:</p>
<p><img src="https://homophony.quest/blog/35_2_3_24_matrix_midi/images/figure.png" class="img-fluid"></p>
<section id="all-voices" class="level2">
<h2 class="anchored" data-anchor-id="all-voices">all voices</h2>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pyramidi)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(purrr)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi using miditapyr</span></span>
<span id="cb3-2">test_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFrames</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import using mido</span></span>
<span id="cb3-5">mido_import <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>mido<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFile</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"all_overworld.mid"</span>)</span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to R dataframe</span></span>
<span id="cb3-8">dfc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frame_midi</span>(mido_import)</span>
<span id="cb3-9">ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mido_import<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat</span>
<span id="cb3-10"></span>
<span id="cb3-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># unnest the dataframe</span></span>
<span id="cb3-12">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_midi</span>(dfc)</span>
<span id="cb3-13"></span>
<span id="cb3-14"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##############################################</span></span>
<span id="cb3-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert to matrix</span></span>
<span id="cb3-16"></span>
<span id="cb3-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># grab track 1</span></span>
<span id="cb3-18">track_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(i_track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-20">         type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_off"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total_time =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumsum</span>(time)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>)</span>
<span id="cb3-23"></span>
<span id="cb3-24">time_steps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>total_time),<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb3-25">total_bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(time_steps)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-26">bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>total_bars,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>)</span>
<span id="cb3-27">bar_steps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>,total_bars)</span>
<span id="cb3-28"></span>
<span id="cb3-29">metric_tibble <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time_steps =</span> time_steps,</span>
<span id="cb3-30">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bars =</span> bars[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(time_steps)],</span>
<span id="cb3-31">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_steps =</span>bar_steps[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(time_steps)])</span>
<span id="cb3-32"></span>
<span id="cb3-33">track_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track_1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time_markers =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-35">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bars =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-36">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bar_steps =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) </span>
<span id="cb3-37"></span>
<span id="cb3-38"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(track_1)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]){</span>
<span id="cb3-39">  track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time_markers[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(time_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>total_time[i])</span>
<span id="cb3-40">}</span>
<span id="cb3-41"></span>
<span id="cb3-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get bar divisions, add them to track_1</span></span>
<span id="cb3-43"></span>
<span id="cb3-44"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(track_1)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]){</span>
<span id="cb3-45">  get_timestep <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> time_steps[track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time_markers[i]]</span>
<span id="cb3-46">  track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bars[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metric_tibble <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-47">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(time_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> get_timestep) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-48">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(bars)</span>
<span id="cb3-49">  track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bar_steps[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> metric_tibble <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-50">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(time_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> get_timestep) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-51">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(bar_steps)</span>
<span id="cb3-52">}</span>
<span id="cb3-53"></span>
<span id="cb3-54"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign intervals to the bars</span></span>
<span id="cb3-55"></span>
<span id="cb3-56">music_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-57">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>)),</span>
<span id="cb3-58">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bars)</span>
<span id="cb3-59">)</span>
<span id="cb3-60"></span>
<span id="cb3-61"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bars)){</span>
<span id="cb3-62">  </span>
<span id="cb3-63">  bar_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-64">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(bars <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> i)</span>
<span id="cb3-65">  </span>
<span id="cb3-66">  one_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-67">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>midi_defs)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb3-68">                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>)</span>
<span id="cb3-69">  </span>
<span id="cb3-70">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(j <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(one_bar)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]){</span>
<span id="cb3-71">    one_bar[bar_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note[j],bar_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bar_steps[j]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-72">  }</span>
<span id="cb3-73">  </span>
<span id="cb3-74">  </span>
<span id="cb3-75">  pitch_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowSums</span>(one_bar)</span>
<span id="cb3-76">  time_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(one_bar)</span>
<span id="cb3-77">  pitch_by_time <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(one_bar)</span>
<span id="cb3-78"></span>
<span id="cb3-79">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#concatenate_vector</span></span>
<span id="cb3-80">  music_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(pitch_vector,time_vector,pitch_by_time)</span>
<span id="cb3-81">  </span>
<span id="cb3-82">  music_matrix[i,] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> music_vector</span>
<span id="cb3-83">  </span>
<span id="cb3-84">}</span>
<span id="cb3-85"></span>
<span id="cb3-86"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########################################</span></span>
<span id="cb3-87"></span>
<span id="cb3-88"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compose midi tibble</span></span>
<span id="cb3-89">all_midi_bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,]</span>
<span id="cb3-90">all_midi_bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_midi_bars[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,]</span>
<span id="cb3-91"></span>
<span id="cb3-92"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>){</span>
<span id="cb3-93"></span>
<span id="cb3-94">sum_music <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colSums</span>(music_matrix)</span>
<span id="cb3-95">sum_music <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sum_music[(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sum_music)]</span>
<span id="cb3-96">prob_music <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sum_music<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(sum_music)</span>
<span id="cb3-97"></span>
<span id="cb3-98"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># figure out average number of notes</span></span>
<span id="cb3-99"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#mean(rowSums(music_matrix[,(48+128+1):dim(music_matrix)[2]]))</span></span>
<span id="cb3-100"></span>
<span id="cb3-101"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># note size parameter controls note density in the bar</span></span>
<span id="cb3-102"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 24 is about the average from the song</span></span>
<span id="cb3-103">prob_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(sum_music),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>,prob_music)</span>
<span id="cb3-104">prob_bar[prob_bar <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-105"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#sum(prob_bar)</span></span>
<span id="cb3-106"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#plot(prob_bar)</span></span>
<span id="cb3-107"></span>
<span id="cb3-108"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#reconstitute matrix</span></span>
<span id="cb3-109">one_bar_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(prob_bar,</span>
<span id="cb3-110">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>,</span>
<span id="cb3-111">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>,</span>
<span id="cb3-112">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow=</span>F)</span>
<span id="cb3-113"></span>
<span id="cb3-114"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#filter for notes and times</span></span>
<span id="cb3-115">note_times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(one_bar_matrix <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arr.ind=</span>T)</span>
<span id="cb3-116"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(note_times) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_num"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bar_step"</span>)</span>
<span id="cb3-117"></span>
<span id="cb3-118"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert back to midi time in ticks</span></span>
<span id="cb3-119">note_times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(note_times)</span>
<span id="cb3-120">note_times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> note_times <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-121">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ticks =</span> (bar_step <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,</span>
<span id="cb3-122">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb3-123">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_on =</span> ticks,</span>
<span id="cb3-124">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_off =</span> ticks<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-125">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_off"</span>), </span>
<span id="cb3-126">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>,</span>
<span id="cb3-127">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cumulative_ticks"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-128">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(cumulative_ticks) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-129">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> cumulative_ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(cumulative_ticks, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">default =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb3-130"></span>
<span id="cb3-131">midi_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,]</span>
<span id="cb3-132">midi_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi_bar[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,]</span>
<span id="cb3-133"></span>
<span id="cb3-134">midi_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi_bar <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-135">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> note_times<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type,</span>
<span id="cb3-136">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> note_times<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time,</span>
<span id="cb3-137">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> note_times<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_num) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-138">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb3-139">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-140">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb3-141">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">numerator =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>,</span>
<span id="cb3-142">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">denominator =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>,</span>
<span id="cb3-143">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clocks_per_click =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>,</span>
<span id="cb3-144">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">notated_32nd_notes_per_beat =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>,</span>
<span id="cb3-145">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>,</span>
<span id="cb3-146">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>,</span>
<span id="cb3-147">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>,</span>
<span id="cb3-148">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>,</span>
<span id="cb3-149">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-150">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">program =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>,</span>
<span id="cb3-151">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span></span>
<span id="cb3-152">         )</span>
<span id="cb3-153"></span>
<span id="cb3-154">all_midi_bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(all_midi_bars,midi_bar)</span>
<span id="cb3-155"></span>
<span id="cb3-156">}</span>
<span id="cb3-157"></span>
<span id="cb3-158"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get meta messages</span></span>
<span id="cb3-159">meta_midi  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-160">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(meta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb3-161">         i_track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-162">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-163">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb3-164">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-165">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-166">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb3-167">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"set_tempo"</span>,</span>
<span id="cb3-168">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>,</span>
<span id="cb3-169">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.before =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb3-170">  )</span>
<span id="cb3-171"></span>
<span id="cb3-172"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># merge bar midi into full midi file</span></span>
<span id="cb3-173">midi_track <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> meta_midi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-174">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(all_midi_bars,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.after =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb3-175"></span>
<span id="cb3-176"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">##########################</span></span>
<span id="cb3-177"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce</span></span>
<span id="cb3-178"></span>
<span id="cb3-179">mod_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi_track</span>
<span id="cb3-180"></span>
<span id="cb3-181"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update df</span></span>
<span id="cb3-182">test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(mod_df)</span>
<span id="cb3-183"></span>
<span id="cb3-184"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write midi file</span></span>
<span id="cb3-185"></span>
<span id="cb3-186">test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mario_P48_allbar.mid"</span>)</span>
<span id="cb3-187"></span>
<span id="cb3-188"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb3-189"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce </span></span>
<span id="cb3-190"></span>
<span id="cb3-191">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mario_P48_allbar"</span></span>
<span id="cb3-192"></span>
<span id="cb3-193">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb3-194">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb3-195">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb3-196"></span>
<span id="cb3-197"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write the midi file to disk</span></span>
<span id="cb3-198"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#miditapyr$write_midi(dfc, ticks_per_beat, midi_name)</span></span>
<span id="cb3-199"></span>
<span id="cb3-200"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb3-201">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/nintendo_soundfont.sf2 {midi_name}'</span>)</span>
<span id="cb3-202"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb3-203"></span>
<span id="cb3-204"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb3-205">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb3-206"></span>
<span id="cb3-207"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb3-208"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb3-209">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb3-210">}</span></code></pre></div>
</details>
</div>
<p>I used the <code>rbinom()</code> function to randomly generate notes based on estimates of note x time feature probabilities. Its possible to control the amount of notes generated using the <code>size</code> parameter. The following examples have three levels of note density, from sparse to thick.</p>
<p>About 12 notes/bar: <audio controls=""> <source src="mario_P12_allbar.mp3" type="audio/wav"> </audio></p>
<p>About 24 notes/bar: <audio controls=""> <source src="mario_P24_allbar.mp3" type="audio/wav"> </audio></p>
<p>About 48 notes/bar: <audio controls=""> <source src="mario_P48_allbar.mp3" type="audio/wav"> </audio></p>
</section>
<section id="to-do" class="level2">
<h2 class="anchored" data-anchor-id="to-do">to do</h2>
<p>lots of stuff to clean up here. currently bespoke.</p>
<hr>
<!--

## Adding more midi files

The above worked for one midi file. Working on some code to process multiple midi files into a larger matrix. It would be nice to end up with some functions, we'll see what happens.


::: {.cell}

```{.r .cell-code}
# get list of midi file names
f_names <- list.files("midi", full.names =  T)

#####################################
# IMPORT
#####################################

#import midi using miditapyr
test_midi <- pyramidi::miditapyr$MidiFrames(f_names[1])

#import using mido
mido_import <- pyramidi::mido$MidiFile(f_names[1])

# to R dataframe
dfc <- pyramidi::miditapyr$frame_midi(mido_import)
ticks_per_beat <- mido_import$ticks_per_beat

# unnest the dataframe
df <- pyramidi::miditapyr$unnest_midi(dfc)
```
:::


1. Load in a midi file
2. Which tracks should be converted?
  - some tracks are only used for meta messages
  - some are used for drums etc.
3. Quick function to choose tracks that have more than 50 rows, and are not drums (channel 9 in the midi file)


::: {.cell}

```{.r .cell-code}
choose_tracks <- function(df) {
  
  df %>%
    filter(channel != 9) %>%
    group_by(i_track) %>%
    count()
  
}

tracks_to_convert <- choose_tracks(df)
```
:::

::: {.cell}

```{.r .cell-code}
####################################
# CONVERT TO MATRIX
####################################

# grab track 1
track_1 <- df %>%
  filter(i_track == tracks_to_convert$i_track[1],
         type %in% c("note_on","note_off") ==TRUE) %>%
  mutate(total_time = cumsum(time)) %>%
  filter(type == "note_on")

time_steps <- seq(0,max(track_1$total_time),8)
total_bars <- round(length(time_steps)/48)+1
bars <- rep(1:total_bars,each=48)
bar_steps <- rep(1:48,total_bars)

metric_tibble <- tibble(time_steps = time_steps,
                        bars = bars[1:length(time_steps)],
                        bar_steps =bar_steps[1:length(time_steps)])

track_1 <- track_1 %>%
  mutate(time_markers = 0,
         bars = 0,
         bar_steps = 0) 

for(i in 1:dim(track_1)[1]){
  track_1$time_markers[i] <- which(time_steps %in% track_1$total_time[i])
}

# get bar divisions, add them to track_1

for(i in 1:dim(track_1)[1]){
  get_timestep <- time_steps[track_1$time_markers[i]]
  track_1$bars[i] <- metric_tibble %>%
    filter(time_steps == get_timestep) %>%
    pull(bars)
  track_1$bar_steps[i] <- metric_tibble %>%
    filter(time_steps == get_timestep) %>%
    pull(bar_steps)
}

# assign intervals to the bars

music_matrix <- matrix(0,
                       ncol = (48+128+(48*128)),
                       nrow = max(track_1$bars)
)

for(i in 1:max(track_1$bars)){
  
  bar_midi <- track_1%>%
    filter(bars == i)
  
  one_bar <- matrix(0,
                  nrow=dim(pyramidi::midi_defs)[1],
                  ncol=48)
  
  for(j in 1:dim(one_bar)[1]){
    one_bar[bar_midi$note[j],bar_midi$bar_steps[j]] <- 1
  }
  
  
  pitch_vector <- rowSums(one_bar)
  time_vector <- colSums(one_bar)
  pitch_by_time <- c(one_bar)

  #concatenate_vector
  music_vector <- c(pitch_vector,time_vector,pitch_by_time)
  
  music_matrix[i,] <- music_vector
  
}
```
:::



-->


</section>

 ]]></description>
  <category>midi</category>
  <category>generative</category>
  <category>mario</category>
  <category>matrix</category>
  <category>rstats</category>
  <guid>https://homophony.quest/blog/35_2_3_24_matrix_midi/</guid>
  <pubDate>Sat, 03 Feb 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/35_2_3_24_matrix_midi/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Systematically randomizing Super Mario brothers with R</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/33_2_1_24_rand_mario/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Super mario brothers. Random, random pixels. pixel art. chaos."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/33_2_1_24_rand_mario/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>Super mario brothers. Random, random pixels. pixel art. chaos. - Dreamshaper v7</p>
</div></div><p>NOTE: I took some of the mp3s off because the page was loading really slowly with too many.</p>
<p>In the pursuit of MIDI knowledge I have achieved my goal of randomizing the overworld music from Super Mario Brothers.</p>
<p>This one randomly shuffles 50% of the note ON messages.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pyramidi)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(purrr)</span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi using miditapyr</span></span>
<span id="cb2-7">test_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFrames</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overworld.mid"</span>)</span>
<span id="cb2-8"></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import using mido</span></span>
<span id="cb2-10">mido_import <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>mido<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFile</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overworld.mid"</span>)</span>
<span id="cb2-11"></span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to R dataframe</span></span>
<span id="cb2-13">dfc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frame_midi</span>(mido_import)</span>
<span id="cb2-14">ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mido_import<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat</span>
<span id="cb2-15"></span>
<span id="cb2-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># unnest the dataframe</span></span>
<span id="cb2-17">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_midi</span>(dfc)</span>
<span id="cb2-18"></span>
<span id="cb2-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># achieve master plan to systematically randomize mario brothers</span></span>
<span id="cb2-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># modify midi file</span></span>
<span id="cb2-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get ids for note on messages</span></span>
<span id="cb2-22">ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">add_row_id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(df)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(i_track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb2-25">         type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note_on"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(add_row_id)</span>
<span id="cb2-27"></span>
<span id="cb2-28">all_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(ids)</span>
<span id="cb2-29">rand_proportion <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb2-30">ids_to_swap <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(all_notes,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(all_notes)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>rand_proportion))</span>
<span id="cb2-31"></span>
<span id="cb2-32">from_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ids[ids_to_swap]</span>
<span id="cb2-33">to_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(from_id)</span>
<span id="cb2-34"></span>
<span id="cb2-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># swap the notes</span></span>
<span id="cb2-36">df[from_id,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df[to_id,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note</span>
<span id="cb2-37"></span>
<span id="cb2-38">mod_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df</span>
<span id="cb2-39"></span>
<span id="cb2-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update df</span></span>
<span id="cb2-41">test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(mod_df)</span>
<span id="cb2-42"></span>
<span id="cb2-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write midi file</span></span>
<span id="cb2-44"></span>
<span id="cb2-45">test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mario.mid"</span>)</span>
<span id="cb2-46"></span>
<span id="cb2-47"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb2-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce </span></span>
<span id="cb2-49"></span>
<span id="cb2-50">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mario"</span></span>
<span id="cb2-51"></span>
<span id="cb2-52">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb2-53">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb2-54">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb2-55"></span>
<span id="cb2-56"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write the midi file to disk</span></span>
<span id="cb2-57"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#miditapyr$write_midi(dfc, ticks_per_beat, midi_name)</span></span>
<span id="cb2-58"></span>
<span id="cb2-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb2-60">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 {midi_name}'</span>)</span>
<span id="cb2-61"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb2-62"></span>
<span id="cb2-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb2-64">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb2-65"></span>
<span id="cb2-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb2-67"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb2-68">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb2-69">}</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="mario.mp3" type="audio/wav"> </audio></p>
<p>Now I just need to get a nintendo soundfont and do even more weird stuff.</p>
<section id="note-on-and-off" class="level2">
<h2 class="anchored" data-anchor-id="note-on-and-off">Note on and off</h2>
<p>Rows in the midi file either contain note on or note off messages. There is no grouping variable for a particular notes ON and OFF message. In the above, I only shuffled the note numbers for Note ON messages. This results in some notes having a long sustain because they are not turned OFF. Some of the notes may never be turned off, OMG that poor midi file.</p>
<p>Next goal is, can I pair up the on and off messages, and re-randomize to make everything sound tighter.</p>
<p>New Function to assign a unique id to each note</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># A function to create unique ids for each note</span></span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this helps group note on and off messages</span></span>
<span id="cb3-3"></span>
<span id="cb3-4">get_unique_note_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(note_column){</span>
<span id="cb3-5">  </span>
<span id="cb3-6">  unique_note_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(note_column))</span>
<span id="cb3-7">  unique_counter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb3-8">  </span>
<span id="cb3-9">  notes_that_are_on <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_number =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>,</span>
<span id="cb3-10">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span>
<span id="cb3-11">  </span>
<span id="cb3-12">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(note_column)){</span>
<span id="cb3-13">    </span>
<span id="cb3-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.nan</span>(note_column[i]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> T) {</span>
<span id="cb3-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># catch NaNs don't modify  </span></span>
<span id="cb3-16">    }</span>
<span id="cb3-17">    </span>
<span id="cb3-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.nan</span>(note_column[i]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> F) {</span>
<span id="cb3-19">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get current note</span></span>
<span id="cb3-20">      current_note <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> note_column[i]</span>
<span id="cb3-21">      </span>
<span id="cb3-22">      do_once_toggle <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb3-23">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if current note is in the note_on buffer, remove it</span></span>
<span id="cb3-24">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(current_note <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> notes_that_are_on<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_number <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>){</span>
<span id="cb3-25">        </span>
<span id="cb3-26">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign id to column vector</span></span>
<span id="cb3-27">        unique_note_id[i]<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> notes_that_are_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-28">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(note_number <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> current_note) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-29">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(note_id)</span>
<span id="cb3-30">        </span>
<span id="cb3-31">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remove note from buffer</span></span>
<span id="cb3-32">        notes_that_are_on <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> notes_that_are_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-33">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(note_number <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> current_note)</span>
<span id="cb3-34">        </span>
<span id="cb3-35">        do_once_toggle <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-36">      }</span>
<span id="cb3-37">      </span>
<span id="cb3-38">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if it isn't in the note_on buffer, put it in there</span></span>
<span id="cb3-39">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(do_once_toggle <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>){</span>
<span id="cb3-40">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(current_note <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> notes_that_are_on<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_number <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>){</span>
<span id="cb3-41">          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># increment unique note counter</span></span>
<span id="cb3-42">          unique_counter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> unique_counter<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-43">          </span>
<span id="cb3-44">          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add note on info to a new row in the buffer</span></span>
<span id="cb3-45">          notes_that_are_on <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> notes_that_are_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-46">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_number =</span> current_note,</span>
<span id="cb3-47">                                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> unique_counter)</span>
<span id="cb3-48">          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign id to column vector</span></span>
<span id="cb3-49">          unique_note_id[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> unique_counter</span>
<span id="cb3-50">        }</span>
<span id="cb3-51">      }</span>
<span id="cb3-52">      </span>
<span id="cb3-53">    }</span>
<span id="cb3-54">  </span>
<span id="cb3-55">  }</span>
<span id="cb3-56">  </span>
<span id="cb3-57">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(unique_note_id)</span>
<span id="cb3-58">  </span>
<span id="cb3-59">}</span></code></pre></div>
</details>
</div>
<p>That works and assigns a new column (to be removed later)</p>
<p>Now, I should be able to shuffle note objects, including their on and off messages. This should get rid of those sustained notes from the first randomization.</p>
<p>The midi file has four tracks. The fourth track is the drum track. The first three parts are essentially mono-voice harmony. The code below takes 50% of the notes in the first track and randomly shuffles them around so they appear in different random spots in the song. It still sounds very recognizable.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi using miditapyr</span></span>
<span id="cb4-2">test_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFrames</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overworld.mid"</span>)</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import using mido</span></span>
<span id="cb4-5">mido_import <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>mido<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFile</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overworld.mid"</span>)</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to R dataframe</span></span>
<span id="cb4-8">dfc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frame_midi</span>(mido_import)</span>
<span id="cb4-9">ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mido_import<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat</span>
<span id="cb4-10"></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># unnest the dataframe</span></span>
<span id="cb4-12">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_midi</span>(dfc)</span>
<span id="cb4-13"></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># isolate track 1 and add the unique note id vector</span></span>
<span id="cb4-15">track_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(i_track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_unique_note_id</span>(note))</span>
<span id="cb4-19"></span>
<span id="cb4-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get all unique notes</span></span>
<span id="cb4-21">possible_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.nan</span>(track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> F])</span>
<span id="cb4-22"></span>
<span id="cb4-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># randomly select some proportion to shuffle</span></span>
<span id="cb4-24">rand_proportion <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb4-25">shuffled_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(possible_notes, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(possible_notes)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>rand_proportion))</span>
<span id="cb4-26"></span>
<span id="cb4-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the note names that will be shuffled</span></span>
<span id="cb4-28">note_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track_1[track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> shuffled_ids <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> T <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb4-29">          track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'note_on'</span>,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note</span>
<span id="cb4-30"></span>
<span id="cb4-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shuffle</span></span>
<span id="cb4-32">note_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(note_names)</span>
<span id="cb4-33"></span>
<span id="cb4-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign shuffled notes back to df for note and note off messages</span></span>
<span id="cb4-35">track_1[track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> shuffled_ids <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> T <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb4-36">          track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'note_on'</span>,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> note_names</span>
<span id="cb4-37"></span>
<span id="cb4-38">track_1[track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> shuffled_ids <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> T <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb4-39">          track_1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'note_off'</span>,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> note_names</span>
<span id="cb4-40"></span>
<span id="cb4-41">track_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track_1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-42">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>row_id,<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>note_id)</span>
<span id="cb4-43"></span>
<span id="cb4-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># put track 1 back into df</span></span>
<span id="cb4-45"></span>
<span id="cb4-46">df[df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i_track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track_1</span>
<span id="cb4-47"></span>
<span id="cb4-48">mod_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df</span>
<span id="cb4-49"></span>
<span id="cb4-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update df</span></span>
<span id="cb4-51">test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(mod_df)</span>
<span id="cb4-52"></span>
<span id="cb4-53"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write midi file</span></span>
<span id="cb4-54"></span>
<span id="cb4-55">test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mario_B.mid"</span>)</span>
<span id="cb4-56"></span>
<span id="cb4-57"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb4-58"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce </span></span>
<span id="cb4-59"></span>
<span id="cb4-60">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mario_B"</span></span>
<span id="cb4-61"></span>
<span id="cb4-62">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb4-63">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb4-64">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb4-65"></span>
<span id="cb4-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write the midi file to disk</span></span>
<span id="cb4-67"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#miditapyr$write_midi(dfc, ticks_per_beat, midi_name)</span></span>
<span id="cb4-68"></span>
<span id="cb4-69"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb4-70">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 {midi_name}'</span>)</span>
<span id="cb4-71"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb4-72"></span>
<span id="cb4-73"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb4-74">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb4-75"></span>
<span id="cb4-76"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb4-77"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb4-78">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb4-79">}</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="mario_B.mp3" type="audio/wav"> </audio></p>
</section>
<section id="randomizing-mario-even-more" class="level2">
<h2 class="anchored" data-anchor-id="randomizing-mario-even-more">Randomizing Mario even more</h2>
<p>It would only be fair to randomize the song in steps of equal proportion from .1 to 1.</p>
<p>Im only randomizing the note numbers within voices, which preserves the timing of all of the notes. As the shuffling proportion increases the song becomes stranger. Still sounds like mario, even with full entropy.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(p <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)){</span>
<span id="cb5-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi using miditapyr</span></span>
<span id="cb5-3">  test_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFrames</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overworld.mid"</span>)</span>
<span id="cb5-4">  </span>
<span id="cb5-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import using mido</span></span>
<span id="cb5-6">  mido_import <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>mido<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFile</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overworld.mid"</span>)</span>
<span id="cb5-7">  </span>
<span id="cb5-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to R dataframe</span></span>
<span id="cb5-9">  dfc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frame_midi</span>(mido_import)</span>
<span id="cb5-10">  ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mido_import<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat</span>
<span id="cb5-11">  </span>
<span id="cb5-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># unnest the dataframe</span></span>
<span id="cb5-13">  df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_midi</span>(dfc)</span>
<span id="cb5-14">  </span>
<span id="cb5-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># do shuffling for all tracks</span></span>
<span id="cb5-16">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(t <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)){</span>
<span id="cb5-17">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># isolate track 1 and add the unique note id vector</span></span>
<span id="cb5-18">    track <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-19">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(i_track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> t) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-20">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-21">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_unique_note_id</span>(note))</span>
<span id="cb5-22">    </span>
<span id="cb5-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get all unique notes</span></span>
<span id="cb5-24">    possible_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.nan</span>(track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> F])</span>
<span id="cb5-25">    </span>
<span id="cb5-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># randomly select some proportion to shuffle</span></span>
<span id="cb5-27">    rand_proportion <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p</span>
<span id="cb5-28">    shuffled_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(possible_notes, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(possible_notes)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>rand_proportion))</span>
<span id="cb5-29">    </span>
<span id="cb5-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the note names that will be shuffled</span></span>
<span id="cb5-31">    note_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track[track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> shuffled_ids <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> T <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb5-32">              track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'note_on'</span>,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note</span>
<span id="cb5-33">    </span>
<span id="cb5-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shuffle</span></span>
<span id="cb5-35">    note_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(note_names)</span>
<span id="cb5-36">    </span>
<span id="cb5-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign shuffled notes back to df for note and note off messages</span></span>
<span id="cb5-38">    track[track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> shuffled_ids <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> T <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb5-39">              track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'note_on'</span>,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> note_names</span>
<span id="cb5-40">    </span>
<span id="cb5-41">    track[track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> shuffled_ids <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> T <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb5-42">              track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'note_off'</span>,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> note_names</span>
<span id="cb5-43">    </span>
<span id="cb5-44">    track <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-45">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>row_id,<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>note_id)</span>
<span id="cb5-46">    </span>
<span id="cb5-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># put track 1 back into df</span></span>
<span id="cb5-48">    </span>
<span id="cb5-49">    df[df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i_track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> t,] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track</span>
<span id="cb5-50">  }</span>
<span id="cb5-51">  </span>
<span id="cb5-52">  </span>
<span id="cb5-53">  mod_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df</span>
<span id="cb5-54">  </span>
<span id="cb5-55">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update df</span></span>
<span id="cb5-56">  test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(mod_df)</span>
<span id="cb5-57">  </span>
<span id="cb5-58">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write midi file</span></span>
<span id="cb5-59">  iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb5-60"> </span>
<span id="cb5-61">  track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mario_"</span>,iter)</span>
<span id="cb5-62">  midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb5-63">   </span>
<span id="cb5-64">  test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(midi_name)</span>
<span id="cb5-65">  </span>
<span id="cb5-66">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb5-67">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce </span></span>
<span id="cb5-68">  </span>
<span id="cb5-69"> </span>
<span id="cb5-70">  </span>
<span id="cb5-71">  wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb5-72">  mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb5-73">  </span>
<span id="cb5-74">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write the midi file to disk</span></span>
<span id="cb5-75">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#miditapyr$write_midi(dfc, ticks_per_beat, midi_name)</span></span>
<span id="cb5-76">  </span>
<span id="cb5-77">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb5-78">  system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 {midi_name}'</span>)</span>
<span id="cb5-79">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb5-80">  </span>
<span id="cb5-81">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb5-82">  av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb5-83">  </span>
<span id="cb5-84">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb5-85">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb5-86">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb5-87">  }</span>
<span id="cb5-88">}</span></code></pre></div>
</details>
</div>
<p>10% shuffled notes <audio controls=""> <source src="mario_1.mp3" type="audio/wav"> </audio></p>
<p>50% shuffled notes <audio controls=""> <source src="mario_5.mp3" type="audio/wav"> </audio></p>
<p>100% shuffled notes <audio controls=""> <source src="mario_10.mp3" type="audio/wav"> </audio></p>
</section>
<section id="really-really-random" class="level2">
<h2 class="anchored" data-anchor-id="really-really-random">Really Really Random</h2>
<p>Lets go a bit further into that green pipe of entropy. Now, instead of shuffling notes within each track by some proportion, lets just choose any random note (not necessarily from the song or the key). I used the note range 30 - 90 (midi notes), and sampled from this distribution uniformly. Mario gets even more weird now. Still even at 100% its still recognizably Marioas if Mario was trying to dial into the internet from a landline.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(p <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)){</span>
<span id="cb6-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi using miditapyr</span></span>
<span id="cb6-3">  test_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFrames</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overworld.mid"</span>)</span>
<span id="cb6-4">  </span>
<span id="cb6-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import using mido</span></span>
<span id="cb6-6">  mido_import <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>mido<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFile</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overworld.mid"</span>)</span>
<span id="cb6-7">  </span>
<span id="cb6-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to R dataframe</span></span>
<span id="cb6-9">  dfc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frame_midi</span>(mido_import)</span>
<span id="cb6-10">  ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mido_import<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat</span>
<span id="cb6-11">  </span>
<span id="cb6-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># unnest the dataframe</span></span>
<span id="cb6-13">  df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_midi</span>(dfc)</span>
<span id="cb6-14">  </span>
<span id="cb6-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># do shuffling for all tracks</span></span>
<span id="cb6-16">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(t <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)){</span>
<span id="cb6-17">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># isolate track 1 and add the unique note id vector</span></span>
<span id="cb6-18">    track <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-19">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(i_track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> t) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-20">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-21">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_unique_note_id</span>(note))</span>
<span id="cb6-22">    </span>
<span id="cb6-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get all unique notes</span></span>
<span id="cb6-24">    possible_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.nan</span>(track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> F])</span>
<span id="cb6-25">    </span>
<span id="cb6-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># randomly select some proportion to shuffle</span></span>
<span id="cb6-27">    rand_proportion <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p</span>
<span id="cb6-28">    shuffled_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(possible_notes, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(possible_notes)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>rand_proportion))</span>
<span id="cb6-29">    </span>
<span id="cb6-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the note names that will be shuffled</span></span>
<span id="cb6-31">    note_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track[track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> shuffled_ids <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> T <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb6-32">              track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'note_on'</span>,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note</span>
<span id="cb6-33">    </span>
<span id="cb6-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shuffle</span></span>
<span id="cb6-35">    note_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(note_names), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> T)</span>
<span id="cb6-36">    </span>
<span id="cb6-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign shuffled notes back to df for note and note off messages</span></span>
<span id="cb6-38">    track[track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> shuffled_ids <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> T <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb6-39">              track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'note_on'</span>,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> note_names</span>
<span id="cb6-40">    </span>
<span id="cb6-41">    track[track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> shuffled_ids <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> T <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb6-42">              track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'note_off'</span>,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> note_names</span>
<span id="cb6-43">    </span>
<span id="cb6-44">    track <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb6-45">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>row_id,<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>note_id)</span>
<span id="cb6-46">    </span>
<span id="cb6-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># put track 1 back into df</span></span>
<span id="cb6-48">    </span>
<span id="cb6-49">    df[df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i_track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> t,] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track</span>
<span id="cb6-50">  }</span>
<span id="cb6-51">  </span>
<span id="cb6-52">  </span>
<span id="cb6-53">  mod_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df</span>
<span id="cb6-54">  </span>
<span id="cb6-55">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update df</span></span>
<span id="cb6-56">  test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(mod_df)</span>
<span id="cb6-57">  </span>
<span id="cb6-58">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write midi file</span></span>
<span id="cb6-59">  iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb6-60"> </span>
<span id="cb6-61">  track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mario_R"</span>,iter)</span>
<span id="cb6-62">  midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb6-63">   </span>
<span id="cb6-64">  test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(midi_name)</span>
<span id="cb6-65">  </span>
<span id="cb6-66">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb6-67">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce </span></span>
<span id="cb6-68">  </span>
<span id="cb6-69"> </span>
<span id="cb6-70">  </span>
<span id="cb6-71">  wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb6-72">  mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb6-73">  </span>
<span id="cb6-74">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write the midi file to disk</span></span>
<span id="cb6-75">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#miditapyr$write_midi(dfc, ticks_per_beat, midi_name)</span></span>
<span id="cb6-76">  </span>
<span id="cb6-77">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb6-78">  system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 {midi_name}'</span>)</span>
<span id="cb6-79">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb6-80">  </span>
<span id="cb6-81">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb6-82">  av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb6-83">  </span>
<span id="cb6-84">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb6-85">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb6-86">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb6-87">  }</span>
<span id="cb6-88">}</span></code></pre></div>
</details>
</div>
<p>10% random notes <audio controls=""> <source src="mario_R1.mp3" type="audio/wav"> </audio></p>
<p>50% random notes <audio controls=""> <source src="mario_R5.mp3" type="audio/wav"> </audio></p>
<p>100% random notes <audio controls=""> <source src="mario_R10.mp3" type="audio/wav"> </audio></p>
</section>
<section id="trying-another-soundfont" class="level2">
<h2 class="anchored" data-anchor-id="trying-another-soundfont">Trying another soundfont</h2>
<p>So far I have only used a general style soundfont. Lets see how easy it is to get a nintendo sound.</p>
<p><a href="https://musical-artifacts.com/artifacts/610" class="uri">https://musical-artifacts.com/artifacts/610</a></p>
<p>Pretty easy, nice.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">  track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overworld"</span></span>
<span id="cb7-2">  midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb7-3">   </span>
<span id="cb7-4">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb7-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce </span></span>
<span id="cb7-6"></span>
<span id="cb7-7">  wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb7-8">  mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb7-9">  </span>
<span id="cb7-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write the midi file to disk</span></span>
<span id="cb7-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#miditapyr$write_midi(dfc, ticks_per_beat, midi_name)</span></span>
<span id="cb7-12">  </span>
<span id="cb7-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb7-14">  system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/nintendo_soundfont.sf2 {midi_name}'</span>)</span>
<span id="cb7-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb7-16">  </span>
<span id="cb7-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb7-18">  av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb7-19">  </span>
<span id="cb7-20">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb7-21">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb7-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb7-23">  }</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="overworld.mp3" type="audio/wav"> </audio></p>
</section>
<section id="more-random-notes-with-the-mario-sound" class="level2">
<h2 class="anchored" data-anchor-id="more-random-notes-with-the-mario-sound">More random notes with the mario sound</h2>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(p <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)){</span>
<span id="cb8-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi using miditapyr</span></span>
<span id="cb8-3">  test_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFrames</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overworld.mid"</span>)</span>
<span id="cb8-4">  </span>
<span id="cb8-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import using mido</span></span>
<span id="cb8-6">  mido_import <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>mido<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFile</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"overworld.mid"</span>)</span>
<span id="cb8-7">  </span>
<span id="cb8-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to R dataframe</span></span>
<span id="cb8-9">  dfc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frame_midi</span>(mido_import)</span>
<span id="cb8-10">  ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mido_import<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat</span>
<span id="cb8-11">  </span>
<span id="cb8-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># unnest the dataframe</span></span>
<span id="cb8-13">  df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_midi</span>(dfc)</span>
<span id="cb8-14">  </span>
<span id="cb8-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># do shuffling for all tracks</span></span>
<span id="cb8-16">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(t <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)){</span>
<span id="cb8-17">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># isolate track 1 and add the unique note id vector</span></span>
<span id="cb8-18">    track <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-19">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(i_track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> t) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-20">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">row_id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-21">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_unique_note_id</span>(note))</span>
<span id="cb8-22">    </span>
<span id="cb8-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get all unique notes</span></span>
<span id="cb8-24">    possible_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.nan</span>(track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> F])</span>
<span id="cb8-25">    </span>
<span id="cb8-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># randomly select some proportion to shuffle</span></span>
<span id="cb8-27">    rand_proportion <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p</span>
<span id="cb8-28">    shuffled_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(possible_notes, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(possible_notes)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>rand_proportion))</span>
<span id="cb8-29">    </span>
<span id="cb8-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the note names that will be shuffled</span></span>
<span id="cb8-31">    note_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track[track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> shuffled_ids <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> T <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb8-32">              track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'note_on'</span>,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note</span>
<span id="cb8-33">    </span>
<span id="cb8-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shuffle</span></span>
<span id="cb8-35">    note_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(note_names), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> T)</span>
<span id="cb8-36">    </span>
<span id="cb8-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign shuffled notes back to df for note and note off messages</span></span>
<span id="cb8-38">    track[track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> shuffled_ids <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> T <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb8-39">              track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'note_on'</span>,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> note_names</span>
<span id="cb8-40">    </span>
<span id="cb8-41">    track[track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> shuffled_ids <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> T <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb8-42">              track<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'note_off'</span>,]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>note <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> note_names</span>
<span id="cb8-43">    </span>
<span id="cb8-44">    track <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb8-45">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>row_id,<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>note_id)</span>
<span id="cb8-46">    </span>
<span id="cb8-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># put track 1 back into df</span></span>
<span id="cb8-48">    </span>
<span id="cb8-49">    df[df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i_track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> t,] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> track</span>
<span id="cb8-50">  }</span>
<span id="cb8-51">  </span>
<span id="cb8-52">  </span>
<span id="cb8-53">  mod_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df</span>
<span id="cb8-54">  </span>
<span id="cb8-55">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update df</span></span>
<span id="cb8-56">  test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(mod_df)</span>
<span id="cb8-57">  </span>
<span id="cb8-58">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write midi file</span></span>
<span id="cb8-59">  iter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb8-60"> </span>
<span id="cb8-61">  track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mario_NES"</span>,iter)</span>
<span id="cb8-62">  midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb8-63">   </span>
<span id="cb8-64">  test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(midi_name)</span>
<span id="cb8-65">  </span>
<span id="cb8-66">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb8-67">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce </span></span>
<span id="cb8-68">  </span>
<span id="cb8-69"> </span>
<span id="cb8-70">  </span>
<span id="cb8-71">  wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb8-72">  mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb8-73">  </span>
<span id="cb8-74">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write the midi file to disk</span></span>
<span id="cb8-75">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#miditapyr$write_midi(dfc, ticks_per_beat, midi_name)</span></span>
<span id="cb8-76">  </span>
<span id="cb8-77">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb8-78">  system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/nintendo_soundfont.sf2 {midi_name}'</span>)</span>
<span id="cb8-79">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb8-80">  </span>
<span id="cb8-81">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb8-82">  av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span>
<span id="cb8-83">  </span>
<span id="cb8-84">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb8-85">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb8-86">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb8-87">  }</span>
<span id="cb8-88">}</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="mario_NES1.mp3" type="audio/wav"> </audio></p>
<p><audio controls=""> <source src="mario_NES5.mp3" type="audio/wav"> </audio></p>
<p><audio controls=""> <source src="mario_NES10.mp3" type="audio/wav"> </audio></p>
<p>Now my princess really is in another castle.</p>


</section>

 ]]></description>
  <category>midi</category>
  <category>fluidsynth</category>
  <category>rstats</category>
  <guid>https://homophony.quest/blog/33_2_1_24_rand_mario/</guid>
  <pubDate>Thu, 01 Feb 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/33_2_1_24_rand_mario/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Charting out chordal spin</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/30_1_30_24_spinning_chords/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"piano chord. spinning circles. spinning piano. retro. 80s cartoon."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/30_1_30_24_spinning_chords/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>piano chord. spinning circles. spinning piano. retro. 80s cartoon. - Dreamshaper v7</p>
</div></div><p>In recent past posts, Ive been representing chords as vectors and plotting them in 2-dimensional space to visualize similarity relationships. Yesterday, I made some charts to look at <a href="https://homophony.quest/blog/29_1_29_24_cmajor/">basic triads in the C scale</a>, and did a little bit of analysis on the <a href="https://homophony.quest/blog/29_1_29_24_cmajor/#bar-blues-analysis">12-bar blues progression</a>. Im mostly doing this stuff out of general interest, and with some hope that I can learn something to inform my own playing.</p>
<p>This morning Ill continue in the same direction by making the same kind of graphs for more chord types besides triads.</p>
<p>The basic idea is to plot a chord as a compound vector inside the circle of fifths. Each of the notes in the chord are vectors that point at their respective notes in the circle of fifths. The chord vector is the average direction of all the note vectors, and it points somewhere in the circle of fifths. Finally, yesterday I added a spinning force to some chords that I thought had natural rotational motion with respect to a key center. This last part had potential musical implications in terms of chord progressions that I might find useful when Im playing.</p>
<p>Id like to know how other chords spin, so Im making these here graphs.</p>
<section id="example-spinning-chord-chart" class="level2">
<h2 class="anchored" data-anchor-id="example-spinning-chord-chart">Example spinning chord chart</h2>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pre-processing to get the chord vectors</span></span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load chord vectors</span></span>
<span id="cb2-5">c_chord_excel <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rio<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">import</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chord_vectors.xlsx"</span>)</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># grab feature vectors</span></span>
<span id="cb2-8">c_chord_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(c_chord_excel[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>])</span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign row names to the third column containing chord names</span></span>
<span id="cb2-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(c_chord_matrix) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> c_chord_excel[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb2-12"></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define all keys</span></span>
<span id="cb2-14">keys <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Db"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Eb"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gb"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ab"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bb"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>)</span>
<span id="cb2-15"></span>
<span id="cb2-16"></span>
<span id="cb2-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the excel sheet only has chords in C</span></span>
<span id="cb2-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loop through the keys, permute the matrix to get the chords in the next key</span></span>
<span id="cb2-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add the permuted matrix to new rows in the overall chord_matrix</span></span>
<span id="cb2-20"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(keys)) {</span>
<span id="cb2-21"></span>
<span id="cb2-22">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb2-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize chord_matrix with C matrix</span></span>
<span id="cb2-24">    chord_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> c_chord_matrix</span>
<span id="cb2-25"></span>
<span id="cb2-26">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb2-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#permute the matrix as a function of iterator</span></span>
<span id="cb2-28">    new_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(c_chord_matrix[, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>i)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>],c_chord_matrix[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>i)] )</span>
<span id="cb2-29"></span>
<span id="cb2-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rename the rows with the new key</span></span>
<span id="cb2-31">    new_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>, keys[i], c_chord_excel[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb2-32">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(new_matrix) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> new_names</span>
<span id="cb2-33"></span>
<span id="cb2-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># append the new_matrix to chord_matrix</span></span>
<span id="cb2-35">    chord_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(chord_matrix,new_matrix)</span>
<span id="cb2-36"></span>
<span id="cb2-37">  }</span>
<span id="cb2-38">}</span>
<span id="cb2-39"></span>
<span id="cb2-40">chord_properties <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb2-41">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(c_chord_excel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(keys)),</span>
<span id="cb2-42">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(keys, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(c_chord_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb2-43">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chord_names  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(chord_matrix),</span>
<span id="cb2-44">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">synonyms =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>),</span>
<span id="cb2-45">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">database_chord =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb2-46">)</span>
<span id="cb2-47"></span>
<span id="cb2-48">first_order <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> lsa<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cosine</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(chord_matrix))</span>
<span id="cb2-49"></span>
<span id="cb2-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find repeats and build synonym list</span></span>
<span id="cb2-51">repeat_indices <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>()</span>
<span id="cb2-52"></span>
<span id="cb2-53">first_occurrence <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>()</span>
<span id="cb2-54"></span>
<span id="cb2-55"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(chord_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]){</span>
<span id="cb2-56">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the current row</span></span>
<span id="cb2-57">  evaluate_row <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> first_order[i,]</span>
<span id="cb2-58"></span>
<span id="cb2-59">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># don't count the current item as a repeat</span></span>
<span id="cb2-60">  evaluate_row[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb2-61"></span>
<span id="cb2-62">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># repeats are the ids for any other 1s found</span></span>
<span id="cb2-63">  repeats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(evaluate_row <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> )</span>
<span id="cb2-64"></span>
<span id="cb2-65">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(repeats) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>){</span>
<span id="cb2-66">  }</span>
<span id="cb2-67"></span>
<span id="cb2-68">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(repeats) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>){</span>
<span id="cb2-69">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#add to list of repeat items</span></span>
<span id="cb2-70">    repeat_indices <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(repeat_indices,repeats)</span>
<span id="cb2-71"></span>
<span id="cb2-72">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add synonyms</span></span>
<span id="cb2-73">    chord_properties<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>synonyms[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">synonyms =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(chord_matrix)[repeats])</span>
<span id="cb2-74">  }</span>
<span id="cb2-75"></span>
<span id="cb2-76">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> first_occurrence <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>){</span>
<span id="cb2-77">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> repeat_indices <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>){</span>
<span id="cb2-78">      first_occurrence <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(first_occurrence,i)</span>
<span id="cb2-79">      chord_properties<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>database_chord[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb2-80">    }</span>
<span id="cb2-81">  }</span>
<span id="cb2-82">}</span>
<span id="cb2-83"></span>
<span id="cb2-84">chord_properties <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> chord_properties <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-85">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowSums</span>(chord_matrix),</span>
<span id="cb2-86">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(chord_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb2-87"></span>
<span id="cb2-88"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># keep only unique chord, recompute similarities</span></span>
<span id="cb2-89">chord_matrix_no_repeats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> chord_matrix[first_occurrence,]</span>
<span id="cb2-90">first_order_no_repeats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> lsa<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cosine</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(chord_matrix_no_repeats))</span>
<span id="cb2-91">second_order_no_repeats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> lsa<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cosine</span>(first_order_no_repeats)</span>
<span id="cb2-92"></span>
<span id="cb2-93"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remove scales and individual notes</span></span>
<span id="cb2-94">only_chords <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> chord_properties <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-95">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(type<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>,</span>
<span id="cb2-96">         type<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"key"</span>,</span>
<span id="cb2-97">         database_chord <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb2-98"></span>
<span id="cb2-99">first_order_chords <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> first_order_no_repeats[only_chords<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>chord_names,</span>
<span id="cb2-100">                                               only_chords<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>chord_names]</span>
<span id="cb2-101">second_order_chords <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> second_order_no_repeats[only_chords<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>chord_names,</span>
<span id="cb2-102">                                               only_chords<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>chord_names]</span></code></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggrepel)</span>
<span id="cb3-3">mds_first_order <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cmdscale</span>((first_order<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>))</span>
<span id="cb3-4">mds_first_order <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(mds_first_order) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(chord_properties)</span>
<span id="cb3-6"></span>
<span id="cb3-7">mds_first_order <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mds_first_order <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key =</span> forcats<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_relevel</span>(key,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bb"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Eb"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ab"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Db"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gb"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bold_me =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(key <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb3-10">                             key <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"key"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C major triad"</span>,</span>
<span id="cb3-12">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D minor triad"</span>,</span>
<span id="cb3-13">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E minor triad"</span>,</span>
<span id="cb3-14">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F major triad"</span>,</span>
<span id="cb3-15">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G major triad"</span>,</span>
<span id="cb3-16">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A minor triad"</span>,</span>
<span id="cb3-17">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bdim"</span>,</span>
<span id="cb3-18">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C major scale"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">V1 =</span> V1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb3-20">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">V2 =</span> V2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">line_V1 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C major triad"</span>,</span>
<span id="cb3-22">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D minor triad"</span>,</span>
<span id="cb3-23">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E minor triad"</span>,</span>
<span id="cb3-24">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F major triad"</span>,</span>
<span id="cb3-25">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G major triad"</span>,</span>
<span id="cb3-26">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A minor triad"</span>,</span>
<span id="cb3-27">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bdim"</span>,</span>
<span id="cb3-28">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C major scale"</span>,</span>
<span id="cb3-29">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C note"</span>,</span>
<span id="cb3-30">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>,</span>
<span id="cb3-31">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E note"</span>,</span>
<span id="cb3-32">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F note"</span>,</span>
<span id="cb3-33">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G note"</span>,</span>
<span id="cb3-34">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A note"</span>,</span>
<span id="cb3-35">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B note"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> V1),</span>
<span id="cb3-36">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">line_V2 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C major triad"</span>,</span>
<span id="cb3-37">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D minor triad"</span>,</span>
<span id="cb3-38">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E minor triad"</span>,</span>
<span id="cb3-39">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F major triad"</span>,</span>
<span id="cb3-40">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G major triad"</span>,</span>
<span id="cb3-41">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A minor triad"</span>,</span>
<span id="cb3-42">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bdim"</span>,</span>
<span id="cb3-43">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C major scale"</span>,</span>
<span id="cb3-44">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C note"</span>,</span>
<span id="cb3-45">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>,</span>
<span id="cb3-46">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E note"</span>,</span>
<span id="cb3-47">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F note"</span>,</span>
<span id="cb3-48">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G note"</span>,</span>
<span id="cb3-49">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A note"</span>,</span>
<span id="cb3-50">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B note"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> V2))</span>
<span id="cb3-51"></span>
<span id="cb3-52">p1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(mds_first_order, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(V1, V2, </span>
<span id="cb3-53">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> chord_names))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb3-54">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-55">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text_repel</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.overlaps =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-56">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb3-57">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-58">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-59">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> line_V1,</span>
<span id="cb3-60">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> line_V2,</span>
<span id="cb3-61">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> type))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-62">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_classic</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C major scale"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb3-63">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>))</span>
<span id="cb3-64"></span>
<span id="cb3-65">Cmajor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(mds_first_order, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(V1, V2, </span>
<span id="cb3-66">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> chord_names))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb3-67">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-68">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text_repel</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.overlaps =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-69">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb3-70">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-71">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-72">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb3-73">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-74">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb3-75">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-76">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-77">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb3-78">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-79">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb3-80">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-81">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-82">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb3-83">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-84">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(</span>
<span id="cb3-85">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-86">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-87">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb3-88">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2,</span>
<span id="cb3-89">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-90">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb3-91">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>,</span>
<span id="cb3-92">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-93">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-94">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C major triad"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb3-95">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C major triad"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-96">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_curve</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb3-97">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>,</span>
<span id="cb3-98">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">curvature =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb3-99">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-100">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb3-101">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C major triad"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb3-102">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C major triad"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-103">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_classic</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-104">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C major triad"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb3-105">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>))</span>
<span id="cb3-106"></span>
<span id="cb3-107"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(patchwork)</span>
<span id="cb3-108"></span>
<span id="cb3-109">p1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Cmajor</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://homophony.quest/blog/30_1_30_24_spinning_chords/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="1920"></p>
</figure>
</div>
</div>
</div>
<p>These are repeat graphs from yesterday. I have coded a whole bunch of chords as feature vectors, calculated cosine similarities between all chords, and then used multi-dimensional scaling to render the chords in a compressed 2-dimensional similarity space. This procedure puts each note into a circle of fifths relationship, as shown in the graph.</p>
<p>The C major scale graph draws lines from the origin to each note in the C scale. The graph also has compound vectors showing the direction of each triad, and the direction of the whole scale. The C major scale is symmetrical about the D note, and it points in the direction of the D note. So, I take D as the center.</p>
<p>The C major triad graph shows lines for the notes C, E, and G, and a red line for the compound vector, which indicates the direction of the chord. Its going somewhere between the G note and D note in chord space. The red line is the center of C major triad. If this was a physical object, like an unusual fork with three tines (for C, E, and G), it should balance on its point by tilting it so the red line points up at 90 degrees. From this perspective, the triad does not a have any spin. It wants to go straight ahead, and does not want to spin around the circle.</p>
<p>However, from the perspective of the key center, which is indicated by the dotted line, the chord does have a spin. If the object was tilted so that the dotted line was at 90 degrees, the chord would fall to the left because it is unbalanced. In recognition of this potential for spin, I put a little curvy arrow on the C major triad pointing in the anti-clockwise direction, which is the direction it would fall, or spin on the circle.</p>
</section>
<section id="where-is-the-center" class="level2">
<h2 class="anchored" data-anchor-id="where-is-the-center">Where is the center?</h2>
<p>In the above I use the D note as center, seems pretty obvious based on how the C major scale spreads across the circle of fifths. However, I just realized that in the graphs I made yesterday, I didnt use the key center to compute spin. In the case of the C major triad, the D note direction is also the bisecting line for the largest angle (CE) in the chord. I had used the bisecting line to compute spin for the other chords.</p>
<p>Using the bisecting line as center, major triads spin anti-clockwise and minor triads spin clockwise. The one diminished chord doesnt spin. Im not sure that assigning spin this way is a reasonable thing to do or not?</p>
<p>If I keep pursuing a physical object analogy, lets think about welding a little ringlet onto the point of the chordal fork, and then placing the chord object tines up on a nail. The C major triad object should balance when the notional red line points at 90 degrees. But it will fall over to the left, or to the right depending on the starting angle. Yesterday, I had the G major triad spinning anti-clockwise. It would do this in the G major scale. However, if I take the D note as the center, there is a rationale for having the G major chord spin clockwise.</p>
<p>In short, if I try to use the key center to compute spin, things could get complicated, especially if its not clear what the key center is. Ill leave that for another day.</p>
<p>Today, I guess I will use the bisecting line from the largest angle.</p>
</section>
<section id="th-chords-in-c-major" class="level2">
<h2 class="anchored" data-anchor-id="th-chords-in-c-major">7th chords in C major</h2>
<p>The chord charts I made yesterday were done in ggplot2. It would be nice to functionalize the code so I could enter some chord names and get the charts without having to hand code everything. Im having some indecision on whether or not to spend time writing those functions, or just make the graphs.</p>
<p>Ill do four by hand to see what Im dealing with.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">mds_first_order <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cmdscale</span>((first_order<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>))</span>
<span id="cb4-2">mds_first_order <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(mds_first_order) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(chord_properties)</span>
<span id="cb4-4"></span>
<span id="cb4-5">mds_first_order <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mds_first_order <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key =</span> forcats<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_relevel</span>(key,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bb"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Eb"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ab"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Db"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gb"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bold_me =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(key <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb4-8">                             key <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"key"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C7"</span>,</span>
<span id="cb4-10">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dm7"</span>,</span>
<span id="cb4-11">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G7"</span>,</span>
<span id="cb4-12">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bm7(b5)"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">V1 =</span> V1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb4-14">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">V2 =</span> V2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">line_V1 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C7"</span>,</span>
<span id="cb4-16">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dm7"</span>,</span>
<span id="cb4-17">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G7"</span>,</span>
<span id="cb4-18">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bm7(b5)"</span>,</span>
<span id="cb4-19">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C note"</span>,</span>
<span id="cb4-20">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>,</span>
<span id="cb4-21">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E note"</span>,</span>
<span id="cb4-22">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F note"</span>,</span>
<span id="cb4-23">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G note"</span>,</span>
<span id="cb4-24">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A note"</span>,</span>
<span id="cb4-25">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B note"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> V1),</span>
<span id="cb4-26">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">line_V2 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C7"</span>,</span>
<span id="cb4-27">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dm7"</span>,</span>
<span id="cb4-28">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G7"</span>,</span>
<span id="cb4-29">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bm7(b5)"</span>,</span>
<span id="cb4-30">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C note"</span>,</span>
<span id="cb4-31">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>,</span>
<span id="cb4-32">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E note"</span>,</span>
<span id="cb4-33">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F note"</span>,</span>
<span id="cb4-34">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G note"</span>,</span>
<span id="cb4-35">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A note"</span>,</span>
<span id="cb4-36">                                             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B note"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> V2))</span>
<span id="cb4-37"></span>
<span id="cb4-38">Cmajor7 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(mds_first_order, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(V1, V2, </span>
<span id="cb4-39">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> chord_names))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text_repel</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.overlaps =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-42">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-43">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-44">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-45">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-46">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-47">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-48">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-49">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-50">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-51">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-52">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-53">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-54">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-55">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-56">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-57">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-58">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-59">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-60">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-61">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-62">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(</span>
<span id="cb4-63">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-64">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-65">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-66">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2,</span>
<span id="cb4-67">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-68">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-69">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>,</span>
<span id="cb4-70">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-71">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-72">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C7"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-73">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C7"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-74">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_curve</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-75">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>,</span>
<span id="cb4-76">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">curvature =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb4-77">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-78">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-79">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C7"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb4-80">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C7"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-81">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_classic</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-82">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C7"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-83">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>))</span>
<span id="cb4-84"></span>
<span id="cb4-85"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Cmajor7</span></span>
<span id="cb4-86"></span>
<span id="cb4-87">Dminor7 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(mds_first_order, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(V1, V2, </span>
<span id="cb4-88">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> chord_names))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-89">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-90">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text_repel</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.overlaps =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-91">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-92">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-93">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-94">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-95">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-96">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-97">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-98">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-99">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-100">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-101">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-102">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-103">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-104">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-105">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-106">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-107">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-108">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-109">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-110">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-111">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(</span>
<span id="cb4-112">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-113">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-114">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-115">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2,</span>
<span id="cb4-116">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-117">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-118">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>,</span>
<span id="cb4-119">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-120">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-121">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dm7"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-122">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dm7"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-123">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_curve</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-124">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>,</span>
<span id="cb4-125">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">curvature =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb4-126">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-127">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-128">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dm7"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb4-129">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dm7"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-130">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_classic</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-131">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dm7"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-132">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>))</span>
<span id="cb4-133"></span>
<span id="cb4-134"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Dminor7</span></span>
<span id="cb4-135"></span>
<span id="cb4-136">G7 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(mds_first_order, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(V1, V2, </span>
<span id="cb4-137">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> chord_names))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-138">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-139">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text_repel</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.overlaps =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-140">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-141">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-142">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-143">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-144">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-145">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-146">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-147">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-148">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-149">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-150">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-151">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-152">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-153">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-154">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-155">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-156">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-157">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-158">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-159">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-160">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(</span>
<span id="cb4-161">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-162">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-163">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-164">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2,</span>
<span id="cb4-165">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-166">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-167">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>,</span>
<span id="cb4-168">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-169">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-170">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G7"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-171">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G7"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-172">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_curve</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-173">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>,</span>
<span id="cb4-174">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">curvature =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb4-175">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-176">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-177">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G7"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb4-178">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G7"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-179">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_classic</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-180">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G7"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-181">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>))</span>
<span id="cb4-182"></span>
<span id="cb4-183"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#G7</span></span>
<span id="cb4-184"></span>
<span id="cb4-185">Bm7b5 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(mds_first_order, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(V1, V2, </span>
<span id="cb4-186">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> chord_names))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-187">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-188">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text_repel</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.overlaps =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-189">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-190">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-191">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-192">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-193">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-194">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-195">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-196">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-197">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-198">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-199">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-200">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-201">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-202">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-203">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-204">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-205">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-206">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-207">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-208">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-209">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(</span>
<span id="cb4-210">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-211">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-212">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-213">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D note"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2,</span>
<span id="cb4-214">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-215">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-216">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>,</span>
<span id="cb4-217">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-218">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-219">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bm7(b5)"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1),</span>
<span id="cb4-220">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bm7(b5)"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-221">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_curve</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cm"</span>)),</span>
<span id="cb4-222">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>,</span>
<span id="cb4-223">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">curvature =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb4-224">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-225">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-226">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bm7(b5)"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb4-227">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(mds_first_order,chord_names <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bm7(b5)"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-228">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_classic</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-229">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bm7(b5)"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-230">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>))</span>
<span id="cb4-231"></span>
<span id="cb4-232"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Bm7b5</span></span>
<span id="cb4-233"></span>
<span id="cb4-234"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(patchwork)</span>
<span id="cb4-235">(Cmajor7 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Dminor7) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (G7 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>Bm7b5)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://homophony.quest/blog/30_1_30_24_spinning_chords/index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="1920"></p>
</figure>
</div>
</div>
</div>
<p>In the C7 graph I kept the dotted line to the D note as a reference for the key center in C major scale. For all of the chords I used the bisecting line between the largest angle to compute spin.</p>
<p>C7 is a symmetrical chord that points in between D and A. It has no spin. Similarly, Dm7 is a symmetrical chord centered on G that has no spin.</p>
<p>G7 is not a symmetrical chord and spins anti-clockwise. Bm7(b5) is not symmetrical and spins clockwiseit also points in the same direction as C7.</p>
<p>I need to call it a morning on this side adventure very soon. But, before I go, Im thinking again about chord progressions and this spin concept.</p>
<p>ii-V-I is very common in jazz, and I talked about this <a href="https://homophony.quest/blog/29_1_29_24_cmajor/#ii-v-i">progression in relation to triads and their spin yesterday</a>. Is there a different story with these seventh chords?</p>
<p>Dm7 is ii, and it doesnt have a spin. Its off anti-clockwise from the key center. It is close to G7 (V). Perhaps there is some similarity based gravitational force making Dm7 want to go to G7. Based on spin, its more like G7 wants to go to Dm7. Both Dm7 and G7 are on the anti-clockwise side of the key center (D note), so to remain in the key center balance needs to be restored after playing II and V, hence the C7.</p>
<p>In terms of voicing chords, the spin could change depending on how much weight a given note is given. For example, if C7 was played as four notes it would not have a spin. But, if some of the notes were duplicated, then the vector for those notes would get longer and carry more weight. For example, playing a C7 chord in the right hand on piano, and with an E bass note would tip the chord to spinning clockwise. Emphasizing a C on the bass would spin it anti-clockwise.</p>


</section>

 ]]></description>
  <category>chord similarity</category>
  <category>datavis</category>
  <category>circle of fifths</category>
  <category>music theory</category>
  <category>rstats</category>
  <guid>https://homophony.quest/blog/30_1_30_24_spinning_chords/</guid>
  <pubDate>Tue, 30 Jan 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/30_1_30_24_spinning_chords/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Midi and synthesis in R</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/32_1_30_24_R_synth/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"computer music. musical computer. music represented as bits going into the fabric of the universe. 80s cartoon retro."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/32_1_30_24_R_synth/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>computer music. musical computer. music represented as bits going into the fabric of the universe. 80s cartoon retro. - Dreamshaper v7</p>
</div></div><p>Im going to be running a cognition experiment or two this semester that will involve creating musical stimuli. I would like programmatic control over that, so Im delighted to learn that there are existing R packages that will help me with a few things.</p>
<p>Im just testing a few things out here, which means this page will be a loose collection of notes and scraps of code.</p>
<section id="reading-in-midi-with-pyramidi" class="level2">
<h2 class="anchored" data-anchor-id="reading-in-midi-with-pyramidi">Reading in MIDI with pyramidi</h2>
<p>It looks like I can read in MIDI data to a dataframe with <a href="https://urswilke.github.io/pyramidi/">pyramidi</a>.</p>
<p>Requires some python stuff, but it is working. Kudos to Urs Wilke for developing <code>pyramidi</code>! It uses <a href="https://adv-r.hadley.nz/r6.html">R6</a>, which I dont use very often.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pyramidi)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(purrr)</span>
<span id="cb2-5"></span>
<span id="cb2-6">midifile <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> MidiFramer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Top Gun Theme.mid"</span>)</span>
<span id="cb2-7"></span>
<span id="cb2-8">knitr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(midifile<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>df_notes_wide[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,])</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 8%">
<col style="width: 6%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 6%">
<col style="width: 5%">
<col style="width: 7%">
<col style="width: 17%">
<col style="width: 14%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">i_track</th>
<th style="text-align: left;">meta</th>
<th style="text-align: right;">program</th>
<th style="text-align: right;">channel</th>
<th style="text-align: right;">control</th>
<th style="text-align: right;">value</th>
<th style="text-align: right;">note</th>
<th style="text-align: right;">i_note</th>
<th style="text-align: right;">velocity_note_on</th>
<th style="text-align: right;">ticks_note_on</th>
<th style="text-align: right;">b_note_on</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110</td>
<td style="text-align: right;">2304</td>
<td style="text-align: right;">48</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3792</td>
<td style="text-align: right;">79</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">110</td>
<td style="text-align: right;">3840</td>
<td style="text-align: right;">80</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5328</td>
<td style="text-align: right;">111</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">110</td>
<td style="text-align: right;">5376</td>
<td style="text-align: right;">112</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110</td>
<td style="text-align: right;">5376</td>
<td style="text-align: right;">112</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">6096</td>
<td style="text-align: right;">127</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">6096</td>
<td style="text-align: right;">127</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">110</td>
<td style="text-align: right;">6144</td>
<td style="text-align: right;">128</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">NaN</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110</td>
<td style="text-align: right;">6144</td>
<td style="text-align: right;">128</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="synthesizing-midi-to-wav-and-mp3" class="level2">
<h2 class="anchored" data-anchor-id="synthesizing-midi-to-wav-and-mp3">Synthesizing midi to wav and mp3</h2>
<p><a href="https://urswilke.github.io/raudiomate/">raudiomate</a></p>
<p>also need <a href="https://www.fluidsynth.org">fluid synth</a></p>
<p>And, apparently fluid synth needs sound fonts. Got this one <a href="https://member.keymusician.com/Member/FluidR3_GM/index.html" class="uri">https://member.keymusician.com/Member/FluidR3_GM/index.html</a></p>
<p>I could also try timidity, but I havent gone there yet.</p>
<p>I could not get <code>raudiomate</code> helper functions to work. The <code>processx::run</code> command kept putting quotes where they didnt belong</p>
<ul>
<li>used the system command to run fluidsynth</li>
<li>used the <code>av</code> package to turn the wav into an mp3</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fluidsynth -F out.wav ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 'Top Gun Theme.mid'"</span>)</span>
<span id="cb3-2"></span>
<span id="cb3-3">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"out.wav"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"out.mp3"</span>)</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="out.mp3" type="audio/wav"> </audio></p>
<p>This all took way longer than I expected. Mostly fiddling with python packages and paths to things. But, I declare victory because it made the Top Gun theme song into an mp3.</p>
<hr>
<p>Very happy that it is possible to import, manipulate, and render midi files using R as a central command language. Although I have been messing with midi stuff for since the 80s, I have not tried to programmatically mess with it, or dug into midi file convention and structure.</p>
<p>I have some work ahead if I want to compose computer music with R. That would be fun though. I would probably glitch out until everything descends into modem sounds. Actually, Im secretly extremely excited about some possibilities that Ive wanted to explore.</p>
<p>Anyway, below is scraps of code trying out various things and making notes to my future self.</p>
</section>
<section id="writing-some-random-notes" class="level2">
<h2 class="anchored" data-anchor-id="writing-some-random-notes">Writing some random notes</h2>
<p>Ive only got 30 minutes right now, can I make this thing randomize notes?</p>
<p>Strategy: Read the pyramidi docs, borrow some code from there, and try to play some random notes.</p>
<p>Answer: yes, close enough for now.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># trying stuff from the pyramidi docs</span></span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load in a basic midi file</span></span>
<span id="cb4-4">midi_file_string <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system.file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"extdata"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test_midi_file.mid"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">package =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pyramidi"</span>)</span>
<span id="cb4-5"></span>
<span id="cb4-6">mfr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> MidiFramer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>(midi_file_string)</span>
<span id="cb4-7"></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># mfr has a bunch of midi dataframes in it</span></span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#mfr$df_notes_wide[1:10]</span></span>
<span id="cb4-10"></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># helper function</span></span>
<span id="cb4-12">beats_to_ticks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(notes_wide) {</span>
<span id="cb4-13">  notes_wide <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-14">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb4-15">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ticks_note_on  =</span> b_note_on  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ticks_per_beat,</span>
<span id="cb4-16">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ticks_note_off =</span> b_note_off <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ticks_per_beat</span>
<span id="cb4-17">    )</span>
<span id="cb4-18">}</span>
<span id="cb4-19"></span>
<span id="cb4-20">n_beats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb4-21">ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">960</span>L</span>
<span id="cb4-22"></span>
<span id="cb4-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#(b_note_on = (0:(n_beats-1) %/% 4) * 4)</span></span>
<span id="cb4-24"></span>
<span id="cb4-25">b_note_on <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(n_beats<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)</span>
<span id="cb4-26"></span>
<span id="cb4-27"></span>
<span id="cb4-28">notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb4-29">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-30">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb4-31">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">67</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">72</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace=</span>T),</span>
<span id="cb4-32">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb4-33">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_note =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>n_beats,</span>
<span id="cb4-34">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity_note_on =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span id="cb4-35">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity_note_off =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-36">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b_note_on =</span> b_note_on,</span>
<span id="cb4-37">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b_note_off =</span> b_note_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb4-38">)</span>
<span id="cb4-39"></span>
<span id="cb4-40">mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_notes_wide</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">beats_to_ticks</span>(notes))</span>
<span id="cb4-41"></span>
<span id="cb4-42">df_notes_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_long_notes</span>(mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>df_notes_wide)</span>
<span id="cb4-43">df_midi_out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge_midi_frames</span>(mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>df_meta, mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>df_notes_long, mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>df_not_notes)</span>
<span id="cb4-44"></span>
<span id="cb4-45">dfc2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df_midi_out <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-46">        miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest_midi</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">repair_reticulate_conversion =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb4-47"></span>
<span id="cb4-48">miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_midi</span>(dfc2, ticks_per_beat, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test.mid"</span>)</span>
<span id="cb4-49"></span>
<span id="cb4-50"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fluidsynth -F test.wav ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 'test.mid'"</span>)</span>
<span id="cb4-51"></span>
<span id="cb4-52">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test.wav"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test.mp3"</span>)</span></code></pre></div>
</details>
</div>
<p><audio controls=""> <source src="test.mp3" type="audio/wav"> </audio></p>
</section>
<section id="midi-specs" class="level2">
<h2 class="anchored" data-anchor-id="midi-specs">Midi specs</h2>
<p>Dont have time to read through this today, but here it is.</p>
<ul>
<li><a href="https://www.midi.org/specifications" class="uri">https://www.midi.org/specifications</a></li>
</ul>
</section>
<section id="drums" class="level2">
<h2 class="anchored" data-anchor-id="drums">Drums</h2>
<p>On BPM, tempo, and midi ticks</p>
<ul>
<li><a href="https://majicdesigns.github.io/MD_MIDIFile/page_timing.html" class="uri">https://majicdesigns.github.io/MD_MIDIFile/page_timing.html</a></li>
</ul>
<p>The next bit is straight from <a href="https://urswilke.github.io/pyramidi/articles/compose.html" class="uri">https://urswilke.github.io/pyramidi/articles/compose.html</a>, with a few minor modifications to get things working on my machine.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load system midi file to start</span></span>
<span id="cb5-2">midi_file_string <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system.file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"extdata"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test_midi_file.mid"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">package =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pyramidi"</span>)</span>
<span id="cb5-3"></span>
<span id="cb5-4">mfr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> MidiFramer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>(midi_file_string)</span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set some timing params</span></span>
<span id="cb5-7">n_beats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb5-8">ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">960</span>L</span>
<span id="cb5-9"></span>
<span id="cb5-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># construct a tibble</span></span>
<span id="cb5-11">drum <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb5-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb5-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb5-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This is just a repetition of a classical rock beat:</span></span>
<span id="cb5-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">38</span>), n_beats <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb5-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,</span>
<span id="cb5-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_note =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>n_beats,</span>
<span id="cb5-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity_note_on =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span id="cb5-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity_note_off =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb5-20">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b_note_on =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(n_beats <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb5-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b_note_off =</span> b_note_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb5-22">)</span>
<span id="cb5-23"></span>
<span id="cb5-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># helper function</span></span>
<span id="cb5-25">beats_to_ticks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(notes_wide) {</span>
<span id="cb5-26">  notes_wide <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-27">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb5-28">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ticks_note_on  =</span> b_note_on  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ticks_per_beat,</span>
<span id="cb5-29">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ticks_note_off =</span> b_note_off <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ticks_per_beat</span>
<span id="cb5-30">    )</span>
<span id="cb5-31">}</span>
<span id="cb5-32"></span>
<span id="cb5-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pass the tibble back to the midi df</span></span>
<span id="cb5-34">mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_notes_wide</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">beats_to_ticks</span>(drum))</span>
<span id="cb5-35"></span>
<span id="cb5-36">mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"testagain.mid"</span>)</span>
<span id="cb5-37"></span>
<span id="cb5-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># do pyramidi stuff to get the tibble back into the format it needs to be</span></span>
<span id="cb5-39">df_notes_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_long_notes</span>(mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>df_notes_wide)</span>
<span id="cb5-40">df_midi_out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge_midi_frames</span>(mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>df_meta, mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>df_notes_long, mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>df_not_notes)</span>
<span id="cb5-41"></span>
<span id="cb5-42">dfc2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df_midi_out <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-43">        miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest_midi</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">repair_reticulate_conversion =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb5-44"></span>
<span id="cb5-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write the midi file to disk</span></span>
<span id="cb5-46">miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_midi</span>(dfc2, ticks_per_beat, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test_drums.mid"</span>)</span>
<span id="cb5-47"></span>
<span id="cb5-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb5-49"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fluidsynth -F test_drums.wav ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 'test_drums.mid'"</span>)</span>
<span id="cb5-50"></span>
<span id="cb5-51"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb5-52">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test_drums.wav"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test_drums.mp3"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "/Users/mattcrump/Github/homophony.github.io/blog/32_1_30_24_R_synth/test_drums.mp3"</code></pre>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb7-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test_drums.wav"</span>)){</span>
<span id="cb7-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test_drums.wav"</span>)</span>
<span id="cb7-4">}</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p><audio controls=""> <source src="test_drums.mp3" type="audio/wav"> </audio></p>
<p>Cool, a basic rock beat.</p>
<hr>
<p>Attempting to add hi-hats, change tempo, and generally mess about.</p>
<p>hopefully this percussion midi map helps <a href="https://usermanuals.finalemusic.com/SongWriter2012Win/Content/PercussionMaps.htm" class="uri">https://usermanuals.finalemusic.com/SongWriter2012Win/Content/PercussionMaps.htm</a></p>
<p>Got the hihats, changed the tempo. Im missing something about timing, the resulting wav file is playing with silence at the end, and that seems wrong. Need to tinker some more.</p>
<p><a href="https://mido.readthedocs.io/en/latest/files/midi.html?highlight=set_tempo#about-the-time-attribute" class="uri">https://mido.readthedocs.io/en/latest/files/midi.html?highlight=set_tempo#about-the-time-attribute</a></p>
<p>There seems to be some issues with <code>merge_midi_frames()</code>. The merged dataframe may contain some out of order rows.</p>
<ul>
<li>arranging by ticks gets screwed up when there are 0 ticks in meta and note dfs</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add additional sorting by i_note, seems to solve the curent problem</span></span>
<span id="cb9-2">merge_midi_frames_matt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb9-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df_meta, df_notes_long, df_not_notes) {</span>
<span id="cb9-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(df_meta) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb9-5">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(df_notes_long) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(df_not_notes)) {</span>
<span id="cb9-6">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>)</span>
<span id="cb9-7">    }</span>
<span id="cb9-8">    cols_to_remove <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"i_note"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ticks"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"m"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b"</span>)</span>
<span id="cb9-9">    </span>
<span id="cb9-10">    res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df_notes_long <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-11">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(df_meta) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-12">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(df_not_notes)</span>
<span id="cb9-13">    </span>
<span id="cb9-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if in tab_measures() there weren't all columns built, we have to remove them here:</span></span>
<span id="cb9-15">    cols_to_remove <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">intersect</span>(cols_to_remove, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(res))</span>
<span id="cb9-16">    res <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-17">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i_track, .data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks, .data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i_note) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-18">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i_track) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-19">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> .data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(.data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> {</span>
<span id="cb9-20">        .[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb9-21">        .</span>
<span id="cb9-22">      }) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-23">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-24">      dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-!!</span>cols_to_remove)</span>
<span id="cb9-25">  }</span></code></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load system midi file to start</span></span>
<span id="cb10-2">midi_file_string <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system.file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"extdata"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test_midi_file.mid"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">package =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pyramidi"</span>)</span>
<span id="cb10-3"></span>
<span id="cb10-4">mfr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> MidiFramer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>(midi_file_string)</span>
<span id="cb10-5"></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set tempo</span></span>
<span id="cb10-7">BPM_to_microsecond_tempo <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(BPM) {</span>
<span id="cb10-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60000000</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>BPM)</span>
<span id="cb10-9">}</span>
<span id="cb10-10"></span>
<span id="cb10-11">midi_tempo <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">BPM_to_microsecond_tempo</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span>)</span>
<span id="cb10-12"></span>
<span id="cb10-13">mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>df_meta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>df_meta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"set_tempo"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> midi_tempo),</span>
<span id="cb10-15">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clocks_per_click =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time_signature"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>),</span>
<span id="cb10-16">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#keep the first track</span></span>
<span id="cb10-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(i_track <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb10-19"></span>
<span id="cb10-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#View(mfr$df_meta)</span></span>
<span id="cb10-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#mfr$ticks_per_beat</span></span>
<span id="cb10-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#View(mfr$df_notes_wide)</span></span>
<span id="cb10-23"></span>
<span id="cb10-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set some timing params</span></span>
<span id="cb10-25">num_bars <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb10-26">n_beats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> num_bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb10-27">smallest_note_per_bar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb10-28">max_steps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> num_bars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>smallest_note_per_bar</span>
<span id="cb10-29"></span>
<span id="cb10-30">ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">960</span>L</span>
<span id="cb10-31">mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">960</span>L</span>
<span id="cb10-32"></span>
<span id="cb10-33"></span>
<span id="cb10-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Construct a beat with hihats</span></span>
<span id="cb10-35">drum <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb10-36">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb10-37">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_note =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>max_steps,</span>
<span id="cb10-38">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">kick =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>,<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>,<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>),<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb10-39">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">snare =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>,<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>),<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb10-40">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hihat_closed =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>),</span>
<span id="cb10-41">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb10-42">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">channel =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>,</span>
<span id="cb10-43">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity_note_on =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span id="cb10-44">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">velocity_note_off =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb10-45">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b_note_on =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(max_steps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb10-46">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b_note_off =</span> b_note_on <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb10-47">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-48">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">kick =</span> kick<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>,</span>
<span id="cb10-49">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">snare =</span> snare<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">38</span>,</span>
<span id="cb10-50">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hihat_closed =</span> hihat_closed<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-51">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kick"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"snare"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hihat_closed"</span>), </span>
<span id="cb10-52">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"note"</span>,</span>
<span id="cb10-53">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_drop_na =</span> T) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-54">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b_note_on =</span> b_note_on<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb10-55">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b_note_off =</span> b_note_off<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb10-56"></span>
<span id="cb10-57">drum<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i_note <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(drum)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb10-58"></span>
<span id="cb10-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># helper function</span></span>
<span id="cb10-60">beats_to_ticks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(notes_wide) {</span>
<span id="cb10-61">  notes_wide <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-62">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb10-63">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ticks_note_on  =</span> b_note_on  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ticks_per_beat,</span>
<span id="cb10-64">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ticks_note_off =</span> b_note_off <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ticks_per_beat</span>
<span id="cb10-65">    )</span>
<span id="cb10-66">}</span>
<span id="cb10-67"></span>
<span id="cb10-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pass the tibble back to the midi df</span></span>
<span id="cb10-69">mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_notes_wide</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">beats_to_ticks</span>(drum))</span>
<span id="cb10-70"></span>
<span id="cb10-71">df_notes_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_long_notes</span>(mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>df_notes_wide)</span>
<span id="cb10-72">df_not_notes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>df_not_notes</span>
<span id="cb10-73"></span>
<span id="cb10-74"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># do pyramidi stuff to get the tibble back into the format it needs to be</span></span>
<span id="cb10-75"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#mfr$df_notes_long &lt;- pivot_long_notes(mfr$df_notes_wide)</span></span>
<span id="cb10-76"></span>
<span id="cb10-77">df_meta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mfr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>df_meta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-78">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ticks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"end_of_track"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(df_notes_long<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>ticks_per_beat),</span>
<span id="cb10-79">                           type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"end_of_track"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb10-80"></span>
<span id="cb10-81"></span>
<span id="cb10-82"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#mfr$df_meta &lt;- mfr$df_meta %&gt;%</span></span>
<span id="cb10-83"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  mutate(ticks = case_when(type == "end_of_track" ~ (max(mfr$df_notes_long$ticks)+ticks_per_beat)))</span></span>
<span id="cb10-84"></span>
<span id="cb10-85">df_midi_out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge_midi_frames_matt</span>(df_meta, df_notes_long, df_not_notes)</span>
<span id="cb10-86"></span>
<span id="cb10-87">dfc2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df_midi_out <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb10-88">        miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest_midi</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">repair_reticulate_conversion =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb10-89"></span>
<span id="cb10-90"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">#########</span></span>
<span id="cb10-91"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bounce </span></span>
<span id="cb10-92"></span>
<span id="cb10-93">track_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"try_Write"</span></span>
<span id="cb10-94"></span>
<span id="cb10-95">wav_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>)</span>
<span id="cb10-96">midi_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mid"</span>)</span>
<span id="cb10-97">mp3_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(track_name,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".mp3"</span>)</span>
<span id="cb10-98"></span>
<span id="cb10-99"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write the midi file to disk</span></span>
<span id="cb10-100">miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_midi</span>(dfc2, ticks_per_beat, midi_name)</span>
<span id="cb10-101"></span>
<span id="cb10-102"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># synthesize midi file to wav with fluid synth</span></span>
<span id="cb10-103">system_command <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fluidsynth -F {wav_name} ~/Library/Audio/Sounds/Banks/FluidR3_GM.sf2 {midi_name}'</span>)</span>
<span id="cb10-104"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span>(system_command)</span>
<span id="cb10-105"></span>
<span id="cb10-106"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert wav to mp3</span></span>
<span id="cb10-107">av<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">av_audio_convert</span>(wav_name,mp3_name)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "/Users/mattcrump/Github/homophony.github.io/blog/32_1_30_24_R_synth/try_Write.mp3"</code></pre>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># clean up and delete wav</span></span>
<span id="cb12-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(wav_name)){</span>
<span id="cb12-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.remove</span>(wav_name)</span>
<span id="cb12-4">}</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p><audio controls=""> <source src="try_Write.mp3" type="audio/wav"> </audio></p>
<p>This works sort of. MIDI fried my brain here. For some reason the file has extra bars of silence, cant figure out why right now. Im missing something here about how midi time works.</p>
<ul>
<li>loaded better in musescore.</li>
<li>musescore shows two bars, but it plays through 4 barsnot sure what is going on.</li>
</ul>
</section>
<section id="piano-keyboard-plot-with-ggplot2" class="level2">
<h2 class="anchored" data-anchor-id="piano-keyboard-plot-with-ggplot2">Piano keyboard plot with ggplot2</h2>
<p>Neat, this is from <a href="https://urswilke.github.io/pyramidi/reference/piano_keys_coordinates.html">pyramidi</a>.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb14-2"></span>
<span id="cb14-3">piano_keys_coordinates <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb14-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot white keys first that they don't cover half of the black keys:</span></span>
<span id="cb14-5">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(layer) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb14-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(</span>
<span id="cb14-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> ymin,</span>
<span id="cb14-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> ymax,</span>
<span id="cb14-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> xmin,</span>
<span id="cb14-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> xmax,</span>
<span id="cb14-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(layer)</span>
<span id="cb14-12">  )) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show.legend =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#ffffdd"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#113300"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ratio =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://homophony.quest/blog/32_1_30_24_R_synth/index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Lets try plotting a chord, C7. Cool!</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get midi notes from table look up</span></span>
<span id="cb15-2">note_numbers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> midi_defs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(note_name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C4"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E4"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G4"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bb4"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(note)</span>
<span id="cb15-5"></span>
<span id="cb15-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot</span></span>
<span id="cb15-7">piano_keys_coordinates <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make black keys 3rd order for printing</span></span>
<span id="cb15-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">layer =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(layer <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb15-10">                           layer <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set played keys to layer 2</span></span>
<span id="cb15-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">layer =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(midi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> note_numbers <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb15-13">                           midi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> note_numbers <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> layer)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot white keys first that they don't cover half of the black keys:</span></span>
<span id="cb15-15">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(layer) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb15-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(</span>
<span id="cb15-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> ymin,</span>
<span id="cb15-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> ymax,</span>
<span id="cb15-19">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> xmin,</span>
<span id="cb15-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> xmax,</span>
<span id="cb15-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(layer)</span>
<span id="cb15-22">  )) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show.legend =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#ffffdd"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pink"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#113300"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_fixed</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ratio =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://homophony.quest/blog/32_1_30_24_R_synth/index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="miditapyr" class="level2">
<h2 class="anchored" data-anchor-id="miditapyr">miditapyr</h2>
<p><a href="https://miditapyr.readthedocs.io/en/latest/notebooks/midi_frame_usage.html" class="uri">https://miditapyr.readthedocs.io/en/latest/notebooks/midi_frame_usage.html</a></p>
<p>Learning more about the miditapyr workflow.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi using miditapyr</span></span>
<span id="cb16-2">test_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFrames</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ableton.mid"</span>)</span>
<span id="cb16-3"></span>
<span id="cb16-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#View(test_midi$midi_frame_unnested$df)</span></span>
<span id="cb16-5"></span>
<span id="cb16-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># modify something</span></span>
<span id="cb16-7">mod_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb16-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">note =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(note <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">72</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">63</span>,</span>
<span id="cb16-9">                          <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> note))</span>
<span id="cb16-10"></span>
<span id="cb16-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update df</span></span>
<span id="cb16-12">test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(mod_df)</span>
<span id="cb16-13"></span>
<span id="cb16-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write midi file</span></span>
<span id="cb16-15"></span>
<span id="cb16-16">test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ableton2.mid"</span>)</span></code></pre></div>
</details>
</div>
<p>I made a 1 bar drum loop in ableton, using the clip view. Apparently this kind of midi file does not contain the meta set_tempo message</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import midi using miditapyr</span></span>
<span id="cb17-2">test_midi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFrames</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ableton.mid"</span>)</span>
<span id="cb17-3"></span>
<span id="cb17-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#import using mido</span></span>
<span id="cb17-5">mido_import <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>mido<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">MidiFile</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ableton.mid"</span>)</span>
<span id="cb17-6"></span>
<span id="cb17-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to R dataframe</span></span>
<span id="cb17-8">dfc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frame_midi</span>(mido_import)</span>
<span id="cb17-9">ticks_per_beat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mido_import<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ticks_per_beat</span>
<span id="cb17-10"></span>
<span id="cb17-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># unnest the dataframe</span></span>
<span id="cb17-12">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_midi</span>(dfc)</span>
<span id="cb17-13"></span>
<span id="cb17-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add set_tempo message</span></span>
<span id="cb17-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># missing from ableton midi clip</span></span>
<span id="cb17-16"></span>
<span id="cb17-17">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb17-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb17-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb17-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb17-21">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb17-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb17-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"set_tempo"</span>,</span>
<span id="cb17-24">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>,</span>
<span id="cb17-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.before =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb17-26">  )</span></code></pre></div>
</details>
</div>
<p>Before I go on, I need to do some timing tests to make sure I understand a few things.</p>
<p>The beat is 1 bar. There are 4 beats per bar. The hi hats are in 16th notes, and there are 16 hi hats. The tempo is set to 120. What happens if I play with the time column.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># reload df</span></span>
<span id="cb18-2">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pyramidi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>miditapyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_midi</span>(dfc)</span>
<span id="cb18-3"></span>
<span id="cb18-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add set_tempo message</span></span>
<span id="cb18-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># missing from ableton midi clip</span></span>
<span id="cb18-6"></span>
<span id="cb18-7">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb18-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NaN</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb18-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_row</span>(</span>
<span id="cb18-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_track =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb18-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb18-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meta =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb18-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"set_tempo"</span>,</span>
<span id="cb18-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tempo =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500000</span>,</span>
<span id="cb18-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.before =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb18-16">  )</span>
<span id="cb18-17"></span>
<span id="cb18-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># futz with the time column</span></span>
<span id="cb18-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># behaves as expected, yah!</span></span>
<span id="cb18-20">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb18-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> time<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb18-22"></span>
<span id="cb18-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update df</span></span>
<span id="cb18-24">test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>midi_frame_unnested<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_unnested_mf</span>(df)</span>
<span id="cb18-25"></span>
<span id="cb18-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># write midi file</span></span>
<span id="cb18-27"></span>
<span id="cb18-28">test_midi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_file</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ableton2.mid"</span>)</span></code></pre></div>
</details>
</div>
<p>The pyramidi package has a <code>tab_measures()</code> function that adds additional timing information, for later use in composition and modification.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add more time info</span></span>
<span id="cb19-2"></span>
<span id="cb19-3">dfm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tab_measures</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ticks_per_beat =</span> ticks_per_beat)</span></code></pre></div>
</details>
</div>


</section>

 ]]></description>
  <category>midi</category>
  <category>fluidsynth</category>
  <category>rstats</category>
  <guid>https://homophony.quest/blog/32_1_30_24_R_synth/</guid>
  <pubDate>Tue, 30 Jan 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/32_1_30_24_R_synth/cover.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>A sphere of fifths</title>
  <dc:creator>Matt Crump</dc:creator>
  <link>https://homophony.quest/blog/31_1_30_24_sphere/</link>
  <description><![CDATA[ 




<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> diffusers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DiffusionPipeline</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> set_seed</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ssl</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-8">ssl._create_default_https_context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ssl._create_unverified_context</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#locate library</span></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model_id = "./stable-diffusion-v1-5"</span></span>
<span id="cb1-12">model_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dreamshaper-xl-turbo"</span></span>
<span id="cb1-13"></span>
<span id="cb1-14">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionPipeline.from_pretrained(</span>
<span id="cb1-15">    pretrained_model_name_or_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../../../bigFiles/huggingface/dreamshaper-xl-turbo/"</span></span>
<span id="cb1-16">)</span>
<span id="cb1-17"></span>
<span id="cb1-18">pipeline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline.to(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mps"</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recommended if your computer has &lt; 64 GB of RAM</span></span>
<span id="cb1-21">pipeline.enable_attention_slicing(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max"</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"piano chord. 3d sphere. piano sphere. retro. 80s cartoon."</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb1-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb1-27">    seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span></span>
<span id="cb1-28">    num_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-29">    set_seed(seed)</span>
<span id="cb1-30">    </span>
<span id="cb1-31">    image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pipeline(prompt,height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>,num_images_per_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,num_inference_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>num_steps)</span>
<span id="cb1-32">    </span>
<span id="cb1-33">    image_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"images/synth_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.jpeg"</span></span>
<span id="cb1-34">    </span>
<span id="cb1-35">    image_save <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image.images[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].save(image_name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(seed,num_steps))</span></code></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://homophony.quest/blog/31_1_30_24_sphere/cover.jpg" class="img-fluid quarto-figure quarto-figure-left figure-img" style="width:50.0%"></p>
</figure>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>piano chord. 3d sphere. piano sphere. retro. 80s cartoon. - Dreamshaper v7</p>
</div></div><p>My previous graphs of chord space have been 2-dimensional. I havent looked at the eigendecomposition of the similarity matrix, so Im not sure how many meaningful dimensions there are here. Nevertheless, there are more dimensions than implied by the 2d graph. Ive been meaning to use MDS to create a 3d plot, and thats what Im doing here, hopefully with plotly so it can be spun around interactively in the browser.</p>
<section id="chord-sphere" class="level2">
<h2 class="anchored" data-anchor-id="chord-sphere">Chord sphere</h2>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pre-processing to get the chord vectors</span></span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load chord vectors</span></span>
<span id="cb2-5">c_chord_excel <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rio<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">import</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chord_vectors.xlsx"</span>)</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># grab feature vectors</span></span>
<span id="cb2-8">c_chord_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(c_chord_excel[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>])</span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assign row names to the third column containing chord names</span></span>
<span id="cb2-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(c_chord_matrix) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> c_chord_excel[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb2-12"></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define all keys</span></span>
<span id="cb2-14">keys <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Db"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Eb"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gb"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"G"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ab"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bb"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>)</span>
<span id="cb2-15"></span>
<span id="cb2-16"></span>
<span id="cb2-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the excel sheet only has chords in C</span></span>
<span id="cb2-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loop through the keys, permute the matrix to get the chords in the next key</span></span>
<span id="cb2-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add the permuted matrix to new rows in the overall chord_matrix</span></span>
<span id="cb2-20"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(keys)) {</span>
<span id="cb2-21"></span>
<span id="cb2-22">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb2-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize chord_matrix with C matrix</span></span>
<span id="cb2-24">    chord_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> c_chord_matrix</span>
<span id="cb2-25"></span>
<span id="cb2-26">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb2-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#permute the matrix as a function of iterator</span></span>
<span id="cb2-28">    new_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(c_chord_matrix[, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>i)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>],c_chord_matrix[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>i)] )</span>
<span id="cb2-29"></span>
<span id="cb2-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rename the rows with the new key</span></span>
<span id="cb2-31">    new_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>, keys[i], c_chord_excel[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb2-32">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(new_matrix) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> new_names</span>
<span id="cb2-33"></span>
<span id="cb2-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># append the new_matrix to chord_matrix</span></span>
<span id="cb2-35">    chord_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(chord_matrix,new_matrix)</span>
<span id="cb2-36"></span>
<span id="cb2-37">  }</span>
<span id="cb2-38">}</span>
<span id="cb2-39"></span>
<span id="cb2-40">chord_properties <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb2-41">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(c_chord_excel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(keys)),</span>
<span id="cb2-42">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">key =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(keys, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(c_chord_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb2-43">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chord_names  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(chord_matrix),</span>
<span id="cb2-44">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">synonyms =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>),</span>
<span id="cb2-45">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">database_chord =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb2-46">)</span>
<span id="cb2-47"></span>
<span id="cb2-48">first_order <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> lsa<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cosine</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(chord_matrix))</span>
<span id="cb2-49"></span>
<span id="cb2-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find repeats and build synonym list</span></span>
<span id="cb2-51">repeat_indices <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>()</span>
<span id="cb2-52"></span>
<span id="cb2-53">first_occurrence <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>()</span>
<span id="cb2-54"></span>
<span id="cb2-55"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(chord_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]){</span>
<span id="cb2-56">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the current row</span></span>
<span id="cb2-57">  evaluate_row <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> first_order[i,]</span>
<span id="cb2-58"></span>
<span id="cb2-59">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># don't count the current item as a repeat</span></span>
<span id="cb2-60">  evaluate_row[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb2-61"></span>
<span id="cb2-62">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># repeats are the ids for any other 1s found</span></span>
<span id="cb2-63">  repeats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(evaluate_row <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> )</span>
<span id="cb2-64"></span>
<span id="cb2-65">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(repeats) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>){</span>
<span id="cb2-66">  }</span>
<span id="cb2-67"></span>
<span id="cb2-68">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(repeats) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>){</span>
<span id="cb2-69">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#add to list of repeat items</span></span>
<span id="cb2-70">    repeat_indices <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(repeat_indices,repeats)</span>
<span id="cb2-71"></span>
<span id="cb2-72">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add synonyms</span></span>
<span id="cb2-73">    chord_properties<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>synonyms[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">synonyms =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(chord_matrix)[repeats])</span>
<span id="cb2-74">  }</span>
<span id="cb2-75"></span>
<span id="cb2-76">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> first_occurrence <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>){</span>
<span id="cb2-77">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> repeat_indices <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>){</span>
<span id="cb2-78">      first_occurrence <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(first_occurrence,i)</span>
<span id="cb2-79">      chord_properties<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>database_chord[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb2-80">    }</span>
<span id="cb2-81">  }</span>
<span id="cb2-82">}</span>
<span id="cb2-83"></span>
<span id="cb2-84">chord_properties <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> chord_properties <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-85">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">num_notes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rowSums</span>(chord_matrix),</span>
<span id="cb2-86">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(chord_matrix)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb2-87"></span>
<span id="cb2-88"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># keep only unique chord, recompute similarities</span></span>
<span id="cb2-89">chord_matrix_no_repeats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> chord_matrix[first_occurrence,]</span>
<span id="cb2-90">first_order_no_repeats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> lsa<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cosine</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(chord_matrix_no_repeats))</span>
<span id="cb2-91">second_order_no_repeats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> lsa<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cosine</span>(first_order_no_repeats)</span>
<span id="cb2-92"></span>
<span id="cb2-93"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remove scales and individual notes</span></span>
<span id="cb2-94">only_chords <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> chord_properties <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-95">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(type<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>,</span>
<span id="cb2-96">         type<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"key"</span>,</span>
<span id="cb2-97">         database_chord <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb2-98"></span>
<span id="cb2-99">first_order_chords <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> first_order_no_repeats[only_chords<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>chord_names,</span>
<span id="cb2-100">                                               only_chords<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>chord_names]</span>
<span id="cb2-101">second_order_chords <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> second_order_no_repeats[only_chords<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>chord_names,</span>
<span id="cb2-102">                                               only_chords<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>chord_names]</span></code></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggrepel)</span>
<span id="cb3-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(plotly)</span>
<span id="cb3-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(bslib)</span>
<span id="cb3-5"></span>
<span id="cb3-6">mds_first_order <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cmdscale</span>((first_order<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb3-7">mds_first_order <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(mds_first_order) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(chord_properties) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bold_me =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"key"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,</span>
<span id="cb3-10">                             type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"key"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"other"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb3-12">         num_notes <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb3-13"></span>
<span id="cb3-14">fig <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot_ly</span>(mds_first_order, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>V1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>V2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">z =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>V3, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>type, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mode=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>chord_names)</span>
<span id="cb3-15"></span>
<span id="cb3-16">fig <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb3-17">  bslib<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">card</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full_screen =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="card bslib-card bslib-mb-spacing html-fill-item html-fill-container" data-bslib-card-init="" data-full-screen="false" data-require-bs-caller="card()" data-require-bs-version="5">
<div class="card-body bslib-gap-spacing html-fill-item html-fill-container" style="margin-top:auto;margin-bottom:auto;flex:1 1 auto;">
<div class="plotly html-widget html-fill-item" id="htmlwidget-de33912c0fdf5ec41a96" style="width:100%;height:400px;"></div>
<script type="application/json" data-for="htmlwidget-de33912c0fdf5ec41a96">{"x":{"visdat":{"54061a76edf":["function () ","plotlyVisDat"]},"cur_data":"54061a76edf","attrs":{"54061a76edf":{"x":{},"y":{},"z":{},"mode":"text","text":{},"color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20]}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"scene":{"xaxis":{"title":"V1"},"yaxis":{"title":"V2"},"zaxis":{"title":"V3"}},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[3.6754507151208757e-17,0.14708745491499944,2.310398288195577e-16,-0.083329950699634697,-2.5015665961959773e-16,-0.0027557465110215188,-2.5927987832278584e-16,0.088103043669505512,1.4228623316157677e-16,-0.14984320142602062,1.0348382775257895e-16,0.17143299436914008,-4.6382732792241629e-17,-0.14708745491499894,3.2676534732010637e-16,0.083329950699635405,-2.9634973568447298e-16,0.0027557465110213258,-1.7391605169407509e-16,-0.088103043669504902,8.1947981723480366e-17,0.14984320142602078,4.1344338698695019e-17,-0.17143299436914014],"y":[2.5395671229765589e-16,-0.088103043669504694,-4.0743653974158643e-16,0.14984320142602048,1.9426178019816452e-16,-0.17143299436913959,3.5712314645985099e-17,0.14708745491499917,1.467384387851145e-16,-0.083329950699634753,-6.3248341696875314e-17,-0.0027557465110216515,2.5761640932521498e-16,0.088103043669505388,-3.628327072793328e-16,-0.14984320142602092,2.5653519637629417e-16,0.17143299436914058,-1.1749243843012779e-17,-0.14708745491499944,2.4998326408140813e-16,0.083329950699635544,-6.5631401592026472e-17,0.0027557465110214269],"z":[-0.46660535885451754,-0.46676964763402995,0.46660535885452337,0.46676964763403483,-0.46660535885451943,-0.46676964763403728,0.46660535885451138,0.46676964763403606,-0.46660535885450705,-0.46676964763403045,0.46660535885450966,0.46676964763402906,-0.46660535885451793,-0.46676964763403139,0.46660535885452314,0.46676964763403478,-0.46660535885451948,-0.46676964763403556,0.46660535885451127,0.4667696476340355,-0.46660535885450721,-0.46676964763403217,0.46660535885450993,0.46676964763402862],"mode":"text","text":["C7(b5)","C7(#5)","Db7(b5)","Db7(#5)","D7(b5)","D7(#5)","Eb7(b5)","Eb7(#5)","E7(b5)","E7(#5)","F7(b5)","F7(#5)","Gb7(b5)","Gb7(#5)","G7(b5)","G7(#5)","Ab7(b5)","Ab7(#5)","A7(b5)","A7(#5)","Bb7(b5)","Bb7(#5)","B7(b5)","B7(#5)"],"type":"scatter3d","name":"altered","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"frame":null},{"x":[-0.078756296866261968,0.22539282331616053,-0.31163552477872297,0.31437573904397703,-0.2328792279124608,0.088982915727817108,0.078756296866261899,-0.22539282331616003,0.31163552477872214,-0.31437573904397709,0.2328792279124608,-0.088982915727817372],"y":[-0.31437573904397714,0.23287922791246071,-0.088982915727816886,-0.07875629686626183,0.22539282331616048,-0.31163552477872275,0.31437573904397764,-0.23287922791246132,0.088982915727817413,0.078756296866261899,-0.22539282331616034,0.31163552477872303],"z":[-0.23533744406158788,0.23533744406160165,-0.23533744406160445,0.23533744406159637,-0.23533744406158597,0.23533744406158388,-0.23533744406159107,0.23533744406160073,-0.23533744406160312,0.23533744406159759,-0.23533744406158744,0.23533744406158286],"mode":"text","text":["C7","Db7","D7","Eb7","E7","F7","Gb7","G7","Ab7","A7","Bb7","B7"],"type":"scatter3d","name":"dominant 7th","marker":{"color":"rgba(252,141,98,1)","line":{"color":"rgba(252,141,98,1)"}},"textfont":{"color":"rgba(252,141,98,1)"},"error_y":{"color":"rgba(252,141,98,1)"},"error_x":{"color":"rgba(252,141,98,1)"},"line":{"color":"rgba(252,141,98,1)"},"frame":null},{"x":[0.30710991329191267,-0.22524002982548255,0.083017262264152514,0.081449913678699665,-0.22409265102776021,0.30668994350418277,-0.30710991329191273,0.22524002982548233,-0.083017262264152333,-0.0814499136787004,0.22409265102776021,-0.30668994350418216],"y":[-0.081449913678699748,0.2240926510277603,-0.30668994350418255,0.30710991329191295,-0.22524002982548266,0.083017262264152306,0.081449913678700331,-0.22409265102776058,0.30668994350418288,-0.30710991329191228,0.22524002982548288,-0.083017262264152625],"z":[-0.23126791479293088,0.23126791479293066,-0.23126791479292003,0.23126791479291117,-0.23126791479291284,0.23126791479292214,-0.23126791479292957,0.23126791479292957,-0.23126791479292078,0.231267914792912,-0.23126791479291223,0.23126791479292128],"mode":"text","text":["Cm7(b5)","Dbm7(b5)","Dm7(b5)","Ebm7(b5)","Em7(b5)","Fm7(b5)","Gbm7(b5)","Gm7(b5)","Abm7(b5)","Am7(b5)","Bbm7(b5)","Bm7(b5)"],"type":"scatter3d","name":"half-diminished 7th","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"line":{"color":"rgba(141,160,203,1)"},"frame":null},{"x":[0.0025821171599286416,0.20724033647752346,-0.36153290931667098,0.41895303106714138,-0.36411502647659971,0.211712694589617,-0.0025821171599297878,-0.20724033647752477,0.36153290931667176,-0.41895303106714143,0.36411502647660071,-0.21171269458961775],"y":[-0.41895303106714094,0.36411502647659982,-0.21171269458961658,0.0025821171599286351,0.20724033647752516,-0.36153290931667226,0.41895303106714205,-0.36411502647660055,0.21171269458961686,-0.0025821171599284803,-0.20724033647752474,0.36153290931667159],"z":[-0.28720274933164269,0.28720274933164047,-0.28720274933163148,0.28720274933162504,-0.28720274933162726,0.28720274933163892,-0.28720274933164402,0.28720274933164086,-0.28720274933162876,0.28720274933162465,-0.28720274933162937,0.28720274933163858],"mode":"text","text":["C note","Db note","D note","Eb note","E note","F note","Gb note","G note","Ab note","A note","Bb note","B note"],"type":"scatter3d","name":"key","marker":{"color":"rgba(231,138,195,1)","line":{"color":"rgba(231,138,195,1)"}},"textfont":{"color":"rgba(231,138,195,1)"},"error_y":{"color":"rgba(231,138,195,1)"},"error_x":{"color":"rgba(231,138,195,1)"},"line":{"color":"rgba(231,138,195,1)"},"frame":null},{"x":[-0.30612647646942281,-0.083452237587452294,-0.22476966460753986,0.31013171716858356,0.0019189792473506509,0.082787309036964032,-0.23103741470514574,0.080128468032368783,0.081377839133621122,0.090036823550089573,-0.14070555701207141,-0.22373786102656273,0.075089061764276696,0.16358070561981872,0.30614750374117033,-0.22009489361849363,-0.14262453625942229,-0.30652517006352648,0.30612647646942198,0.083452237587449796,0.22476966460754849,-0.31013171716858318,-0.0019189792473504751,-0.082787309036963824,0.23103741470514519,-0.080128468032368824,-0.081377839133620955,-0.090036823550089184,0.14070555701207177,0.22373786102656248,-0.075089061764276821,-0.16358070561981902,-0.3061475037411695,0.22009489361849369,0.1426245362594224,0.30652517006352692],"y":[-0.090036823550089726,0.14070555701207196,0.22373786102656271,-0.075089061764276765,-0.16358070561981922,-0.30614750374117011,0.22009489361849394,0.1426245362594224,0.3065251700635267,-0.30612647646942209,-0.083452237587450184,-0.22476966460754869,0.31013171716858362,0.0019189792473506039,0.082787309036964227,-0.23103741470514552,0.080128468032368727,0.081377839133620969,0.090036823550089462,-0.14070555701207163,-0.22373786102656215,0.075089061764276516,0.16358070561981891,0.30614750374116967,-0.22009489361849421,-0.1426245362594224,-0.30652517006352648,0.30612647646942209,0.083452237587450059,0.22476966460754896,-0.31013171716858368,-0.001918979247350188,-0.082787309036963699,0.23103741470514574,-0.080128468032368769,-0.081377839133621024],"z":[-0.0031765082125666646,-0.22858206717021129,-0.23366338815770893,0.0031765082125735063,0.22858206717021057,0.23366338815770929,-0.0031765082125747865,-0.22858206717021282,-0.23366338815770452,0.0031765082125716874,0.22858206717021498,0.23366338815770099,-0.0031765082125685684,-0.2285820671702169,-0.23366338815770377,0.0031765082125674651,0.22858206717021695,0.23366338815770837,-0.0031765082125688507,-0.2285820671702139,-0.23366338815770998,0.0031765082125716519,0.22858206717020974,0.23366338815770854,-0.0031765082125732075,-0.22858206717021004,-0.23366338815770363,0.0031765082125735935,0.22858206717021598,0.23366338815770238,-0.0031765082125709749,-0.22858206717021967,-0.23366338815770507,0.0031765082125657061,0.22858206717021598,0.23366338815770737],"mode":"text","text":["C7","C7(#5)","C7(b5)","Db7","Db7(#5)","Db7(b5)","D7","D7(#5)","D7(b5)","Eb7","Eb7(#5)","Eb7(b5)","E7","E7(#5)","E7(b5)","F7","F7(#5)","F7(b5)","Gb7","Gb7(#5)","Gb7(b5)","G7","G7(#5)","G7(b5)","Ab7","Ab7(#5)","Ab7(b5)","A7","A7(#5)","A7(b5)","Bb7","Bb7(#5)","Bb7(b5)","B7","B7(#5)","B7(b5)"],"type":"scatter3d","name":"major 7th","marker":{"color":"rgba(166,216,84,1)","line":{"color":"rgba(166,216,84,1)"}},"textfont":{"color":"rgba(166,216,84,1)"},"error_y":{"color":"rgba(166,216,84,1)"},"error_x":{"color":"rgba(166,216,84,1)"},"line":{"color":"rgba(166,216,84,1)"},"frame":null},{"x":[0.23063972089546339,-0.0043168916970113486,-0.22316264514546763,0.3908459314404259,-0.45380236604093199,0.39516282313743734,-0.23063972089546408,0.0043168916970110442,0.22316264514546821,-0.39084593144042545,0.45380236604093188,-0.39516282313743761],"y":[-0.39084593144042601,0.45380236604093194,-0.39516282313743756,0.23063972089546425,-0.0043168916970114822,-0.22316264514546777,0.3908459314404264,-0.4538023660409321,0.39516282313743795,-0.23063972089546386,0.0043168916970115767,0.22316264514546838],"z":[-0.0060266446147988102,0.0060266446148050917,-0.0060266446148009994,0.0060266446147916701,-0.0060266446147871173,0.0060266446147923649,-0.0060266446147985474,0.006026644614802578,-0.0060266446148004174,0.0060266446147934334,-0.0060266446147873619,0.0060266446147905313],"mode":"text","text":["Cm7","Dbm7","Dm7","Ebm7","Em7","Fm7","Gbm7","Gm7","Abm7","Am7","Bbm7","Bm7"],"type":"scatter3d","name":"minor 7th","marker":{"color":"rgba(255,217,47,1)","line":{"color":"rgba(255,217,47,1)"}},"textfont":{"color":"rgba(255,217,47,1)"},"error_y":{"color":"rgba(255,217,47,1)"},"error_x":{"color":"rgba(255,217,47,1)"},"line":{"color":"rgba(255,217,47,1)"},"frame":null},{"x":[-9.5643600089025745e-05,0.14388321796360926,0.28143481252864944,0.14432714586746706,-0.48736375071815358,-0.39386516751746647,0.56270396548252577,0.53786733560441236,-0.48726810711806434,-0.53774838548107629,0.28126915295387689,0.39354018973694532,9.5643600089042103e-05,-0.14388321796360948,-0.28143481252864938,-0.14432714586746689,0.48736375071815374,0.39386516751746653,-0.56270396548252544,-0.53786733560441213,0.48726810711806456,0.53774838548107617,-0.28126915295387672,-0.39354018973694549],"y":[-0.56270396548252677,-0.5378673356044128,0.48726810711806418,0.53774838548107595,-0.28126915295387639,-0.3935401897369451,-9.5643600089010322e-05,0.14388321796360945,0.28143481252864977,0.14432714586746709,-0.48736375071815402,-0.39386516751746631,0.56270396548252555,0.53786733560441224,-0.48726810711806556,-0.53774838548107595,0.28126915295387606,0.39354018973694538,9.5643600089340353e-05,-0.14388321796360934,-0.2814348125286496,-0.14432714586746698,0.48736375071815369,0.39386516751746675],"z":[0.14921488075522094,-0.0032884944208844791,-0.1492148807552198,0.0032884944208891793,0.14921488075521963,-0.0032884944208912358,-0.14921488075522038,0.0032884944208895106,0.14921488075522099,-0.0032884944208853256,-0.14921488075522008,0.0032884944208836763,0.14921488075522016,-0.0032884944208843069,-0.14921488075522046,0.0032884944208888354,0.14921488075522085,-0.003288494420891032,-0.14921488075522046,0.0032884944208897019,0.1492148807552198,-0.00328849442088547,-0.14921488075522019,0.0032884944208837891],"mode":"text","text":["Csus","C7sus","Dbsus","Db7sus","Dsus","D7sus","Ebsus","Eb7sus","Esus","E7sus","Fsus","F7sus","Gbsus","Gb7sus","Gsus","G7sus","Absus","Ab7sus","Asus","A7sus","Bbsus","Bb7sus","Bsus","B7sus"],"type":"scatter3d","name":"sus","marker":{"color":"rgba(229,196,148,1)","line":{"color":"rgba(229,196,148,1)"}},"textfont":{"color":"rgba(229,196,148,1)"},"error_y":{"color":"rgba(229,196,148,1)"},"error_x":{"color":"rgba(229,196,148,1)"},"line":{"color":"rgba(229,196,148,1)"},"frame":null},{"x":[-0.27748894596514906,0.10834808111969139,-0.39084593144042612,-0.0814499136787004,-0.37271792436994988,-0.057068476058306707,0.38250873715620487,0.095688501213411284,0.45380236604093144,0.22409265102776035,0.47839263083880434,0.24420999832557497,-0.38503562112840756,-0.27408542692143634,-0.39516282313743722,-0.30668994350418233,-0.45588241820939968,-0.36591564875789861,0.28439252136203697,0.3790413838287236,0.23063972089546395,0.30710991329191267,0.31121887977723922,0.3895744966076346,-0.10754667516325851,-0.38243350804112858,-0.0043168916970113295,-0.22524002982548236,-0.083164493839448766,-0.30884717269959255,-0.098116215794167655,0.28335288261531189,-0.22316264514546763,0.083017262264152514,-0.1671737510615649,0.14536449828205938,0.27748894596514889,-0.10834808111969232,0.39084593144042579,0.081449913678699581,0.37271792436995094,0.057068476058306616,-0.38250873715620459,-0.095688501213411353,-0.4538023660409321,-0.22409265102776035,-0.47839263083880429,-0.24420999832557455,0.38503562112840722,0.27408542692143667,0.39516282313743778,0.30668994350418277,0.45588241820939956,0.36591564875789923,-0.28439252136203691,-0.37904138382872271,-0.230639720895464,-0.30710991329191262,-0.311218879777239,-0.3895744966076341,0.10754667516325826,0.38243350804112802,0.0043168916970110381,0.22524002982548241,0.08316449383944903,0.30884717269959289,0.098116215794167683,-0.28335288261531233,0.22316264514546819,-0.0830172622641525,0.16717375106156507,-0.145364498282059],"y":[-0.28439252136203486,-0.3790413838287241,-0.23063972089546378,-0.30710991329191262,-0.31121887977723917,-0.38957449660763371,0.10754667516325812,0.38243350804112874,0.0043168916970113417,0.22524002982548297,0.083164493839448683,0.30884717269959244,0.098116215794168182,-0.28335288261531216,0.2231626451454681,-0.083017262264152569,0.16717375106156546,-0.14536449828205944,-0.27748894596514917,0.10834808111969238,-0.3908459314404259,-0.08144991367869979,-0.37271792436995127,-0.057068476058306367,0.3825087371562052,0.095688501213411062,0.45380236604093199,0.2240926510277601,0.47839263083880457,0.24420999832557422,-0.3850356211284075,-0.2740854269214365,-0.39516282313743711,-0.30668994350418272,-0.45588241820939984,-0.36591564875789917,0.28439252136203741,0.37904138382872321,0.2306397208954642,0.30710991329191284,0.3112188797772395,0.38957449660763399,-0.10754667516325857,-0.38243350804112858,-0.0043168916970116131,-0.22524002982548261,-0.083164493839448864,-0.30884717269959272,-0.098116215794167794,0.28335288261531211,-0.22316264514546791,0.083017262264152292,-0.16717375106156498,0.14536449828205955,0.27748894596514934,-0.10834808111969196,0.39084593144042645,0.081449913678700372,0.37271792436995099,0.057068476058306471,-0.38250873715620509,-0.095688501213411339,-0.45380236604093238,-0.22409265102776024,-0.47839263083880457,-0.24420999832557469,0.38503562112840761,0.27408542692143645,0.39516282313743795,0.30668994350418316,0.45588241820940023,0.36591564875789934],"z":[-0.14222073439920491,0.14013797480510698,0.0060266446147942453,0.23126791479291442,-0.23823988303501742,-0.0044122060977982124,0.14222073439921457,-0.14013797480510332,-0.0060266446147872951,-0.23126791479291187,0.23823988303502286,0.0044122060977991899,-0.14222073439921509,0.14013797480510984,0.0060266446147904332,0.23126791479292094,-0.2382398830350245,-0.0044122060977948427,0.14222073439920702,-0.14013797480511986,-0.0060266446147987304,-0.23126791479293077,0.2382398830350225,0.0044122060977915423,-0.14222073439919866,0.14013797480512094,0.0060266446148049138,0.23126791479293066,-0.23823988303501828,-0.0044122060977934054,0.14222073439919952,-0.14013797480511128,-0.0060266446148008945,-0.23126791479291997,0.23823988303501673,0.0044122060977991838,-0.14222073439920668,0.14013797480510509,0.0060266446147916085,0.23126791479291106,-0.23823988303501845,-0.0044122060978000147,0.14222073439921348,-0.14013797480510548,-0.00602664461478708,-0.23126791479291275,0.238239883035022,0.0044122060977971368,-0.14222073439921293,0.14013797480511131,0.0060266446147923215,0.23126791479292208,-0.23823988303502369,-0.0044122060977946648,0.14222073439920807,-0.14013797480511772,-0.0060266446147984815,-0.23126791479292955,0.23823988303502358,0.0044122060977935269,-0.14222073439920127,0.14013797480511947,0.0060266446148024211,0.2312679147929293,-0.23823988303501947,-0.0044122060977935338,0.1422207343991983,-0.14013797480511381,-0.0060266446148005423,-0.23126791479292069,0.23823988303501642,0.0044122060977980536],"mode":"text","text":["C major triad","C minor triad","C6","Cm6","C (add 9)","Cm (add 9)","Db major triad","Db minor triad","Db6","Dbm6","Db (add 9)","Dbm (add 9)","D major triad","D minor triad","D6","Dm6","D (add 9)","Dm (add 9)","Eb major triad","Eb minor triad","Eb6","Ebm6","Eb (add 9)","Ebm (add 9)","E major triad","E minor triad","E6","Em6","E (add 9)","Em (add 9)","F major triad","F minor triad","F6","Fm6","F (add 9)","Fm (add 9)","Gb major triad","Gb minor triad","Gb6","Gbm6","Gb (add 9)","Gbm (add 9)","G major triad","G minor triad","G6","Gm6","G (add 9)","Gm (add 9)","Ab major triad","Ab minor triad","Ab6","Abm6","Ab (add 9)","Abm (add 9)","A major triad","A minor triad","A6","Am6","A (add 9)","Am (add 9)","Bb major triad","Bb minor triad","Bb6","Bbm6","Bb (add 9)","Bbm (add 9)","B major triad","B minor triad","B6","Bm6","B (add 9)","Bm (add 9)"],"type":"scatter3d","name":"triads","marker":{"color":"rgba(179,179,179,1)","line":{"color":"rgba(179,179,179,1)"}},"textfont":{"color":"rgba(179,179,179,1)"},"error_y":{"color":"rgba(179,179,179,1)"},"error_x":{"color":"rgba(179,179,179,1)"},"line":{"color":"rgba(179,179,179,1)"},"frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
<bslib-tooltip placement="auto" bsoptions="[]" data-require-bs-version="5" data-require-bs-caller="tooltip()">
<template>Expand</template>
<span class="bslib-full-screen-enter badge rounded-pill"></span>
</bslib-tooltip>
<script data-bslib-card-init="">bslib.Card.initializeAllCards();</script>
</div>
</div>
</div>
<p>I took out a bunch of chords so this was easier to look at. The plotly graph should go full screen and has some controls for spinning the sphere around and zooming in etc. If you click the names in the legend you can hide or show the corresponding chords, which can make it easier to see how things shake out.</p>
<p>In terms of the circle of fifths, the new z dimension puts 6 of them up top, and 6 of them down below. Within the X-Y plane, there are two alternating circles of fifths (CDEGbAbBb, and FGABDbEb).</p>
<p>Neat to poke around here.</p>


</section>

 ]]></description>
  <category>chord similarity</category>
  <category>datavis</category>
  <category>circle of fifths</category>
  <category>music theory</category>
  <category>rstats</category>
  <guid>https://homophony.quest/blog/31_1_30_24_sphere/</guid>
  <pubDate>Tue, 30 Jan 2024 05:00:00 GMT</pubDate>
  <media:content url="https://homophony.quest/blog/31_1_30_24_sphere/cover.jpg" medium="image" type="image/jpeg"/>
</item>
</channel>
</rss>
